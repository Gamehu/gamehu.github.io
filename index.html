<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/IMG_4038-32.jpeg"><link rel="icon" type="image/png" sizes="16x16" href="/images/IMG_4038.jpeg"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.gamehu.run","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.12.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"><meta property="og:type" content="website"><meta property="og:title" content="正儿八经 - 资深Java&#x2F;React工程师"><meta property="og:url" content="https://www.gamehu.run/index.html"><meta property="og:site_name" content="正儿八经 - 资深Java&#x2F;React工程师"><meta property="og:description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="Gamehu"><meta property="article:tag" content="Java开发, React工程师, 全栈开发, 求职, 软件工程师"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.gamehu.run/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>正儿八经 - 资深Java/React工程师</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">正儿八经 - 资深Java/React工程师</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">浪起来？技术博客与求职信息</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Gamehu" src="/images/IMG_4038.jpeg"><p class="site-author-name" itemprop="name">Gamehu</p><div class="site-description" itemprop="description">10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">183</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">110</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/gamehu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gamehu" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:gamehu520@gmail.com" title="E-Mail → mailto:gamehu520@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/gamehu/gamehu.github.io" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2025/02/22/%E5%B7%A5%E4%BD%9C/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2025/02/22/%E5%B7%A5%E4%BD%9C/" class="post-title-link" itemprop="url">Java开发工程师、全栈开发工程师</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-02-22 19:31:46" itemprop="dateCreated datePublished" datetime="2025-02-22T19:31:46+08:00">2025-02-22</time></span></div></div></header><div class="post-body" itemprop="articleBody"><h3 id="Java开发工程师、全栈开发工程师"><a href="#Java开发工程师、全栈开发工程师" class="headerlink" title="Java开发工程师、全栈开发工程师"></a>Java开发工程师、全栈开发工程师</h3><p>亲爱的招聘团队：</p><p>如果软件工程师是一道菜，那我就是那种经过12年慢火熬制的老汤底——看起来平淡无奇，但一尝就知道功夫在里头。</p><p>我的技术栈就像一个资深玩家的技能树：主技能点满了Java和React，副技能解锁了Vue、Docker、Python和Go等。在我的职业旅程中，我善于将复杂问题分解为简单模块，轻松应对各种技术挑战。但我最厉害的外挂其实是曾经当过产品助理——这让我不仅能听懂产品经理说的”简单调整”背后隐藏的36个子需求，还能在技术与业务之间自如翻译，堪称”产品语言通”。</p><p>在我的12年职业生涯中，我从”这bug在本地没问题啊”进化到了”这需求有啥实际意义”再到”好的，我来搞定！”。带团队的经历让我明白，比起Debug代码，Debug人际关系才是真正的高难度挑战。所幸，我在这两方面都交出了不错的成绩单。</p><p>相信我的技术能力、产品思维和团队协作经验能为您的团队带来实质性的贡献。代码之外，我能够搭建开发者与产品、业务之间的桥梁，确保我们不只是在开发功能，而是在创造价值。我们一定能擦出技术的火花——毕竟，一个能理解产品、带过团队、写了12年代码还没秃顶的工程师，不是每天都能遇到的。</p><p>代码问候，<br>[软件开发特种兵]</p><p>联系方式：<br>电话：[18515068121]<br>邮箱：[<a href="mailto:&#x67;&#x61;&#109;&#x65;&#x68;&#x75;&#64;&#121;&#x65;&#x61;&#104;&#x2e;&#x6e;&#101;&#116;">&#x67;&#x61;&#109;&#x65;&#x68;&#x75;&#64;&#121;&#x65;&#x61;&#104;&#x2e;&#x6e;&#101;&#116;</a>]<br>Wechat：[GamehuDB]</p><p>P.S. 我的GitHub贡献图可能不够绿，但我的生产环境代码从不让服务器变红。</p><h3 id="Java-Development-Engineer-x2F-Full-Stack-Development-Engineer"><a href="#Java-Development-Engineer-x2F-Full-Stack-Development-Engineer" class="headerlink" title="Java Development Engineer&#x2F;Full Stack Development Engineer"></a>Java Development Engineer&#x2F;Full Stack Development Engineer</h3><p>Dear Hiring Team:</p><p>If software engineers were dishes, I’d be that slow-simmered stock that’s been cooking for 12 years — looking unassuming, but one taste reveals the expertise within.</p><p>My tech stack resembles a veteran player’s skill tree: maxed-out primary skills in Java and React, with unlocked secondary abilities in Vue, Docker, Python, Go, and more. Throughout my professional journey, I’ve honed the ability to break complex problems into simple modules, easily tackling various technical challenges. But my most powerful perk comes from my experience as a product assistant — I can decode the 36 hidden sub-requirements behind a product manager’s “simple adjustment” and fluently translate between technical and business languages, making me a true “product whisperer.”</p><p>During my 12-year career, I’ve evolved from “but the bug doesn’t appear on my local machine” to “what’s the actual purpose of this requirement” to “I’ll handle it!” My team leadership experience taught me that debugging human relationships is far more challenging than debugging code. Fortunately, I’ve managed to achieve good results in both areas.</p><p>I believe my technical abilities, product mindset, and team collaboration experience will bring substantial value to your team. Beyond coding, I can build bridges between developers, product teams, and business units, ensuring we’re not just developing features but creating value. We’ll definitely create technical sparks together — after all, an engineer who understands products, has led teams, and has written code for 12 years without going bald isn’t someone you meet every day.</p><p>Code regards,<br>[Software Development Special Forces]</p><p>Contact Information:<br>twitter：[Gamehu520]<br>email：[<a href="mailto:&#x67;&#97;&#x6d;&#x65;&#104;&#117;&#64;&#121;&#x65;&#97;&#104;&#x2e;&#110;&#101;&#x74;">&#x67;&#97;&#x6d;&#x65;&#104;&#117;&#64;&#121;&#x65;&#97;&#104;&#x2e;&#110;&#101;&#x74;</a>]<br>Wechat：[GamehuDB]</p><p>P.S. My GitHub contribution graph might not be very green, but my production code never turns servers red.</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/12/29/resume/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/12/29/resume/" class="post-title-link" itemprop="url">简历模板</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-12-29 22:19:00" itemprop="dateCreated datePublished" datetime="2024-12-29T22:19:00+08:00">2024-12-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E4%B8%AA%E4%BA%BA/" itemprop="url" rel="index"><span itemprop="name">个人</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第N篇</span></div><div class="article-quote">离职前一天，想想简历咋写，弄个排版出来，后续好造着整理下简历。纯属个人意见。我先自己试试，不好用再改。</div><h2 id="我的观点"><a href="#我的观点" class="headerlink" title="我的观点"></a>我的观点</h2><p>我觉得简历的本质是为了筛选而不是为了深入了解你。所以我认为简历：</p><ol><li>首先得清爽。</li><li>然后得简明扼要。</li></ol><p>不用写太多同时又能体现关键信息，就跟咱们做程序一样，设计时重点之一就是数据得便于各场景使用，便于使用很大的一个方面就是数据能各种过滤和组合，通常是现有简明的入口，如果要了解细节就得下钻，可能是一层或多层才能看透数据。那简历就像入口，如果对方有兴趣才会下钻，所以不应该想着一个简历就把自己交代的底裤都没有，一方面是内容太多不容易抓到重点，另一方面是太细了搞得人都没欲望深入探讨，咋约你面试呢？</p><p>所以简历得像咱们对待产品需求一样，你得解决需求场景同时兼顾一些扩展性。抽象出来一个模板适配通用场景，然后可根据具体特殊场景，再保证真实的前提下做一些微调，对其JD中的要求。</p><hr><h1 id="抽象了一个通用模板如下："><a href="#抽象了一个通用模板如下：" class="headerlink" title="抽象了一个通用模板如下："></a><span style="color:red">抽象了一个通用模板如下：</span></h1><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><ul><li>求职意向：技术负责人&#x2F;技术专家</li><li>工作年限：8年+</li><li>学历：xx</li><li>电话：xx</li><li>期望薪资：xx</li></ul><h2 id="专业技能"><a href="#专业技能" class="headerlink" title="专业技能"></a>专业技能</h2><h3 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h3><ul><li>后端：Java、Spring Boot、Spring Cloud、MySQL、Redis、消息队列</li><li>前端：React、TypeScript、Ant Design、Redux、Webpack</li><li>DevOps：Docker、Jenkins、Git、Jira</li><li>架构：微服务架构、前后端分离、分布式系统设计</li></ul><h3 id="管理能力"><a href="#管理能力" class="headerlink" title="管理能力"></a>管理能力</h3><ul><li>团队管理：带领3-6人团队，完成项目全周期开发</li><li>技术规划：制定技术方案，把控技术方向，推动技术创新</li><li>敏捷实践：推行敏捷开发，提升团队效能</li><li>人才培养：建立技术培训体系，提升团队技术能力</li></ul><h2 id="工作经历"><a href="#工作经历" class="headerlink" title="工作经历"></a>工作经历</h2><h3 id="XX公司（2021-至今）"><a href="#XX公司（2021-至今）" class="headerlink" title="XX公司（2021-至今）"></a>XX公司（2021-至今）</h3><p>职位：技术负责人</p><p>负责工作：</p><ol><li><p>带领5-6人团队完成大型LLM应用平台开发，实现从0到1</p><ul><li>设计并实现基于微服务架构的系统框架</li><li>优化系统性能，提升用户体验</li><li>建立代码规范和技术文档体系</li><li>系统月活用户达到10w+，支持高并发访问</li></ul></li><li><p>技术架构升级与优化</p><ul><li>推动系统微服务化改造，提升系统可扩展性</li><li>实现核心模块性能优化，接口响应时间提升50%</li><li>建立监控告警体系，提高系统稳定性</li></ul></li></ol><h3 id="XX公司（2019-2021）"><a href="#XX公司（2019-2021）" class="headerlink" title="XX公司（2019-2021）"></a>XX公司（2019-2021）</h3><p>职位：Web前端负责人</p><p>负责工作：</p><ol><li><p>带领3-4人前端团队完成企业级SaaS平台开发</p><ul><li>基于React技术栈搭建前端框架</li><li>实现组件库设计与开发</li><li>推动前端工程化建设</li><li>平台服务企业客户100+</li></ul></li><li><p>技术改进与创新</p><ul><li>建立前端性能监控体系</li><li>推动前端自动化测试实践</li><li>优化构建流程，部署时间缩短60%<br>…</li></ul></li></ol><h2 id="项目经验"><a href="#项目经验" class="headerlink" title="项目经验"></a>项目经验</h2><h3 id="xx平台（2022-2023）"><a href="#xx平台（2022-2023）" class="headerlink" title="xx平台（2022-2023）"></a>xx平台（2022-2023）</h3><ul><li>项目规模：5-6人团队，服务10w+用户</li><li>技术架构：Spring Cloud + React + MySQL + Redis</li><li>主要职责：<ul><li>负责整体技术方案设计</li><li>核心功能开发与性能优化</li><li>带领团队完成开发任务</li></ul></li><li>项目成就：<ul><li>系统支持高并发访问，峰值QPS 5000+</li><li>用户响应时间&lt;500ms</li><li>系统可用性达99.9%</li></ul></li></ul><h3 id="xx企业级SaaS平台（2019-2021）"><a href="#xx企业级SaaS平台（2019-2021）" class="headerlink" title="xx企业级SaaS平台（2019-2021）"></a>xx企业级SaaS平台（2019-2021）</h3><ul><li>项目规模：前端3-4人团队</li><li>技术架构：React + TypeScript + Ant Design</li><li>主要职责：<ul><li>前端架构设计与实现</li><li>团队管理与技术指导</li><li>核心功能开发</li></ul></li><li>项目成就：<ul><li>平台月活用户5w+</li><li>前端性能提升40%</li><li>客户满意度95%+</li></ul></li></ul><h2 id="教育背景"><a href="#教育背景" class="headerlink" title="教育背景"></a>教育背景</h2><ul><li>XX大学 计算机科学与技术 本科</li></ul><h2 id="个人评价"><a href="#个人评价" class="headerlink" title="个人评价"></a>个人评价</h2><ul><li>扎实的技术功底，丰富的项目经验</li><li>优秀的团队管理能力和沟通协调能力</li><li>具备较强的技术视野和架构设计能力</li><li>持续学习，保持对新技术的敏感度</li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/10/22/%E5%88%86%E8%A1%A8%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/10/22/%E5%88%86%E8%A1%A8%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/" class="post-title-link" itemprop="url">分表数据查询</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-10-22 19:32:09" itemprop="dateCreated datePublished" datetime="2024-10-22T19:32:09+08:00">2024-10-22</time></span></div></div></header><div class="post-body" itemprop="articleBody"><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第十篇</span></div><div class="article-quote">离职系列，想想这几年在公司的成长，在这做个记录。这篇是关于维护的一个旧功能“全部告警跟踪”。</div><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>每个租户有自己的告警数据，少则几千多则几十万条数据，云平台提供了一个功能叫“全部告警跟踪”，该功能顾名思义，会展示所有租户的所有告警信息(刷新那一刻是实时的)，还能支持过滤、搜索等操作，这功能据说上线没多久就有问题，比如点分页时不时会出现超时。但是因为这功能用的人非常少，且只有管理员才有权限，也就一直放着。<br>但是新版需求要求解决这个问题，因为现在是我维护这个功能，所以需要我先出个技术方案。</p><h2 id="解法设计输出模板"><a href="#解法设计输出模板" class="headerlink" title="解法设计输出模板"></a>解法设计输出模板</h2><ol><li><p>解法设计的模板很多，但是我感觉稍微有点重，当前产品的节奏，没有那么多的时间和人力给我做那么详细的解法设计，所以简单梳理了一个简化版的解法设计，并与干系人达成了一致。</p></li><li><p>模板如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1. 引言</span><br><span class="line">  - 背景说明</span><br><span class="line">  - 问题陈述(现状、目标)</span><br><span class="line">  - 关键术语</span><br><span class="line">  - 参考资料</span><br><span class="line"></span><br><span class="line">2. 需求分析</span><br><span class="line">  - 核心诉求/期望交付的价值</span><br><span class="line">  - 非功要求</span><br><span class="line">3. 约束条件</span><br><span class="line">  - 依赖项</span><br><span class="line">  - 假设项</span><br><span class="line"></span><br><span class="line">4. 方案设计</span><br><span class="line">  - 可选方案对比(2-3个)</span><br><span class="line">    * 方案描述</span><br><span class="line">    * 优缺点分析</span><br><span class="line">    * 非功表现</span><br><span class="line">  - 推荐方案详细说明</span><br><span class="line">    * 架构设计</span><br><span class="line">    * 核心流程</span><br><span class="line">    * 关键设计点、算法伪代码（如果有必要）</span><br><span class="line">  </span><br><span class="line">5. 实施评估(因为团队自己做实施，所以加上这一章)</span><br><span class="line">  - 影响范围</span><br><span class="line">  - 实施成本</span><br><span class="line">  - 后续影响</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>要分清楚解法设计和详细设计的核心区别：</p><ol><li>解法设计：回答”用什么方案解决问题”<ul><li>关注整体思路</li><li>多个方案对比选择</li><li>架构层面决策</li></ul></li><li>详细设计：回答”如何具体实现这个方案”<ul><li>已选定方案的具体技术实现细节</li><li>编码层面设计</li><li>…</li></ul></li></ol></li></ol><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><p>在这儿我就不原方不动的把整个解法贴出来了，只捡几个重点说。</p><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p>一定要记住，虽然咱们是干技术的，但是做解法的时候，一定先不要直接从技术的角度思考，先从业务的角度，还原业务场景，以及可能的演进需求，做到扩展性。</p><ol><li>年少不懂事的时候，干过一段时间的产品助理，当时就学会做需求分析的几把斧：<blockquote><p>tips:</p><ol><li>搞清楚买单的人和使用的人谁？分别想解决什么问题，特别是买单的人容易被忽视。（使用方再满意，买单的人不满意也是白搭）</li><li>维护好与需求调研对象的关系（人情世故）</li><li>5W1H方法做需求分析和挖掘（找出底层需求，避免浮于表面文字）</li><li>KANO方法对需求分级（找出痛点先解决，其它的都是锦上添花）</li></ol></blockquote></li></ol><p>这儿的原始需求是管理员能对所有租户的告警跟踪查看，关注其下团队成员所负责的租户的处理情况，对工作进度有了解，同时可以随时查看核心客户的数据。<br>这样几句简单的话，应用5W1H+KANO拆解下：</p><ol><li><p>5W1H分析：</p><ol><li><p>WHO（谁）</p><ul><li>主体：管理员</li><li>关注对象：团队成员、租户</li></ul></li><li><p>WHAT（什么）</p><ul><li>查看所有租户的告警跟踪情况</li><li>了解团队成员的工作进度</li><li>查看核心客户数据</li></ul></li><li><p>WHEN（什么时候）</p><ul><li>随时（需要实时或准实时的数据）</li><li>告警发生后的跟踪过程中</li></ul></li><li><p>WHERE（在哪里）</p><ul><li>系统内</li></ul></li><li><p>WHY（为什么），更深入可以加入5Why方法，探寻源需求。</p><ul><li>监督团队工作情况</li><li>及时了解核心客户状况</li><li>确保告警得到及时处理</li></ul></li></ol></li><li><p>HOW（怎么做）</p><ul><li>提供告警跟踪查看、筛选功能</li><li>展示团队成员负责的租户处理进度</li><li>支持核心客户数据快速查看</li></ul></li><li><p>KANO模型分析：</p><ol><li><p>基本型需求（Must-be）：</p><ul><li>查看所有租户的告警记录</li><li>查看告警处理状态</li></ul></li><li><p>期望型需求（Performance）：</p><ul><li>团队成员工作进度追踪</li><li>核心客户数据查看</li></ul></li><li><p>兴奋型需求（Delighter）：</p><ul><li>数据分析和统计</li></ul></li></ol></li></ol><p><strong>这里能得到几个关键信息：</strong></p><ol><li>依然需要在活的实时的数据（需求已经明确）</li><li>需要搜索、分页、筛选（大数据量的场景）</li><li>后续很有可能需要统计数据（要考虑数据聚合）</li><li>非功<ol><li>1000+租户，每个租户50w的告警，10s内刷出数据。</li><li>经费有限，且重新申请流程慢，额度小。</li></ol></li></ol><h4 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h4><ol><li>方案1：ShardingSphere 自身实现。<br>广播表是ShardingSphere中的一个概念，指的是在所有分片中存在的表，每个分片都有完整的副本。当更新广播表时，所有分片都会同步更新。通常用于数据量不大且需要频繁关联查询的表，比如字典表。<ol><li>优点：简单，不用引入任何其他组件。</li><li>缺点：<ol><li>数据量太大，无法在每个分片都复制全量数据。</li></ol></li></ol></li><li>方案2：ClickHouse(开源版)+Flink CDC<ol><li>优点：<ol><li>CK在已在多个产品运用，学习成本较低。</li><li>可以支持复杂的查询、聚合需求。</li><li>适合离线分析。</li><li>单表查询性能极强。</li></ol></li><li>缺点：<ol><li>不支持事务。</li><li>集群部署成本高（官方没有提供Helm Chart。且ClickHouse集群扩展不方便，很多手动处理，不适合弹性扩展，集成k8s较难）。</li><li>删除&#x2F;更新性能差，更适合批量追加。告警数据会经常变更，可能存在性能问题。</li><li>手动管理分片、分区、MergeTree等，维护成本较高。</li></ol></li></ol></li><li>方案3：Doris+Flink CDC<ol><li><p>优点：</p><ol><li>实时性高、支持高并发。</li><li>可以支持复杂的查询需求、聚合需求。</li><li>集群部署成本低（Doris，官方提供了Helm Chart，且适合弹性扩展，运维压力小）。</li><li>自动话程度高（分片、负载均衡、存储管理等）</li><li>SQL友好</li><li>存算分离</li></ol></li><li><p>缺点：</p><ol><li>引入Doris新组件，可能会增加采购成本。</li><li>复杂的模糊搜索可能无法实现。</li></ol></li></ol></li><li>方案4：ES+Flink CDC<ol><li><p>优点：</p><ol><li>近实时，可能有秒级延迟。</li><li>可以支持复杂的查询需求（特别是全文检索）。</li><li>集群部署成本低（官方有Helm Chart和Operator，且适合弹性扩展，可无缝集成k8s，运维压力小）</li></ol></li><li><p>缺点：</p><ol><li>不支持事务</li><li>引入ES新组件，可能会增加较大采购成本（ES需要较多内存和SSD磁盘）。</li><li>很多时候需要手动处理，比如分片分步、设计索引、索引优化、GC 调优等，维护成本较高。</li><li>使用DSL，不是标准 SQL，学习成本较高。</li></ol></li></ol></li></ol><h4 id="推荐方案2"><a href="#推荐方案2" class="headerlink" title="推荐方案2"></a>推荐方案2</h4><p>原因：</p><ol><li>在活告警数据量可控，暂不考虑扩展。</li><li>系统已接入了CK，最低成本（学习、部署、购买）。</li></ol><h5 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/2024/10/22/%E5%88%86%E8%A1%A8%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/5.jpg" alt="alt text"></p><h5 id="关键验证点"><a href="#关键验证点" class="headerlink" title="关键验证点"></a>关键验证点</h5><p>1、2验证点，由于前期已经做过验证，着重验证3、4就行，特别是更新和删除数据。</p><h5 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h5><p>按500个租户，每个租户5000在活告警，没问题，因为主要是验证可行性，没有那么严格的压测，图啥的当时就没留了。这块详设的时候会更具体严格一些。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/" class="post-title-link" itemprop="url">遇见连接超时</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-09-17 19:51:00" itemprop="dateCreated datePublished" datetime="2024-09-17T19:51:00+08:00">2024-09-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">工作</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第九篇</span></div><div class="article-quote">离职系列，想想这几年在公司的成长，在这做个记录。这篇是遇到的一个比较典型的线上问题。</div><h3 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h3><p>写了一个每天执行两次的定时任务，该任务会分批对线上所有几百个租户生成《平安通告》，上线1个多月后突然手机收到告警，某几个用户生成失败。</p><pre><code>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">2024-10-23 17:00:10,125 [safetyNoticeGenerator8] ERROR [com.alibaba.druid.pool.DruidDataSource] DruidDataSource.java:1988 - &#123;conn-110021&#125; discard</span><br><span class="line"> org.postgresql.util.PSQLException: An I/O error occurred while sending to the backend.</span><br><span class="line">   at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:395)</span><br><span class="line">   at org.postgresql.jdbc.PgStatement.executeInternal(PgStatement.java:498)</span><br><span class="line">   at org.postgresql.jdbc.PgStatement.execute(PgStatement.java:415)</span><br><span class="line">   at org.postgresql.jdbc.PgPreparedStatement.executeWithFlags(PgPreparedStatement.java:190)</span><br><span class="line">   at org.postgresql.jdbc.PgPreparedStatement.execute(PgPreparedStatement.java:177)</span><br><span class="line">   at com.alibaba.druid.pool.DruidPooledPreparedStatement.execute(DruidPooledPreparedStatement.java:483)</span><br><span class="line">   at org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement$2.executeSQL(ShardingSpherePreparedStatement.java:439)</span><br><span class="line">   at org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement$2.executeSQL(ShardingSpherePreparedStatement.java:435)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.sql.execute.engine.driver.jdbc.JDBCExecutorCallback.execute(JDBCExecutorCallback.java:95)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.sql.execute.engine.driver.jdbc.JDBCExecutorCallback.execute(JDBCExecutorCallback.java:75)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.kernel.ExecutorEngine.syncExecute(ExecutorEngine.java:135)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.kernel.ExecutorEngine.serialExecute(ExecutorEngine.java:121)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.kernel.ExecutorEngine.execute(ExecutorEngine.java:115)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.sql.execute.engine.driver.jdbc.JDBCExecutor.execute(JDBCExecutor.java:65)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.sql.execute.engine.driver.jdbc.JDBCExecutor.execute(JDBCExecutor.java:49)</span><br><span class="line">   at org.apache.shardingsphere.driver.executor.DriverJDBCExecutor.doExecute(DriverJDBCExecutor.java:156)</span><br><span class="line">   at org.apache.shardingsphere.driver.executor.DriverJDBCExecutor.execute(DriverJDBCExecutor.java:145)</span><br><span class="line">   at org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement.execute(ShardingSpherePreparedStatement.java:402)</span><br><span class="line">   at com.zaxxer.hikari.pool.ProxyPreparedStatement.execute(ProxyPreparedStatement.java:44)</span><br><span class="line">   at com.zaxxer.hikari.pool.HikariProxyPreparedStatement.execute(HikariProxyPreparedStatement.java)</span><br><span class="line">   at org.apache.ibatis.executor.statement.PreparedStatementHandler.query(PreparedStatementHandler.java:65)</span><br><span class="line">   at org.apache.ibatis.executor.statement.RoutingStatementHandler.query(RoutingStatementHandler.java:80)</span><br><span class="line">   at jdk.internal.reflect.GeneratedMethodAccessor49.invoke(Unknown Source)</span><br><span class="line">   at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">   at java.base/java.lang.reflect.Method.invoke(Method.java:568)</span><br><span class="line">   at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:61)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy207.query(Unknown Source)</span><br><span class="line">   at org.apache.ibatis.executor.SimpleExecutor.doQuery(SimpleExecutor.java:65)</span><br><span class="line">   at org.apache.ibatis.executor.BaseExecutor.queryFromDatabase(BaseExecutor.java:333)</span><br><span class="line">   at org.apache.ibatis.executor.BaseExecutor.query(BaseExecutor.java:158)</span><br><span class="line">   at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:110)</span><br><span class="line">   at com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor.intercept(MybatisPlusInterceptor.java:81)</span><br><span class="line">   at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:59)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy206.query(Unknown Source)</span><br><span class="line">   at jdk.internal.reflect.GeneratedMethodAccessor44.invoke(Unknown Source)</span><br><span class="line">   at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">   at java.base/java.lang.reflect.Method.invoke(Method.java:568)</span><br><span class="line">   at org.apache.ibatis.plugin.Invocation.proceed(Invocation.java:49)</span><br><span class="line">   at com.github.yulichang.interceptor.MPJInterceptor.intercept(MPJInterceptor.java:76)</span><br><span class="line">   at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:59)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy206.query(Unknown Source)</span><br><span class="line">   at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:154)</span><br><span class="line">   at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:147)</span><br><span class="line">   at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:142)</span><br><span class="line">   at jdk.internal.reflect.GeneratedMethodAccessor109.invoke(Unknown Source)</span><br><span class="line">   at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">   at java.base/java.lang.reflect.Method.invoke(Method.java:568)</span><br><span class="line">   at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:425)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy189.selectList(Unknown Source)</span><br><span class="line">   at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:224)</span><br><span class="line">   at com.baomidou.mybatisplus.core.override.MybatisMapperMethod.executeForMany(MybatisMapperMethod.java:166)</span><br><span class="line">   at com.baomidou.mybatisplus.core.override.MybatisMapperMethod.execute(MybatisMapperMethod.java:77)</span><br><span class="line">   at com.baomidou.mybatisplus.core.override.MybatisMapperProxy$PlainMethodInvoker.invoke(MybatisMapperProxy.java:152)</span><br><span class="line">   at com.baomidou.mybatisplus.core.override.MybatisMapperProxy.invoke(MybatisMapperProxy.java:89)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy197.findDistinctCiIdsByIdentityId(Unknown Source)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl.addAlertData(xxServiceImpl.java:612)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl.lambda$setJsonField$5(xxServiceImpl.java:368)</span><br><span class="line">   at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl.setJsonField(xxServiceImpl.java:346)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl.batchCreate(xxServiceImpl.java:201)</span><br><span class="line">   at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">   at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)</span><br><span class="line">   at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">   at java.base/java.lang.reflect.Method.invoke(Method.java:568)</span><br><span class="line">   at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:343)</span><br><span class="line">   at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)</span><br><span class="line">   at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)</span><br><span class="line">   at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:751)</span><br><span class="line">   at org.springframework.transaction.interceptor.TransactionInterceptor$1.proceedWithInvocation(TransactionInterceptor.java:123)</span><br><span class="line">   at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:391)</span><br><span class="line">   at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)</span><br><span class="line">   at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)</span><br><span class="line">   at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:751)</span><br><span class="line">   at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:703)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl$$SpringCGLIB$$0.batchCreate(&lt;generated&gt;)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.SafetyNoticeScheduleServiceImpl.processBatch(SafetyNoticeScheduleServiceImpl.java:194)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.SafetyNoticeScheduleServiceImpl.lambda$processBatchesInThreadPool$0(SafetyNoticeScheduleServiceImpl.java:112)</span><br><span class="line">   at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)</span><br><span class="line">   at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)</span><br><span class="line">   at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)</span><br><span class="line">   at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)</span><br><span class="line">   at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)</span><br><span class="line">   at java.base/java.lang.Thread.run(Thread.java:840)</span><br><span class="line"> Caused by: java.net.SocketTimeoutException: Read timed out</span><br><span class="line">   at java.base/sun.nio.ch.NioSocketImpl.timedRead(NioSocketImpl.java:288)</span><br><span class="line">   at java.base/sun.nio.ch.NioSocketImpl.implRead(NioSocketImpl.java:314)</span><br><span class="line">   at java.base/sun.nio.ch.NioSocketImpl.read(NioSocketImpl.java:355)</span><br><span class="line">   at java.base/sun.nio.ch.NioSocketImpl$1.read(NioSocketImpl.java:808)</span><br><span class="line">   at java.base/java.net.Socket$SocketInputStream.read(Socket.java:966)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketInputRecord.read(SSLSocketInputRecord.java:484)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketInputRecord.readHeader(SSLSocketInputRecord.java:478)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketInputRecord.bytesInCompletePacket(SSLSocketInputRecord.java:70)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketImpl.readApplicationRecord(SSLSocketImpl.java:1465)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketImpl$AppInputStream.read(SSLSocketImpl.java:1069)</span><br><span class="line">   at org.postgresql.core.VisibleBufferedInputStream.readMore(VisibleBufferedInputStream.java:161)</span><br><span class="line">   at org.postgresql.core.VisibleBufferedInputStream.ensureBytes(VisibleBufferedInputStream.java:128)</span><br><span class="line">   at org.postgresql.core.VisibleBufferedInputStream.ensureBytes(VisibleBufferedInputStream.java:113)</span><br><span class="line">   at org.postgresql.core.VisibleBufferedInputStream.read(VisibleBufferedInputStream.java:73)</span><br><span class="line">   at org.postgresql.core.PGStream.receiveChar(PGStream.java:465)</span><br><span class="line">   at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:2155)</span><br><span class="line">   at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:368)</span><br><span class="line">   ... 82 common frames omitted</span><br><span class="line"> org.springframework.jdbc.UncategorizedSQLException: </span><br><span class="line"> ### Error querying database.  Cause: java.sql.SQLException: Connection is closed</span><br><span class="line"> ### The error may exist in class path resource [mapper/TbxxHealthCheckResultMapper.xml]</span><br><span class="line"> ### The error may involve com.xxx.xxxcloud.manage.mapper.xx.TbxxHealthCheckResultMapper.selectExecuteLatest</span><br><span class="line"> ### The error occurred while executing a query</span><br><span class="line"> ### Cause: java.sql.SQLException: Connection is closed</span><br><span class="line"> ; uncategorized SQLException; SQL state [null]; error code [0]; Connection is closed</span><br><span class="line">   at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:93)</span><br><span class="line">   at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:439)</span><br><span class="line">   at java.base/java.lang.Thread.run(Thread.java:840)</span><br><span class="line"> Caused by: java.sql.SQLException: Connection is closed</span><br><span class="line">   at com.zaxxer.hikari.pool.ProxyConnection$ClosedConnection.lambda$getClosedConnection$0(ProxyConnection.java:502)</span><br><span class="line">   at jdk.proxy3/jdk.proxy3.$Proxy173.prepareStatement(Unknown Source)</span><br><span class="line">   at com.zaxxer.hikari.pool.ProxyConnection.prepareStatement(ProxyConnection.java:327)</span><br><span class="line">   at com.zaxxer.hikari.pool.HikariProxyConnection.prepareStatement(HikariProxyConnection.java)</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
</code></pre><p>从上面有几个关键信息梳理下异常调用链：</p><img src="/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/error.jpg"><p>得出几个重要信息：</p><ol><li>异常发生的业务代码是在批量处理”xx报告”时，查询告警处</li><li>ShardingSphere下的连接池hikari抛出了异常Connection is closed</li><li>Druid连接池也抛出了异常{conn-xxx} discard</li><li>底层SocketTimeoutException，表明是客户端等待数据库服务器的响应超时（初步判断为慢sql）</li></ol><p>所以我开始从以下几个方面排查：</p><ol><li>查业务代码的变更，为什么之前好好的跑了一个多月，突然出问题。</li><li>检查数据库连接参数设置</li><li>评估查询的数据量是否过大</li><li>看下HikariCP和Druid是否有啥联系以及为啥会有两个连接池？</li><li>查看数据库负载情况</li></ol><h3 id="处理过程"><a href="#处理过程" class="headerlink" title="处理过程"></a>处理过程</h3><h4 id="第一步：摸索"><a href="#第一步：摸索" class="headerlink" title="第一步：摸索"></a>第一步：摸索</h4><p>怀疑一切，切忌先入为主。</p><ol><li>想办法重现问题<ol><li>提前发通知，下午7点以后会操作线上系统。通常6点半以后几乎就没人用系统了。</li><li>因为设计该功能时，留了补偿手动，可手动重新触发报告生成。</li><li>反复重试了几次，问题未复现。</li></ol></li><li>查看业务代码变更。<ol><li>报错处业务代码owner是我，没做任何更改，所以变成重点关注addAlertData方法，也就是与告警相关（重点在数据量）</li><li>业务没变更但是加入了<strong>ShardingSphere</strong>（异常中也有这块的信息，先存疑）</li></ol></li><li>检查系统连接池参数<ol><li>druid，几乎都没有做定制，都是使用的默认值。<ol><li>使用默认值其实存在风险，应该根据业务调整一些参数，因为买的阿里的pg所以咨询了他们拿到了一份他们暴露的参数调优参考，后续可针对性修改）</li></ol></li><li>新增的ShardingSphere的HikariCP也是使用的默认值。（异常中也有这块的信息，先存疑）</li></ol></li><li>观察显示的数据库负载情况（阿里云的监控看板、pg的pg_stat_activity等视图、数据库日志等）<ol><li>从视图发现确实存在执行时间较长的几条sqlsql，虽然有些慢但是不足以触发异常。慢的原因初步判断为数据量过大（报错的租户行数都在50w左右）</li><li>记录下这个sql，拿去控制台执行，EXPLAIN ANALYZE该sql，发现Seq Scan除了时间较长以外还存在索引问题，几乎每次查询都要用到的“告警状态”字段之前没加索引。（可能是原因之一）</li><li>查看数据库日志如下，这表明数据库和客户端的连接中断确实是问题的根源，可能是因为网络问题、数据库负载过高、或者连接超时等因素导致的。<ol><li><img src="/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/sql.png"></li></ol></li></ol></li></ol><h4 id="第二步：验证"><a href="#第二步：验证" class="headerlink" title="第二步：验证"></a>第二步：验证</h4><p>验证怀疑的所有点，通常控制变量法进行验证。</p><p>因为暂时没有复现，不着急先按兵不动。</p><ol><li>前提是要有补偿方案，不能阻断线上使用，特别是这种核心业务。因为当时留了后门可以手动触发某个租户所以没问题。</li><li>虽然是线上故障同时也算严重bug，但是也不要着急，胡乱改一通，可能按下葫芦又起瓢，尽可能的找到根因，哪怕不能一次性修复。</li></ol><p>等待了两天发现同样的问题又发生了。</p><ol><li>但是这次发现了上一次遗漏的一个信息，报错的租户从日志看时间，异常都是在10s以后抛出的。（初步判断是SocketTimeout的超时时间，可能是10s）</li><li>拿到同样报错的sql去执行发现虽然跟之前没啥差别，问题还是那些问题，也没超过10s。（怀疑是因为报错时候执行了sql，触发了pg的缓存，所以再去查缓存生效，导致执行时间变短）</li></ol><p>验证第一个问题：</p><p>因为当前看存在有两个连接池，查HikariCP与Druid的源码：<br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// HikariCP只有connectionTimeout为30s</span><br><span class="line">static &#123;</span><br><span class="line">    CONNECTION_TIMEOUT = TimeUnit.SECONDS.toMillis(30L);</span><br><span class="line">    VALIDATION_TIMEOUT = TimeUnit.SECONDS.toMillis(5L);</span><br><span class="line">    SOFT_TIMEOUT_FLOOR = Long.getLong(&quot;com.zaxxer.hikari.timeoutMs.floor&quot;, 250L);</span><br><span class="line">    IDLE_TIMEOUT = TimeUnit.MINUTES.toMillis(10L);</span><br><span class="line">    MAX_LIFETIME = TimeUnit.MINUTES.toMillis(30L);</span><br><span class="line">    unitTest = false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// DruidDataSource初始化，socketTimeout是10s</span><br><span class="line">public void init() throws SQLException &#123;</span><br><span class="line">    if (!this.inited) &#123;</span><br><span class="line">        DruidDriver.getInstance();</span><br><span class="line">        ReentrantLock lock = this.lock;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            lock.lockInterruptibly();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            throw new SQLException(&quot;interrupt&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        boolean init = false;</span><br><span class="line">  </span><br><span class="line">      if (this.connectTimeout == 0) &#123;</span><br><span class="line">        this.connectTimeout = 10000;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (this.socketTimeout == 0) &#123;</span><br><span class="line">          this.socketTimeout = 10000;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p></p><p>先不管HikariCP，至少能确定Druid的10s超时确实存在，因为阿里云上我开起了pg的慢sql监控，根据时间刚好查到了确实存在一条告警sql查询执行时间为10s+。</p><ol><li>所以初步判断SocketTimeoutException是因为sql执行时间超过了连接池的默认超时。</li><li>去查了下该租户下告警的数据总数已经超过了50W，在活5000左右。</li></ol><h4 id="第三步：修复方案"><a href="#第三步：修复方案" class="headerlink" title="第三步：修复方案"></a>第三步：修复方案</h4><p>方案如下：</p><ol><li>加索引，对常用的字段“告警状态”添加索引。</li><li>对在活告警查询的地方分批</li><li>对在活主告警限制查询的条数而不是查所有。</li></ol><h4 id="第四步：方案执行"><a href="#第四步：方案执行" class="headerlink" title="第四步：方案执行"></a>第四步：方案执行</h4><ol><li><p>对所有配置分表的表，检查索引，添加必要的索引。</p><ol><li><pre><code>  -- ========================================
  -- 描述: 创建告警表的“status”字段索引
  -- 文件名: 001_create_alert_status_index.sql
  -- 作者: hht
  -- 创建日期: 2024-10-31
  -- ========================================

  DO $$
  DECLARE
      i INTEGER;
  BEGIN
      -- 遍历 tb_xx_alert_0 ~ tb_xx_alert_15
      FOR i IN 0..15 LOOP
          -- 动态生成 ALTER TABLE 语句，添加字段
          EXECUTE FORMAT(&#39;
              ALTER TABLE public.tb_xx_alert_%s 
              CREATE INDEX tb_xx_alert_%s_status_index ON tb_xx_alert_%s  (status);
          &#39;, i);
      END LOOP;
  END $$;
</code></pre></li></ol></li><li><p>告警分批且限制条数</p><ol><li><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;AlertVO&gt; findSubscribedAlerts(AlertSubscribedParam param) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    List&lt;List&lt;String&gt;&gt; parts = PartsListUtil.getParts(param.getSubscribedCiIds(), BATCH_SIZE);</span><br><span class="line">    List&lt;AlertVO&gt; all = new ArrayList&lt;&gt;();</span><br><span class="line">    for (List&lt;String&gt; part : parts) &#123;</span><br><span class="line">      // 分批查询</span><br><span class="line">      param.setSubscribedCiIds(part);</span><br><span class="line">      // 主告警不超过100条</span><br><span class="line">      Page&lt;AlertVO&gt; page = new Page&lt;&gt;(1, 100 - all.size());</span><br><span class="line">      IPage&lt;AlertVO&gt; result = tbXxAlertMapper.findSubscribedAlerts(page, param);</span><br><span class="line">      if (result.getTotal() == 0) &#123;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">      // 聚合告警的子告警数据补充</span><br><span class="line">      getAlertAggChildren(param.getIdentityId(), result.getRecords());</span><br><span class="line">      all.addAll(result.getRecords());</span><br><span class="line">      // 如果已经达到100，退出循环</span><br><span class="line">      if (all.size() == 100) &#123;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 最后统一按createTime降序排序</span><br><span class="line">    all.sort((a1, a2) -&gt; Long.compare(a2.getCreateTime(), a1.getCreateTime()));</span><br><span class="line">    return all;</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    String errorMessage =</span><br><span class="line">        String.format(&quot;查询关注告警失败: identityId=%s, deal=%s&quot;, param.getIdentityId(), param.isDeal());</span><br><span class="line">    log.error(errorMessage, param.getIdentityId(), e);</span><br><span class="line">    throw new SafetyNoticeException(errorMessage, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">       </span><br></pre></td></tr></table></figure></li></ol></li></ol><h4 id="第五步：监控效果"><a href="#第五步：监控效果" class="headerlink" title="第五步：监控效果"></a>第五步：监控效果</h4><ol><li>上线后，连续一周到点蹲守数据库负载看板以及pg的pg_stat_activity。<ol><li>之前的sql执行时间没有再超过2s</li><li>看板上慢sql也没有在发现</li><li>数据库日志也没有再出现异常</li></ol></li><li>EXPLAIN ANALYZE 对应sql，发现为Index Scan，索引生效。</li><li>业务功能正常。</li></ol><p>看上去目前超时的问题暂时解决，但是要想更彻底的解，还需要后续对遗留项逐个解决。</p><h3 id="遗留项-x2F-改进项"><a href="#遗留项-x2F-改进项" class="headerlink" title="遗留项&#x2F;改进项"></a>遗留项&#x2F;改进项</h3><ol><li>连接池的参数调优，虽然默认的看上去没啥问题，但是迟早肯定会出问题，记一个DFX。</li><li>多了一个HikariCP连接池，而且通过jconsole看了下，两个连接池都会初始化，这块是否有必要有两个连接池，这儿存在隐患，对ShardingSphere需要深入了解下，记一个DFX。</li><li>历史数据的清理，跟PO提出，需要加一个需求不仅仅是告警，可能还有其他数据。</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/08/18/%E5%89%8D%E7%BD%AE%E6%A3%80%E6%9F%A5%E8%84%9A%E6%9C%AC/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/08/18/%E5%89%8D%E7%BD%AE%E6%A3%80%E6%9F%A5%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">前置检查脚本</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-08-18 22:19:13" itemprop="dateCreated datePublished" datetime="2024-08-18T22:19:13+08:00">2024-08-18</time></span></div></div></header><div class="post-body" itemprop="articleBody"><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第八篇</span></div><div class="article-quote">离职系列，想想这几年在公司的成长，在这做个记录。</div><p>此篇是因为遇到了太多环境类问题，从LMT建立的数据统计，这类问题占比已经超过了我处理问题的60%左右，占所有现场问题的20%左右以上，所以抽了个时间把可以在前置检查中避免的问题都梳理出来，试着写了个脚本，并一次次到现场验证，最终有了以下版本。该脚本在产品没有出根解之前，直接交给了TAC，让其与一线一起前置处理，避免过多的流转到LMT。</p><h2 id="检查脚本，"><a href="#检查脚本，" class="headerlink" title="检查脚本，"></a>检查脚本，</h2><pre><code>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 环境前置检查脚本（用于提前感知问题，减少安装失败、升级失败等问题出现）</span><br><span class="line"># by hht</span><br><span class="line"># 上传后，chmod +x 授予执行权限，然后./pre_check.sh 直接执行</span><br><span class="line"></span><br><span class="line"># 输出错误到文件</span><br><span class="line">exec 2&gt;/tmp/pre_test_error.log</span><br><span class="line"># ANSI颜色代码</span><br><span class="line">GREEN=&#x27;\033[0;32m&#x27;</span><br><span class="line">RED=&#x27;\033[0;31m&#x27;</span><br><span class="line">NC=&#x27;\033[0m&#x27; # 恢复默认颜色</span><br><span class="line">YELLOW=&#x27;\033[0;33m&#x27;</span><br><span class="line">YELLOW_BG=&#x27;\033[43m&#x27;</span><br><span class="line">BLACK=&#x27;\033[30m&#x27; # 黑色字体</span><br><span class="line">none=&#x27;\e[0m&#x27;</span><br><span class="line">BLUE=&quot;\e[0;94m&quot;</span><br><span class="line">_red_bg() &#123; echo -e &quot;\e[41m$@$&#123;none&#125;&quot;; &#125;</span><br><span class="line">is_err=$(_red_bg 异常!)</span><br><span class="line"></span><br><span class="line">warn() &#123;</span><br><span class="line">      echo -e &quot;\n$&#123;YELLOW_BG&#125;$&#123;BLACK&#125;警告!$&#123;NC&#125; $@\n&quot;</span><br><span class="line">&#125;</span><br><span class="line">err() &#123;</span><br><span class="line">    echo -e &quot;\n$@ $is_err\n&quot; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 函数来检验IP地址的有效性</span><br><span class="line">is_valid_ip() &#123;</span><br><span class="line">  local ip=&quot;$1&quot;</span><br><span class="line">  local ip_regex=&quot;^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$&quot;</span><br><span class="line"></span><br><span class="line">  if [[ $ip =~ $ip_regex ]]; then</span><br><span class="line">    return 0</span><br><span class="line">  else</span><br><span class="line">    return 1</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 声明账号</span><br><span class="line">server1_user=&quot;root&quot;</span><br><span class="line">server2_user=&quot;root&quot;</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n$&#123;GREEN&#125;------------------------------------前置检查------------------------------------$&#123;NC&#125;&quot;</span><br><span class="line">echo</span><br><span class="line"># 输入服务器IP地址，进行校验</span><br><span class="line">while true; do</span><br><span class="line">  echo &quot;请输入master服务器的IP地址：&quot;</span><br><span class="line">  read server1_ip</span><br><span class="line"></span><br><span class="line">  if is_valid_ip &quot;$server1_ip&quot;; then</span><br><span class="line">    break</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无效的IP地址，请重新输入。&quot;</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">while true; do</span><br><span class="line">  echo &quot;请输入worker服务器的IP地址：&quot;</span><br><span class="line">  read server2_ip</span><br><span class="line">  if is_valid_ip &quot;$server2_ip&quot;; then</span><br><span class="line">    break</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无效的IP地址，请重新输入。&quot;</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"># 测试Ping</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;ping测试:$&#123;NC&#125;\n&quot;</span><br><span class="line">ping_check()&#123;</span><br><span class="line">  local server1_ip=$1</span><br><span class="line">  local server2_ip=$2</span><br><span class="line">  ping -c 3 $server1_ip &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    echo -e &quot;$server1_ip 可以Ping通。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    err &quot;$server1_ip 无法Ping通。&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  ping -c 3 $server2_ip &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    echo -e &quot;$server2_ip 可以Ping通。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    err &quot;$server2_ip 无法Ping通。&quot; &amp;&amp; exit 1</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ping_check $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># SSH测试</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;SSH测试:$&#123;NC&#125;\n&quot;</span><br><span class="line">ssh_check()&#123;</span><br><span class="line">  local server1_ip=$1</span><br><span class="line">  local server2_ip=$2</span><br><span class="line">  if sshpass timeout 10s ssh -o StrictHostKeyChecking=no root@$server1_ip echo &quot;SSH test&quot;  2&gt;/dev/null; then</span><br><span class="line">    echo -e &quot;Success: SSH from $server1_ip to $server2_ip connected.$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else </span><br><span class="line">    err &quot;SSH from $server1_ip to $server2_ip failed&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ssh_check $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># 时间一致性检查</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;时间一致性检查:$&#123;NC&#125;\n&quot;</span><br><span class="line">date_check()&#123;</span><br><span class="line">  local server1_ip=$1</span><br><span class="line">  local server2_ip=$2</span><br><span class="line">  # 时间一致性检查</span><br><span class="line">  server1_time=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$server1_ip date +%s)</span><br><span class="line">  server2_time=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$server2_ip date +%s)</span><br><span class="line"></span><br><span class="line">  if [ $server1_time -eq $server2_time ]; then</span><br><span class="line">    echo -e &quot;两台服务器的时间完全一致。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">  # 使用 date 命令将时间戳转换为日期和时间</span><br><span class="line">    formatted1_time=$(date -d &quot;@$server1_time&quot;)</span><br><span class="line">    formatted2_time=$(date -d &quot;@$server2_time&quot;)</span><br><span class="line">    err &quot;两台服务器的时间不一致。&quot;</span><br><span class="line">    echo -e &quot;$&#123;server1_ip&#125;时间为：$&#123;formatted1_time&#125;&quot;</span><br><span class="line">    echo -e &quot;$&#123;server2_ip&#125;时间为：$&#123;formatted2_time&#125;&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">date_check $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"></span><br><span class="line"># 添加检查防火墙是否开启</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;检查防火墙:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_firewall_status() &#123;</span><br><span class="line">  local server_ip=$1</span><br><span class="line"></span><br><span class="line">  # 使用 ssh 连接到服务器并查看 firewalld 服务的状态</span><br><span class="line">  firewall_status=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null &quot;root@$server_ip&quot; &quot;systemctl is-active firewalld&quot;)</span><br><span class="line">  </span><br><span class="line">  if [ &quot;$firewall_status&quot; = &quot;active&quot; ]; then</span><br><span class="line">    warn &quot;$server_ip 防火墙已开启。请根据http://172.17.160.32:18090/x/cYA0CQ检查端口&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$server_ip 防火墙未开启。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用这个函数并传入服务器 IP 和用户名</span><br><span class="line">check_firewall_status $server1_ip</span><br><span class="line">check_firewall_status $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"></span><br><span class="line"># DNS配置检查</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;DNS检查:$&#123;NC&#125;\n&quot;</span><br><span class="line">dns_check()&#123;</span><br><span class="line">  local server1_user=$1</span><br><span class="line">  local server2_user=$1</span><br><span class="line">  local server1_ip=$2</span><br><span class="line">  local server2_ip=$3</span><br><span class="line">  # DNS配置检查 - 验证是否一致</span><br><span class="line">  server1_dns=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server1_user@$server1_ip cat /etc/resolv.conf)</span><br><span class="line">  server2_dns=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server2_user@$server2_ip cat /etc/resolv.conf)</span><br><span class="line"></span><br><span class="line">  if [ &quot;$server1_dns&quot; == &quot;$server2_dns&quot; ]; then</span><br><span class="line">    echo -e &quot;两台服务器的DNS配置一致。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    warn  &quot;两台服务器的DNS配置不一致。请判断是否影响集群。&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # DNS配置检查 - 验证是否存在多行nameserver记录</span><br><span class="line">  server1_nameserver_count=$(echo &quot;$server1_dns&quot; | grep -c &#x27;^nameserver&#x27;)</span><br><span class="line">  server2_nameserver_count=$(echo &quot;$server2_dns&quot; | grep -c &#x27;^nameserver&#x27;)</span><br><span class="line"></span><br><span class="line">  if [ $server1_nameserver_count -eq 1 ] &amp;&amp; [ $server2_nameserver_count -eq 1 ]; then</span><br><span class="line">    echo -e &quot;两台服务器的DNS配置中只存在一行nameserver记录。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    if [ $server1_nameserver_count -ne 1 ]; then</span><br><span class="line">      warn  &quot;第一台服务器($server1_ip)的DNS配置存在多行nameserver记录。请判断是否影响集群。&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ $server2_nameserver_count -ne 1 ]; then</span><br><span class="line">      warn  &quot;第二台服务器($server2_ip)的DNS配置存在多行nameserver记录。请判断是否影响集群。&quot;</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dns_check $server1_user $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># 挂载检查</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;数据盘挂载检查:$&#123;NC&#125;\n&quot;</span><br><span class="line">mount_check()&#123;</span><br><span class="line">  local server1_user=$1</span><br><span class="line">  local server2_user=$1</span><br><span class="line">  local server1_ip=$2</span><br><span class="line">  local server2_ip=$3</span><br><span class="line">  server1_mount=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server1_user@$server1_ip mount | grep /opt/local-path-provisioner)</span><br><span class="line">  server2_mount=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server2_user@$server2_ip mount | grep /opt/local-path-provisioner)</span><br><span class="line"></span><br><span class="line">  if [ -n &quot;$server1_mount&quot; ] &amp;&amp; [ -n &quot;$server2_mount&quot; ]; then</span><br><span class="line">    echo -e &quot;两台服务器都正确挂载了/opt/local-path-provisioner目录。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">  #   echo -e &quot;两台服务器中有一台或两台未正确挂载/opt/local-path-provisioner目录。$&#123;RED&#125;异常$&#123;NC&#125;&quot;</span><br><span class="line">    if [ -z &quot;$server1_mount&quot; ]; then</span><br><span class="line">      err &quot;第一台服务器($server1_ip)未正确挂载/opt/local-path-provisioner目录。&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$server2_mount&quot; ]; then</span><br><span class="line">      err &quot;第二台服务器($server2_ip)未正确挂载/opt/local-path-provisioner目录。&quot;</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mount_check $server1_user $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># 使用Telnet检查SFTP服务是否联通</span><br><span class="line"># check_sftp() &#123;</span><br><span class="line">#   local server_ip=$1</span><br><span class="line">#   echo -e &quot;\n-----------使用Telnet检查SFTP服务是否联通-------------&quot;</span><br><span class="line"># #   # 使用Telnet连接到SSH端口（默认是22）</span><br><span class="line"># #   # 尝试连接SFTP服务器</span><br><span class="line"># #   sftp -oPort=22 $server_ip &lt;&lt;EOF 2&gt;/dev/null</span><br><span class="line"># #   quit</span><br><span class="line"># # EOF</span><br><span class="line"></span><br><span class="line"># #   # Check the exit status of the SFTP command</span><br><span class="line"># #   if [ $? -eq 0 ]; then</span><br><span class="line"># #     echo &quot;SFTP on $IP is working normally&quot;</span><br><span class="line"># #   else</span><br><span class="line"># #     echo &quot;SFTP on $IP is not working!&quot;</span><br><span class="line"># #   fi</span><br><span class="line"></span><br><span class="line">#   # 使用SSH命令测试SFTP服务</span><br><span class="line">#   ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null sftpuser@$server_ip sftp exit &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">#   # 检查SSH命令的退出状态码</span><br><span class="line">#   if [ $? -eq 0 ]; then</span><br><span class="line">#     echo &quot;SFTP服务正常，可以连接到主机 $server_ip 的SFTP服务。&quot;</span><br><span class="line">#   else</span><br><span class="line">#     err &quot;SFTP服务异常，无法连接到主机 $server_ip 的SFTP服务。&quot;</span><br><span class="line">#   fi</span><br><span class="line"># &#125;</span><br><span class="line"># # 调用函数来进行Telnet检查</span><br><span class="line"># check_sftp $server_ip</span><br><span class="line"></span><br><span class="line"># 检查master SSH服务状态和配置</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;master SSH服务状态和配置检查:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_sshd_config() &#123;</span><br><span class="line"></span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local server_user=$2</span><br><span class="line"></span><br><span class="line">  # 使用 ssh 连接到服务器并执行命令检查SSH服务状态</span><br><span class="line">  ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;systemctl is-active sshd&quot; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    # 获取SSH配置文件内容</span><br><span class="line">    sshd_config_content=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;cat /etc/ssh/sshd_config&quot;)</span><br><span class="line"></span><br><span class="line">    # 检查配置文件内容是否包含指定的三行数据</span><br><span class="line">    if echo &quot;$sshd_config_content&quot; | grep -q -E &quot;Subsystem\s+sftp\s+internal-sftp&quot; &amp;&amp; echo &quot;$sshd_config_content&quot; | grep -q &quot;Match User sftpuser&quot; &amp;&amp; echo &quot;$sshd_config_content&quot; | grep -q &quot;ChrootDirectory /opt/ftpfile/sftp/sftpuser/&quot;; then</span><br><span class="line">      echo -e &quot;SSH配置正常。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">      warn &quot;请检查sshd_config文件，是否正确配置sftp。&quot;</span><br><span class="line">    fi</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无法连接服务器或检查SSH服务状态。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用函数执行检查</span><br><span class="line">check_sshd_config $server1_ip $server1_user</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># sftp_with_password() &#123;</span><br><span class="line">#   echo -e &quot;\n-----------检查master的sftp连通性-------------&quot;</span><br><span class="line">#   local server_ip=$1</span><br><span class="line">#   local server_password=$2</span><br><span class="line"></span><br><span class="line">#   # 使用 expect 来自动输入密码</span><br><span class="line">#   expect -c &quot;</span><br><span class="line">#     spawn sftp -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null sftpuser@$server_ip</span><br><span class="line">#     expect &#123;</span><br><span class="line">#       \&quot;password:\&quot; &#123;</span><br><span class="line">#         send \&quot;$server_password\n\&quot;</span><br><span class="line">#         exp_continue</span><br><span class="line">#       &#125;</span><br><span class="line">#       eof</span><br><span class="line">#     &#125;</span><br><span class="line">#   &quot;</span><br><span class="line">  </span><br><span class="line">#   if [ $? -eq 0 ]; then</span><br><span class="line">#     echo -e &quot;$server_ip SFTP连接成功。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">#   else</span><br><span class="line">#     warn &quot;无法连接$server_ip 的SFTP服务。&quot;</span><br><span class="line">#   fi</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># # 调用函数来进行SFTP连接检查</span><br><span class="line"># sftp_with_password $server1_ip &quot;FYktvR1w2upoOb&quot;</span><br><span class="line"></span><br><span class="line"># 检查目录权限是否为777</span><br><span class="line"># check_directory_permission() &#123;</span><br><span class="line">#   local server_ip=$1</span><br><span class="line">#   local directory_path=$2</span><br><span class="line">#   echo -e &quot;\n-----------检查master的目录$&#123;directory_path&#125;权限-------------&quot;</span><br><span class="line"></span><br><span class="line">#   # 使用 ssh 连接到服务器并执行 stat 命令获取目录权限信息</span><br><span class="line">#   ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null sftpuser@$server_ip &quot;stat -c %a $directory_path&quot; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">#   if [ $? -eq 0 ]; then</span><br><span class="line">#     # 获取目录权限</span><br><span class="line">#     directory_permission=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null sftpuser@$server_ip &quot;stat -c %a $directory_path&quot;)</span><br><span class="line">    </span><br><span class="line">#     if [ &quot;$directory_permission&quot; -eq 777 ]; then</span><br><span class="line">#       echo -e &quot;$directory_path 目录权限为777。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">#     else</span><br><span class="line">#       warn &quot;$directory_path 目录权限不是777。&quot;</span><br><span class="line">#     fi</span><br><span class="line">#   else</span><br><span class="line">#     warn &quot;无法连接$server_ip 服务器或获取目录权限。&quot;</span><br><span class="line">#   fi</span><br><span class="line"># &#125;</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;检查master的sftp目录权限:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_user() &#123;</span><br><span class="line">  ssh $1 &quot;id $2 &gt;/dev/null 2&gt;&amp;1&quot; </span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    echo -e &quot;$2用户在$1上存在。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else  </span><br><span class="line">    err &quot;$2用户在$1上不存在&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_dir_perm() &#123;</span><br><span class="line">  ssh $1 &quot;if [ \`stat -c %a $2\` -eq $3 ]; then echo -e &#x27;$2目录为$3权限。$&#123;GREEN&#125;正常$&#123;NC&#125;&#x27;; else err &#x27;$2目录不为$3权限&#x27;; fi&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用函数来检查服务器的目录权限</span><br><span class="line">check_user $server1_ip &quot;sftpuser&quot;</span><br><span class="line"></span><br><span class="line">check_dir_perm $server1_ip &quot;/opt&quot; 755</span><br><span class="line"></span><br><span class="line">check_dir_perm $server1_ip &quot;/opt/ftpfile/sftp/sftpuser&quot; 755</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># check_directory_permission $server1_ip &quot;/opt&quot;</span><br><span class="line"># check_directory_permission $server1_ip &quot;/opt/ftpfile/sftp/sftpuser&quot;</span><br><span class="line"></span><br><span class="line"># 检查主机名与/etc/hosts文件的一致性</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;检查主机名的一致性:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_hostname_and_hosts() &#123;</span><br><span class="line"></span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local server_user=$2</span><br><span class="line">  # 使用 ssh 连接到服务器并获取主机名</span><br><span class="line">  server_hostname=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;hostname&quot;)</span><br><span class="line"></span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    # 获取 /etc/hosts 文件内容</span><br><span class="line">    hosts_file_content=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;cat /etc/hosts&quot;)</span><br><span class="line"></span><br><span class="line">    # 检查主机名与 /etc/hosts 内是否一致</span><br><span class="line">    if echo &quot;$hosts_file_content&quot; | grep -q -E &quot;^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\s+$server_hostname\s*$&quot;; then</span><br><span class="line">      echo -e &quot;$server_ip 主机名与/etc/hosts文件一致。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">      warn &quot;$server_ip 主机名与/etc/hosts文件不一致。&quot;</span><br><span class="line">    fi</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无法连接$server_ip 服务器或获取主机名。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 检查主机名与Kubernetes节点名是否一致</span><br><span class="line">check_hostname_and_k8s_node() &#123;</span><br><span class="line"></span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local server_user=$2</span><br><span class="line">  local num=$3</span><br><span class="line">  # 使用 ssh 连接到服务器并获取Kubernetes节点名</span><br><span class="line">  k8s_node_name=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;kubectl get node -o jsonpath=&#x27;&#123;.items[$num].metadata.name&#125;&#x27;&quot;)</span><br><span class="line"></span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    # 获取主机名</span><br><span class="line">    server_hostname=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;hostname&quot;)</span><br><span class="line"></span><br><span class="line">    # 检查主机名与Kubernetes节点名是否一致</span><br><span class="line">    if [ &quot;$server_hostname&quot; = &quot;$k8s_node_name&quot; ]; then</span><br><span class="line">      echo -e &quot;$server_ip 主机名与Kubernetes节点名一致。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">      warn &quot;$server_ip 主机名与Kubernetes节点名不一致。&quot;</span><br><span class="line">    fi</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无法连接$server_ip 服务器或获取Kubernetes节点名。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用函数来检查服务器的主机名与/etc/hosts文件一致性</span><br><span class="line">check_hostname_and_hosts $server1_ip $server1_user</span><br><span class="line">check_hostname_and_hosts $server2_ip $server2_user</span><br><span class="line"></span><br><span class="line"># 调用函数来检查服务器的主机名与Kubernetes节点名一致性</span><br><span class="line">check_hostname_and_k8s_node $server1_ip $server1_user 0</span><br><span class="line">check_hostname_and_k8s_node $server2_ip $server2_user 1</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"></span><br><span class="line"># 磁盘写入速度测试（带缓存）</span><br><span class="line"># disk_speed_test() &#123;</span><br><span class="line">#   # local server_ip=$1</span><br><span class="line">#   # local server_user=$2</span><br><span class="line">#   # local test_file=&quot;/tmp/disk_speed_test_file&quot;</span><br><span class="line">#   # # 进行写入测试</span><br><span class="line">#   # write_speed=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;dd if=/dev/zero of=$&#123;test_file&#125; bs=8k count=128 conv=fsync oflag=direct&quot; 2&gt;&amp;1 | tail -n 1)</span><br><span class="line">#   # echo -e &quot;$&#123;server_ip&#125; 写入速度: $write_speed&quot;</span><br><span class="line">#   # # 进行读取测试</span><br><span class="line">#   # read_speed=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;sudo dd if=$&#123;test_file&#125; of=/dev/null bs=8k count=128 conv=fsync iflag=direct&quot; 2&gt;&amp;1 | tail -n 1)</span><br><span class="line">#   # echo -e &quot;$&#123;server_ip&#125; 读取速度: $read_speed&quot;</span><br><span class="line"></span><br><span class="line">#   # # 删除测试文件</span><br><span class="line">#   # ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;rm $test_file&quot;</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># 测试磁盘读速度的函数</span><br><span class="line">disk_speed_test() &#123;</span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local test_duration=30  # 测试持续时间（秒）</span><br><span class="line"></span><br><span class="line">  echo &quot;开始测试 $server_ip 过程会持续30s...&quot;</span><br><span class="line"></span><br><span class="line">  local time0=$(date &quot;+%s&quot;)</span><br><span class="line">  cat /dev/null &gt; disk_res</span><br><span class="line"></span><br><span class="line">  while ((($(date &quot;+%s&quot;) - time0) &lt;= test_duration)); do</span><br><span class="line">    disk_info=$(ssh &quot;$server_ip&quot; &#x27;dd if=/dev/zero of=output.file bs=8k count=128 conv=fsync 2&gt;&amp;1 1&gt;/dev/null&#x27;)</span><br><span class="line">    io_res=$(echo &quot;$disk_info&quot; | grep --only-matching -E &#x27;[0-9.]+ ([MGk]?B|bytes)/[s(ec)?|秒]&#x27;)</span><br><span class="line">    echo &quot;$io_res&quot; &gt;&gt; disk_res</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">  local count=$(cat disk_res | wc -l)</span><br><span class="line">  local sum=$(cat disk_res | xargs -n2 | awk &#x27;&#123; if ($2 == &quot;kB/秒&quot; || $2 == &quot;kB/s&quot;) a+=($1/1024); else a+=$1 &#125; END&#123;printf(&quot;%.2f&quot;, a)&#125;&#x27;)</span><br><span class="line">  local average_speed=$(awk &#x27;BEGIN&#123;printf &quot;%.2f\n&quot;, &#x27;$sum&#x27;/&#x27;$count&#x27;&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">  echo -e &quot;平均速度 $server_ip: $&#123;RED&#125;$average_speed MB/s$&#123;NC&#125;。推荐值：$&#123;GREEN&#125;&gt;=200m/s$&#123;NC&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 磁盘写入速度测试（不带缓存）</span><br><span class="line"></span><br><span class="line"># disk_speed_test_no_cache() &#123;</span><br><span class="line">  # local server_ip=$1</span><br><span class="line">  # local server_user=$2</span><br><span class="line">  # local test_file=&quot;/tmp/disk_speed_test_file&quot;</span><br><span class="line">  # # 禁用磁盘缓存</span><br><span class="line">  # ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;hdparm -W0 /dev/mapper/centos-root&quot; 2&gt;/dev/null</span><br><span class="line">  # # 进行写入测试</span><br><span class="line">  # write_speed=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;dd if=/dev/zero of=$&#123;test_file&#125; bs=8k count=128 conv=fsync oflag=direct&quot; 2&gt;&amp;1 | tail -n 1)</span><br><span class="line">  # echo -e &quot;$&#123;server_ip&#125; 写入速度: $write_speed&quot;</span><br><span class="line">  # # 进行读取测试</span><br><span class="line">  # read_speed=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;sudo dd if=$&#123;test_file&#125; of=/dev/null bs=8k count=128 conv=fsync iflag=direct&quot; 2&gt;&amp;1 | tail -n 1)</span><br><span class="line">  # echo -e &quot;$&#123;server_ip&#125; 读取速度: $read_speed&quot;</span><br><span class="line"></span><br><span class="line">  # # 删除测试文件</span><br><span class="line">  # ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;rm $test_file&quot;</span><br><span class="line">  # # 启用磁盘缓存</span><br><span class="line">  # ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;hdparm -W1 /dev/mapper/centos-root&quot; 2&gt;/dev/null</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># 测试磁盘写入速度的函数</span><br><span class="line">disk_speed_test_no_cache() &#123;</span><br><span class="line">  local server_ip=&quot;$1&quot;</span><br><span class="line">  local test_duration=30  # 测试持续时间（秒）</span><br><span class="line"></span><br><span class="line">  echo &quot;开始测试 $server_ip 过程会持续30s...&quot;</span><br><span class="line"></span><br><span class="line">  local time0=$(date &quot;+%s&quot;)</span><br><span class="line">  cat /dev/null &gt; disk_res</span><br><span class="line"></span><br><span class="line">  while ((($(date &quot;+%s&quot;) - time0) &lt;= test_duration)); do</span><br><span class="line">    disk_info=$(ssh &quot;$server_ip&quot; &#x27;dd if=/dev/zero of=output.file bs=8k count=128 oflag=direct,nonblock conv=fsync 2&gt;&amp;1 1&gt;/dev/null&#x27;)</span><br><span class="line">    io_res=$(echo &quot;$disk_info&quot; | grep --only-matching -E &#x27;[0-9.]+ ([MGk]?B|bytes)/[s(ec)?|秒]&#x27;)</span><br><span class="line">    echo &quot;$io_res&quot; &gt;&gt; disk_res</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">  local count=$(cat disk_res | wc -l)</span><br><span class="line">  local sum=$(cat disk_res | xargs -n2 | awk &#x27;&#123; if ($2 == &quot;kB/秒&quot; || $2 == &quot;kB/s&quot;) a+=($1/1024); else a+=$1 &#125; END&#123;printf(&quot;%.2f&quot;, a)&#125;&#x27;)</span><br><span class="line">  local average_speed=$(awk &#x27;BEGIN&#123;printf &quot;%.2f\n&quot;, &#x27;$sum&#x27;/&#x27;$count&#x27;&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">  echo -e &quot;平均速度 $server_ip: $&#123;RED&#125; $average_speed MB/s $&#123;NC&#125;。推荐值：$&#123;GREEN&#125;&gt;=50m/s$&#123;NC&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 检查 CPU 是否支持 AVX</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;检查 CPU 是否支持 AVX:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_avx_support() &#123;</span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local avx_check=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$server_ip &quot;grep -o &#x27;avx&#x27; /proc/cpuinfo&quot;)</span><br><span class="line"></span><br><span class="line">  if [ -n &quot;$avx_check&quot; ]; then</span><br><span class="line">    echo -e &quot;$server_ip CPU 支持 AVX (Advanced Vector Extensions)。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    warn &quot;$server_ip CPU 不支持 AVX (Advanced Vector Extensions)。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用函数来检查 AVX 支持</span><br><span class="line">check_avx_support  $server1_ip</span><br><span class="line">check_avx_support  $server2_ip</span><br><span class="line"></span><br><span class="line"># 定义要加载镜像的目录列表</span><br><span class="line">load_images() &#123;</span><br><span class="line">  image_directories=(&quot;/opt/xx/images/product/insight&quot; &quot;/opt/xx/images/product/insight/patch&quot;)</span><br><span class="line"></span><br><span class="line">  # 遍历目录并加载镜像</span><br><span class="line">  for directory in &quot;$&#123;image_directories[@]&#125;&quot;; do</span><br><span class="line">    if [ -d &quot;$directory&quot; ]; then</span><br><span class="line">      cd &quot;$directory&quot;</span><br><span class="line">      echo &quot;进入目录: $directory&quot;</span><br><span class="line">      for file in $(ls . | grep .tgz); do</span><br><span class="line">        echo &quot;加载镜像: $file&quot;</span><br><span class="line">        docker load &lt; &quot;$file&quot;</span><br><span class="line">      done</span><br><span class="line">    else</span><br><span class="line">      echo &quot;目录 $directory 不存在。&quot;</span><br><span class="line">    fi</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 检查磁盘性能</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;磁盘测试:$&#123;NC&#125;\n&quot;</span><br><span class="line"># read -p &quot;是否要检查磁盘？ (y/n): &quot; confirm</span><br><span class="line">echo &quot;是否要检查磁盘？ (y/n)：&quot;</span><br><span class="line">read confirm</span><br><span class="line">if [ &quot;$confirm&quot; = &quot;y&quot; ]; then</span><br><span class="line">  echo -e &quot;\n$&#123;BLUE&#125;磁盘写入速度测试（不带缓存）:$&#123;NC&#125;\n&quot;</span><br><span class="line">  disk_speed_test_no_cache $server1_ip</span><br><span class="line">  disk_speed_test_no_cache $server2_ip</span><br><span class="line">  echo -e &quot;\n$&#123;BLUE&#125;磁盘写入速度测试（带缓存）:$&#123;NC&#125;\n&quot;</span><br><span class="line">  disk_speed_test $server1_ip </span><br><span class="line">  disk_speed_test $server2_ip</span><br><span class="line">else</span><br><span class="line">  echo &quot;取消磁盘检查。&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 镜像丢的时候使用</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;镜像加载:$&#123;NC&#125;\n&quot;</span><br><span class="line">echo &quot;是否要加载 Docker 镜像？ (y/n)：&quot;</span><br><span class="line">read confirm</span><br><span class="line"># read -p &quot;是否要加载 Docker 镜像？ (y/n): &quot; confirm</span><br><span class="line">if [ &quot;$confirm&quot; = &quot;y&quot; ]; then</span><br><span class="line">  load_images</span><br><span class="line">else</span><br><span class="line">  echo &quot;取消加载 Docker 镜像。&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       </span><br></pre></td></tr></table></figure>
</code></pre></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/07/29/%E9%81%87%E8%A7%81OOM/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/07/29/%E9%81%87%E8%A7%81OOM/" class="post-title-link" itemprop="url">遇见OOM</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-07-29 21:12:00" itemprop="dateCreated datePublished" datetime="2024-07-29T21:12:00+08:00">2024-07-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">工作</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第七篇</span></div><div class="article-quote">离职系列，想想这几年在公司的成长，在这做个记录。此篇主要谈谈LMT时，处理的两次OOM问题。</div><p>为啥是两次？因为都很有代表性，一次可以算是三方库使用不当，一次是程序自身的问题。</p><h3 id="第一次"><a href="#第一次" class="headerlink" title="第一次"></a>第一次</h3><p>JPA使用不当,….待续</p><h3 id="第二次"><a href="#第二次" class="headerlink" title="第二次"></a>第二次</h3><p>应用频繁重启,….待续</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/07/16/%E6%9C%8D%E5%8A%A1%E5%8F%AF%E7%94%A8%E6%80%A7-%E6%A1%88%E4%BE%8B/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/07/16/%E6%9C%8D%E5%8A%A1%E5%8F%AF%E7%94%A8%E6%80%A7-%E6%A1%88%E4%BE%8B/" class="post-title-link" itemprop="url">服务可用性-案例</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-07-16 13:49:00" itemprop="dateCreated datePublished" datetime="2024-07-16T13:49:00+08:00">2024-07-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">工作</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第七篇</span></div><div class="article-quote">离职系列，想想这几年在公司的成长，在这做个记录。上一篇<a href="/2024/06/15/%E5%AE%9A%E4%BD%8D%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="服务可用性定位问题常用命令">服务可用性定位问题常用命令</a>，针对服务可用性常用命令进行了说明，这一篇主要是讲实践案例。</div><p>因为我在LMT除了日常管理工作外，额外向领导请求了承担部分现场问题处理，挑的比较陌生且有挑战性的“服务可用性的问题”，想着在实践中学习，并且这部分问题是最麻烦的没有什么标准，往往又是最紧急的，我担起来一是减少了组员上报成本，另一个我更方便直接找到对应的负责人进行沟通，提高效率。所以这块积累的经验更多。</p><h2 id="案例分享"><a href="#案例分享" class="headerlink" title="案例分享"></a>案例分享</h2><p>简单分享几个案例，一个主要对外（TAC），一个对内（组内研发）。两个文档因为对象不同，使用场景不同，稍有差异。</p><p>整理案例，一是为了组内共同学习，二是提供给TAC团队，让其能更多的拦截一些一线提出的较简单的现场问题。</p><h3 id="案例1（TAC）"><a href="#案例1（TAC）" class="headerlink" title="案例1（TAC）"></a>案例1（TAC）</h3><img src="/2024/07/16/%E6%9C%8D%E5%8A%A1%E5%8F%AF%E7%94%A8%E6%80%A7-%E6%A1%88%E4%BE%8B/1.jpg"><h3 id="案例2（TAC）"><a href="#案例2（TAC）" class="headerlink" title="案例2（TAC）"></a>案例2（TAC）</h3><img src="/2024/07/16/%E6%9C%8D%E5%8A%A1%E5%8F%AF%E7%94%A8%E6%80%A7-%E6%A1%88%E4%BE%8B/dns.jpg"><h3 id="案例3（研发）"><a href="#案例3（研发）" class="headerlink" title="案例3（研发）"></a>案例3（研发）</h3><img src="/2024/07/16/%E6%9C%8D%E5%8A%A1%E5%8F%AF%E7%94%A8%E6%80%A7-%E6%A1%88%E4%BE%8B/date.jpeg"></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/06/18/%E7%8E%B0%E5%9C%BA%E4%BA%8B%E6%95%85/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/06/18/%E7%8E%B0%E5%9C%BA%E4%BA%8B%E6%95%85/" class="post-title-link" itemprop="url">现场事故</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-06-18 00:22:00" itemprop="dateCreated datePublished" datetime="2024-06-18T00:22:00+08:00">2024-06-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">工作</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第六篇</span></div><div class="article-quote">离职系列，想想这几年在公司的成长，在这做个记录。此篇主要谈谈LMT时期。</div><p>因为现场故障直接影响客户口碑、人力成本等事业部的重要指标，所以事业部领导要求针对现场故障处理需要有单独的奖惩制度，让整个事业部重视起来，所以我整理了对应的内容用于事业部邮件同步。</p><h2 id="事故的定义"><a href="#事故的定义" class="headerlink" title="事故的定义"></a>事故的定义</h2><p>故障处理或产品自身服务中断造成客户损失、恶劣影响。（一线、客户投诉且影响产品口碑的）。</p><h2 id="事故处理"><a href="#事故处理" class="headerlink" title="事故处理"></a>事故处理</h2><img src="/2024/06/18/%E7%8E%B0%E5%9C%BA%E4%BA%8B%E6%95%85/sg.jpg"><h2 id="奖惩制度"><a href="#奖惩制度" class="headerlink" title="奖惩制度"></a>奖惩制度</h2><p>这块就比较个性化了，主要看重视程度，需要根据公司规章制度和领导的要求做调整。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/06/15/%E5%AE%9A%E4%BD%8D%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/06/15/%E5%AE%9A%E4%BD%8D%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">服务可用性定位问题常用命令</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-06-15 20:07:00" itemprop="dateCreated datePublished" datetime="2024-06-15T20:07:00+08:00">2024-06-15</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">工作</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第五篇</span></div><div class="article-quote">离职系列，想想这几年在公司的成长，在这做个记录。上一篇<a href="/2024/06/14/%E7%8E%B0%E5%9C%BA%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D/" title="现场故障定位指南">现场故障定位指南</a>，主要讲的方法论，这篇主要对服务可用性的几个场景总结下相应的命令。</div><p>以下命令主要针对现场经常出现的安装失败、升级失败、补丁失败、服务不断重启、服务不可用几个场景：</p><ol><li>安装失败，通常就是现场环境问题，比如服务器的磁盘性能不达标、网络通信问题、服务器DNS配置错误、集群IP段不可用</li><li>升级失败，通常和服务器的资源紧张有关（内存、磁盘、CPU等）</li><li>服务不断重启，通常是基础组件问题如redis异常、应用pod自身程序的bug如OOM、k8s组件问题如etcd重启</li><li>服务不可用，通常就是集群出了问题，比如磁盘满了导致镜像丢失</li></ol><h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><ol><li>确认环境信息<ul><li>环境信息<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 操作系统版本</span><br><span class="line">cat /etc/redhat-release  # CentOS版本</span><br><span class="line">cat /etc/openEuler-release  # 欧拉版本</span><br><span class="line">uname -r  # 内核版本</span><br><span class="line">cat /proc/version  # 内核编译信息</span><br><span class="line">hostnamectl  # 查看完整的系统信息</span><br><span class="line"></span><br><span class="line"># 系统基础信息</span><br><span class="line">df -h               # 磁盘空间</span><br><span class="line">free -h             # 内存使用</span><br><span class="line">top                 # CPU和进程状态</span><br><span class="line">netstat -ant        # 网络连接</span><br><span class="line">uptime              # 系统负载</span><br><span class="line">iostat -x 1 10      # 磁盘状态</span><br><span class="line"></span><br><span class="line"># 进程分析</span><br><span class="line">ps -ef | grep 进程名</span><br><span class="line">pstree -p 进程ID</span><br><span class="line">lsof -p 进程ID</span><br><span class="line"></span><br><span class="line"># 分区及挂载</span><br><span class="line">lsblk  # 查看块设备</span><br><span class="line">df -Th  # 查看文件系统类型和空间</span><br><span class="line">mount | grep -E &quot;^/dev&quot;  # 查看挂载参数</span><br><span class="line"></span><br><span class="line"># 磁盘空间</span><br><span class="line">du -sh /* | sort -hr  # 大文件目录排序</span><br><span class="line"># 时间同步状态</span><br><span class="line">chronyc sources -v</span><br></pre></td></tr></table></figure></li><li>K8s集群状态<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># K8s集群状态</span><br><span class="line">systemctl status kubelet  # kubelet是否正常</span><br><span class="line">systemctl status docker # docker是否正常</span><br><span class="line">systemctl status NetworkManager # 网络连接工具是否正常</span><br><span class="line">kubectl cluster-info #查看集群信息</span><br><span class="line">kubectl get nodes   # kubelet集群节点</span><br><span class="line">kubectl get po -A   # 查看所以pod状态</span><br><span class="line">kubectl get po -A -owide   # 查看所以pod的ip和所在的node</span><br><span class="line">kubectl describe node &lt;node-name&gt;</span><br><span class="line">kubectl get events -n &lt;namespace&gt;  #Kubernetes 事件日志</span><br><span class="line">journalctl -u kubelet -f  # 日志查看</span><br><span class="line">cat /var/log/messages | grep xx  # 日志查看 </span><br><span class="line"></span><br><span class="line"># 应用Pod状态</span><br><span class="line">kubectl get pods -n &lt;namespace&gt; -o wide</span><br><span class="line">ping pod_ip # 判断容器之间的联通性</span><br><span class="line">kubectl describe &lt;pod-name&gt; -n &lt;namespace&gt;</span><br><span class="line">kubectl exec -it &lt;pod-name&gt; -n &lt;namespace&gt; /bin/sh  # 进入容器内部</span><br><span class="line">kubectl logs &lt;pod-name&gt; -n &lt;namespace&gt; </span><br><span class="line"></span><br><span class="line"># 集群资源状态</span><br><span class="line">kubectl top nodes</span><br><span class="line">kubectl top pods -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure></li></ul></li></ol><ul><li>客户网络环境限制（可用端口、防火墙策略）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 网络组件</span><br><span class="line">ip link show</span><br><span class="line">iptables -L</span><br><span class="line"></span><br><span class="line"># DNS配置</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line"># 网络分析 </span><br><span class="line">curl url  # 应用连通性</span><br><span class="line">fping -c xx -p xx 目标IP或域名  # 基础连通性</span><br><span class="line">ping &lt;目标IP&gt;    # 基础连通性</span><br><span class="line">telnet &lt;IP&gt; &lt;端口&gt;    # 端口连通性</span><br><span class="line">traceroute    # 路由跟踪</span><br><span class="line">tcpdump -i any port &lt;端口&gt; -w dump.pcap    # 抓包分析</span><br></pre></td></tr></table></figure></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://jimmysong.io/kubernetes-hndbaook/guide/using-kubectl.html">https://jimmysong.io/kubernetes-hndbaook/guide/using-kubectl.html</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/debug/_print/">https://kubernetes.io/zh-cn/docs/tasks/debug/_print/</a><br><a target="_blank" rel="noopener" href="https://cheat.sh/">https://cheat.sh/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">https://kubernetes.io/docs/reference/kubectl/cheatsheet/</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/">https://kubernetes.io/zh/docs/reference/kubectl/</a><br><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/run/">https://docs.docker.com/engine/reference/run/</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/06/14/%E7%8E%B0%E5%9C%BA%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/IMG_4038.jpeg"><meta itemprop="name" content="Gamehu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="正儿八经 - 资深Java/React工程师"><meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2024/06/14/%E7%8E%B0%E5%9C%BA%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D/" class="post-title-link" itemprop="url">现场故障定位指南</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-06-14 23:31:00" itemprop="dateCreated datePublished" datetime="2024-06-14T23:31:00+08:00">2024-06-14</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">工作</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><hr><div class="tag-container"><span class="main-tag">离职系列</span> <span class="sub-tag">第四篇</span></div><div class="article-quote">离职系列，想想这几年在公司的成长，在这做个记录。此篇主要谈谈LMT时，简单总结了一套针对问题现场定位方法论。</div><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在客户现场环境中，我们往往面临网络隔离、工具受限、信息不完整等挑战。并且由于LMT(9人)资源有限，但是试用+付费的现场却有500左右，且数字还在不断增加，因此需要科学的方法论和充分的实践经验，下面是我针对<em>服务异常</em>问题整理的，该问题出现频次最高且专业性强涉及多种操作系统（欧拉、centos、麒麟），整理文档方便其它成员学习实践。成员可以结合实际情况灵活调整。</p><h3 id="定位指南"><a href="#定位指南" class="headerlink" title="定位指南"></a>定位指南</h3><h4 id="第一阶段：问题收集与初步分析（原则上TAC或一线提供）"><a href="#第一阶段：问题收集与初步分析（原则上TAC或一线提供）" class="headerlink" title="第一阶段：问题收集与初步分析（原则上TAC或一线提供）"></a>第一阶段：问题收集与初步分析（原则上TAC或一线提供）</h4><ol><li><p>确认问题的基本信息</p><ul><li>问题的具体表现（错误信息、异常行为等）</li><li>问题的影响范围</li><li>问题的发生时间和频率</li><li>问题是否可复现</li></ul></li><li><p>建立问题基线</p><ul><li>首次发现问题的时间点</li><li>相关变更的时间点（补丁、升级、断电等）</li><li>现场采取的临时措施</li></ul></li></ol><h4 id="第二阶段：快速诊断（LMT）"><a href="#第二阶段：快速诊断（LMT）" class="headerlink" title="第二阶段：快速诊断（LMT）"></a>第二阶段：快速诊断（LMT）</h4><ol><li><p>检查环境</p><ul><li>k8s集群、组件状态、应用pod状态</li><li>检查系统资源(磁盘、内存等)</li></ul></li><li><p>检查日志信息</p><ul><li>查看集群日志、组件日志</li><li>查看应用pod日志</li></ul></li><li><p>进行初步故障假设</p><ul><li>根据已收集的信息提出可能的故障原因</li><li>按照影响范围和可能性排序</li><li>可通过经验+知识库等制定快速验证方案</li></ul></li></ol><h4 id="第三阶段：深入分析（LMT-后端研发接口人）"><a href="#第三阶段：深入分析（LMT-后端研发接口人）" class="headerlink" title="第三阶段：深入分析（LMT+后端研发接口人）"></a>第三阶段：深入分析（LMT+后端研发接口人）</h4><ol><li><p>验证假设</p><ul><li>复现问题场景</li><li>收集更多证据支持或否定假设</li></ul></li><li><p>确定初步根因</p><ul><li>总结所有收集到的证据</li><li>确认问题的触发条件</li><li>建立问题发生的完整链路</li></ul></li><li><p>是否升级问题</p><ul><li>如果验证有出入或者没有更好的办法则转交问题到我</li><li>我来决定是否升级问题（申请后端研发介入）</li></ul></li></ol><h4 id="第四阶段：解决方案（LMT-后端研发接口人-TAC-一线）"><a href="#第四阶段：解决方案（LMT-后端研发接口人-TAC-一线）" class="headerlink" title="第四阶段：解决方案（LMT+后端研发接口人+TAC+一线）"></a>第四阶段：解决方案（LMT+后端研发接口人+TAC+一线）</h4><ol><li><p>制定修复方案</p><ul><li>提出短期解决方案（快速修复）</li><li>设计长期解决方案（根本解决）</li><li>评估方案的风险和影响并告知一线，让其与客户沟通确认</li></ul></li><li><p>实施修复</p><ul><li>客户确认后，在测试环境验证解决方案</li><li>准备回滚方案（备份数据、备份镜像等）</li><li>实施修复并验证效果</li></ul></li></ol><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>所有重要操作前先备份</li><li>收集足够的证据再行动</li><li>重要变更需要得到一线授权</li><li>保持操作记录的完整性</li><li>及时同步问题处理进展</li><li>警惕处理过程中的连锁反应</li></ol><h3 id="附一张简单的问题记录卡模板"><a href="#附一张简单的问题记录卡模板" class="headerlink" title="附一张简单的问题记录卡模板"></a>附一张简单的问题记录卡模板</h3><img src="/2024/06/14/%E7%8E%B0%E5%9C%BA%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D/gzk.jpg"></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Gamehu</span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动</div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script></body></html>