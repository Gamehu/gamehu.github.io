<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/IMG_4038-32.jpeg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/IMG_4038.jpeg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.gamehu.run","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.12.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
<meta property="og:type" content="website">
<meta property="og:title" content="正儿八经 - 资深Java&#x2F;React工程师">
<meta property="og:url" content="https://www.gamehu.run/index.html">
<meta property="og:site_name" content="正儿八经 - 资深Java&#x2F;React工程师">
<meta property="og:description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Gamehu">
<meta property="article:tag" content="Java开发, React工程师, 全栈开发, 求职, 软件工程师">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.gamehu.run/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>正儿八经 - 资深Java/React工程师</title>
  




<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/ilyabirman-likely@2/release/likely.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>
#needsharebutton-postbottom {
  cursor: pointer;
  height: 26px;
  margin-top: 10px;
  position: relative;
}
#needsharebutton-postbottom .btn {
  border: 1px solid $btn-default-border-color;
  border-radius: 3px;
  display: initial;
  padding: 1px 4px;
}
</style>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">正儿八经 - 资深Java/React工程师</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">浪起来？技术博客与求职信息</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Gamehu"
      src="/images/IMG_4038.jpeg">
  <p class="site-author-name" itemprop="name">Gamehu</p>
  <div class="site-description" itemprop="description">10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">189</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">112</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/gamehu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gamehu" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:gamehu520@gmail.com" title="E-Mail → mailto:gamehu520@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/gamehu/gamehu.github.io" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2025/03/04/what-is-AI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/04/what-is-AI/" class="post-title-link" itemprop="url">what is AI</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-03-04 23:31:00" itemprop="dateCreated datePublished" datetime="2025-03-04T23:31:00+08:00">2025-03-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">学习</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="ai-tag">AI系列</span>
  <span class="sub-tag">第三篇</span>
</div>

<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>整理此篇最开始源于之前验证<a href="/2024/12/23/AI%E5%BA%94%E7%94%A8%E5%B0%9D%E9%B2%9C/" title="AI应用尝鲜">AI应用尝鲜</a>时，因为当时后续计划在AI做更多比如模型微调，AI应用等，，增加saas平台的噱头的同时成为一个亮点功能，提升用户体验，当时就想整理写一篇但是老忘。</p>
<p>刚好最近找工作看到了很多AI相关的JD，所以想借着找工作的空隙，补一补这块的知识。</p>
<p>其实我应该是比较早用chatgpt的用户，我都付费了一段时间后，我的很多同事才刚开始想方设法使用chatgpt，但是对于我来说更多时候把它作为一个效率工具或者新奇的玩具在用，关于AI的概念比较散，没有系统的深入了解过，刚好有工作中的机会让我意识到AI离我那么近，我应该好好认知它了，所以有了这篇文章，先把各种概念搞清楚。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="1-人工智能的基础概念"><a href="#1-人工智能的基础概念" class="headerlink" title="1. 人工智能的基础概念"></a>1. 人工智能的基础概念</h2><h3 id="什么是人工智能？"><a href="#什么是人工智能？" class="headerlink" title="什么是人工智能？"></a>什么是人工智能？</h3><p>人工智能（Artificial Intelligence，简称AI）是指通过计算机系统模拟人类智能的技术。它让机器能够学习、推理、感知、交流，甚至模仿人类的认知能力。</p>
<h3 id="AI的分类"><a href="#AI的分类" class="headerlink" title="AI的分类"></a>AI的分类</h3><p>从应用角度，AI可分为三种类型：</p>
<ol>
<li><p><strong>弱人工智能（Narrow AI）</strong>：专注于解决特定问题的AI，如语音助手、图像识别等。现阶段大多数AI应用都属于此类。</p>
</li>
<li><p><strong>通用人工智能（AGI）</strong>：具备与人类相当的认知能力，能够理解、学习并应用知识解决各种问题。目前仍处于理论和研究阶段。</p>
</li>
<li><p><strong>超级人工智能（ASI）</strong>：理论上超越人类智能的AI，能在几乎所有领域超越人类最优秀的表现。</p>
</li>
</ol>
<h3 id="AI的核心技术基础"><a href="#AI的核心技术基础" class="headerlink" title="AI的核心技术基础"></a>AI的核心技术基础</h3><ol>
<li><p><strong>机器学习（Machine Learning）</strong>：让计算机从数据中学习并改进的方法，而不需要被明确编程。</p>
</li>
<li><p><strong>深度学习（Deep Learning）</strong>：机器学习的一个子集，是神经网络的一种实现方法，使用多层神经网络模拟人脑结构进行学习。深度学习是一种让多层神经元可以进行有效计算的方法，大大提高了神经网络的性能。“深度学习”这个名字，就是比喻多层神经元的自主学习过程。</p>
</li>
<li><p><strong>自然语言处理（NLP）</strong>：使计算机能够理解、解释和生成人类语言。</p>
</li>
<li><p><strong>计算机视觉（Computer Vision）</strong>：让计算机能够”看到”并理解视觉信息。</p>
</li>
</ol>
<h2 id="2-机器学习：AI的核心引擎"><a href="#2-机器学习：AI的核心引擎" class="headerlink" title="2. 机器学习：AI的核心引擎"></a>2. 机器学习：AI的核心引擎</h2><h3 id="机器学习的基本概念"><a href="#机器学习的基本概念" class="headerlink" title="机器学习的基本概念"></a>机器学习的基本概念</h3><p>机器学习使计算机能够通过经验自动改进，这种”经验”通常来自数据。简单来说，传统编程是人类编写规则让计算机执行，而机器学习是计算机从数据中找出规则。</p>
<h3 id="机器学习的主要类型"><a href="#机器学习的主要类型" class="headerlink" title="机器学习的主要类型"></a>机器学习的主要类型</h3><ol>
<li><p><strong>监督学习</strong>：使用已标记的数据训练模型，如分类和回归问题。</p>
<ul>
<li>例如：垃圾邮件分类、房价预测</li>
</ul>
</li>
<li><p><strong>无监督学习</strong>：从未标记的数据中发现模式和结构。</p>
<ul>
<li>例如：客户分群、异常检测</li>
</ul>
</li>
<li><p><strong>强化学习</strong>：通过尝试与环境互动并获得反馈来学习最佳策略。</p>
<ul>
<li>例如：游戏AI、自动驾驶决策系统</li>
</ul>
</li>
</ol>
<h3 id="神经网络与深度学习"><a href="#神经网络与深度学习" class="headerlink" title="神经网络与深度学习"></a>神经网络与深度学习</h3><p>神经网络是机器学习的一种主要形式。它模仿人脑神经元连接方式的数学模型，由多层人工神经元组成：</p>
<ol>
<li><strong>输入层</strong>：接收初始数据</li>
<li><strong>隐藏层</strong>：处理信息（深度学习通常有多个隐藏层）</li>
<li><strong>输出层</strong>：产生最终结果</li>
</ol>
<p>深度学习是神经网络的一种实现方法，使用的神经网络具有多个隐藏层，能够学习更复杂的特征和模式，特别适合处理非结构化数据如图像、声音和文本。</p>
<h2 id="3-现代AI模型与架构"><a href="#3-现代AI模型与架构" class="headerlink" title="3. 现代AI模型与架构"></a>3. 现代AI模型与架构</h2><h3 id="深度学习的方法"><a href="#深度学习的方法" class="headerlink" title="深度学习的方法"></a>深度学习的方法</h3><h4 id="卷积神经网络（CNN）"><a href="#卷积神经网络（CNN）" class="headerlink" title="卷积神经网络（CNN）"></a>卷积神经网络（CNN）</h4><p>CNN专门设计用于处理图像数据，通过使用卷积层来检测特征（如边缘、形状等），然后通过池化层减少数据维度，最后通过全连接层进行分类。</p>
<p>CNN广泛应用于：</p>
<ul>
<li>图像分类与识别</li>
<li>物体检测</li>
<li>医学图像分析</li>
</ul>
<h4 id="循环神经网络（RNN）与长短期记忆网络（LSTM）"><a href="#循环神经网络（RNN）与长短期记忆网络（LSTM）" class="headerlink" title="循环神经网络（RNN）与长短期记忆网络（LSTM）"></a>循环神经网络（RNN）与长短期记忆网络（LSTM）</h4><p>RNN能够处理序列数据，具有”记忆”功能，适合处理文本、语音等时序数据。LSTM是RNN的改进版，解决了长序列训练中的梯度消失问题。</p>
<p>应用领域：</p>
<ul>
<li>语音识别</li>
<li>机器翻译</li>
<li>文本生成</li>
</ul>
<h4 id="Transformer架构"><a href="#Transformer架构" class="headerlink" title="Transformer架构"></a>Transformer架构</h4><p>Transformer通过自注意力机制处理序列数据，克服了RNN处理长序列的局限性，成为现代语言模型的基础架构。Transformer 不同于以前的方法，不再一个个处理输入的单词，而是一次性处理整个输入，对每个词分配不同的权重。这种方法直接导致了2022年ChatGPT和后来无数生成式AI模型的诞生，是神经网络和深度学习目前的主流方法。<br>由于基于 Transformer 的模型需要一次性处理整个输入，所以都有“上下文大小”这个指标，指的是一次可以处理的最大输入。比如，GPT-4 Turbo 的上下文是 128k 个 Token，相当于一次性读取超过300页的文本。上下文越大，模型能够考虑的信息就越多，生成的回答也就越相关和连贯，相应地，所需要的算力也就越多。</p>
<p>著名的Transformer模型：</p>
<ul>
<li>BERT（谷歌）</li>
<li>GPT系列（OpenAI）</li>
<li>Claude系列（Anthropic）</li>
</ul>
<h3 id="大型语言模型（LLM）"><a href="#大型语言模型（LLM）" class="headerlink" title="大型语言模型（LLM）"></a>大型语言模型（LLM）</h3><p>大型语言模型（Large Language Models，简称LLM）如GPT-4、Claude和Llama是基于Transformer架构的巨型AI模型，通过大规模预训练和微调，能够理解和生成人类语言，执行各种复杂的语言任务。本质上是一种基于深度学习的人工智能系统，它能够理解、生成和处理人类语言。让我来简单解释一下：</p>
<h4 id="大语言模型的本质"><a href="#大语言模型的本质" class="headerlink" title="大语言模型的本质"></a>大语言模型的本质</h4><p>大语言模型是一种超大规模的神经网络，通常基于Transformer架构，它通过分析海量文本数据来”学习”语言的模式、规则和知识。想象一下，它就像一个阅读了互联网上大部分内容的”超级读者”，通过理解文字之间的关系来预测和生成文本。</p>
<h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><ol>
<li><strong>预训练</strong>：模型首先在海量文本数据上进行训练，学习词汇、语法、事实知识和一些推理能力</li>
<li><strong>模式识别</strong>：它学会识别词语间的关系和上下文意义</li>
<li><strong>生成文本</strong>：当你给它一个提示或问题时，它会预测最可能的后续文本</li>
</ol>
<h4 id="特点和能力"><a href="#特点和能力" class="headerlink" title="特点和能力"></a>特点和能力</h4><ul>
<li><strong>规模巨大</strong>：现代LLM通常有数十亿到数万亿个参数（如GPT-4、Claude等）</li>
<li><strong>通用性强</strong>：不需要针对特定任务重新训练就能执行多种语言任务</li>
<li><strong>上下文理解</strong>：能够理解长文本中的上下文关系</li>
<li><strong>生成能力</strong>：可以创作文章、对话、代码、诗歌等多种内容</li>
<li><strong>少样本学习</strong>：只需几个例子就能理解新任务</li>
</ul>
<h4 id="常见应用"><a href="#常见应用" class="headerlink" title="常见应用"></a>常见应用</h4><ul>
<li>聊天机器人和虚拟助手</li>
<li>内容创作和写作辅助</li>
<li>代码生成和编程辅助</li>
<li>文档总结和信息提取</li>
<li>语言翻译和知识问答</li>
</ul>
<p>简单来说，大语言模型是一种能够”理解”并”生成”人类语言的AI系统，它通过分析海量文本数据学习语言模式，并能够处理各种语言相关的任务。正是由于它的规模和训练方式，使它具备了理解上下文、生成连贯文本、解决问题和模拟对话等能力。</p>
<h2 id="4-AI模型评估与开发框架"><a href="#4-AI模型评估与开发框架" class="headerlink" title="4. AI模型评估与开发框架"></a>4. AI模型评估与开发框架</h2><h3 id="AI模型的评价指标"><a href="#AI模型的评价指标" class="headerlink" title="AI模型的评价指标"></a>AI模型的评价指标</h3><ol>
<li><p><strong>准确率（Accuracy）</strong>：</p>
<ul>
<li>定义：正确预测的样本数除以总样本数</li>
<li>适用：分类问题，特别是类别平衡的情况</li>
<li>局限：在类别不平衡情况下可能产生误导</li>
</ul>
</li>
<li><p><strong>精确率（Precision）与召回率（Recall）</strong>：</p>
<ul>
<li>精确率：真正例数除以所有预测为正例的数量</li>
<li>召回率：真正例数除以所有实际正例的数量</li>
<li>应用：搜索引擎结果、医疗诊断等需要平衡查全率和查准率的场景</li>
</ul>
</li>
<li><p><strong>F1分数</strong>：</p>
<ul>
<li>定义：精确率和召回率的调和平均数</li>
<li>特点：同时考虑精确率和召回率，对极端值敏感</li>
<li>公式：F1 &#x3D; 2 × (精确率 × 召回率) &#x2F; (精确率 + 召回率)</li>
</ul>
</li>
<li><p><strong>ROC曲线和AUC值</strong>：</p>
<ul>
<li>ROC曲线：以假正例率为横轴，真正例率为纵轴的曲线</li>
<li>AUC：ROC曲线下的面积，表示模型区分正负样本的能力</li>
<li>数值含义：AUC为0.5表示随机猜测，越接近1表示模型越好</li>
</ul>
</li>
<li><p><strong>困惑度（Perplexity）</strong>：</p>
<ul>
<li>定义：评估语言模型预测下一个词能力的指标</li>
<li>计算：基于交叉熵，越低表示模型预测越准确</li>
<li>应用：评估GPT、BERT等语言模型的训练效果</li>
</ul>
</li>
<li><p><strong>BLEU分数</strong>：</p>
<ul>
<li>用途：评估机器翻译或文本生成质量</li>
<li>机制：比较生成文本与参考文本的n-gram重合度</li>
<li>范围：0到1，越高表示越接近参考文本</li>
</ul>
</li>
<li><p><strong>推理速度与延迟</strong>：</p>
<ul>
<li>测量：每秒处理的请求数或响应所需的时间</li>
<li>影响因素：模型大小、硬件配置、批处理大小</li>
<li>重要性：实时应用中的关键指标</li>
</ul>
</li>
<li><p><strong>参数量与计算复杂度</strong>：</p>
<ul>
<li>参数量：模型包含的可训练参数数量，通常以亿(B)计</li>
<li>FLOPs：浮点运算数，衡量计算复杂度</li>
<li>应用：评估模型规模和资源需求</li>
</ul>
</li>
<li><p><strong>MMLU（大规模多任务语言理解）</strong>：</p>
<ul>
<li>测试内容：涵盖57个科目的多选题</li>
<li>价值：评估模型在不同领域的知识和推理能力</li>
<li>应用：评估像GPT-4、Claude等大型语言模型</li>
</ul>
</li>
<li><p><strong>毒性与公平性评估</strong>：</p>
<ul>
<li>毒性指标：评估模型产生有害内容的倾向</li>
<li>公平性指标：评估模型对不同群体的偏见程度</li>
<li>方法：使用特定的基准测试集和人类评估</li>
</ul>
</li>
</ol>
<h3 id="流行的深度学习框架"><a href="#流行的深度学习框架" class="headerlink" title="流行的深度学习框架"></a>流行的深度学习框架</h3><ol>
<li><p><strong>TensorFlow</strong>：由Google开发的开源机器学习框架</p>
<ul>
<li>特点：完整的生态系统，支持生产环境部署，TensorBoard可视化</li>
<li>应用：大规模产品化AI服务，如语音识别、图像分类等</li>
<li>适合：企业级应用和研究团队</li>
</ul>
</li>
<li><p><strong>PyTorch</strong>：由Facebook (Meta) AI研究团队开发</p>
<ul>
<li>特点：动态计算图，直观的Python接口，更易于调试</li>
<li>应用：学术研究，原型开发，尤其在NLP和计算机视觉领域流行</li>
<li>适合：研究人员和快速迭代开发</li>
</ul>
</li>
<li><p><strong>其他重要框架</strong>：</p>
<ul>
<li><strong>Keras</strong>：高级API，可在TensorFlow之上运行，简化开发流程</li>
<li><strong>JAX</strong>：Google开发的用于高性能数值计算的库</li>
<li><strong>Hugging Face Transformers</strong>：专注于预训练模型的库，尤其是NLP模型</li>
</ul>
</li>
</ol>
<h3 id="数据与训练过程"><a href="#数据与训练过程" class="headerlink" title="数据与训练过程"></a>数据与训练过程</h3><p>AI模型的训练需要大量高质量数据和计算资源：</p>
<ol>
<li><strong>数据收集与处理</strong>：收集、清洗、标注和增强数据</li>
<li><strong>模型设计</strong>：选择合适的架构和初始参数</li>
<li><strong>训练过程</strong>：使用优化算法（如梯度下降）调整模型参数</li>
<li><strong>验证与测试</strong>：使用独立数据集评估模型性能</li>
<li><strong>部署与监控</strong>：将模型投入实际应用并持续监控性能</li>
</ol>
<h3 id="先进训练技术"><a href="#先进训练技术" class="headerlink" title="先进训练技术"></a>先进训练技术</h3><ol>
<li><p><strong>迁移学习</strong>：利用在一个任务上训练的知识来改进另一个相关任务的性能。</p>
</li>
<li><p><strong>微调</strong>：在预训练模型的基础上，使用特定任务的数据进行进一步训练。</p>
</li>
<li><p><strong>对比学习</strong>：让模型学习区分相似和不同的数据样本。</p>
</li>
<li><p><strong>强化学习与人类反馈（RLHF）</strong>：使用人类反馈来指导模型行为，提高模型输出的质量和安全性。</p>
</li>
</ol>
<h2 id="5-AI应用领域与开发工具"><a href="#5-AI应用领域与开发工具" class="headerlink" title="5. AI应用领域与开发工具"></a>5. AI应用领域与开发工具</h2><p><img src="/2025/03/04/what-is-AI/ai-components-relationship.svg" alt="alt text"></p>
<h3 id="这里有个我有些混淆的点，就是AI应用和AI-Agent区别，单独拎出来说下"><a href="#这里有个我有些混淆的点，就是AI应用和AI-Agent区别，单独拎出来说下" class="headerlink" title="这里有个我有些混淆的点，就是AI应用和AI Agent区别，单独拎出来说下:"></a>这里有个我有些混淆的点，就是AI应用和AI Agent区别，单独拎出来说下:</h3><h4 id="AI应用"><a href="#AI应用" class="headerlink" title="AI应用"></a>AI应用</h4><p>AI应用是指集成了AI技术的软件程序，通常为了解决特定问题或完成特定任务而设计：</p>
<ul>
<li><strong>功能范围</strong>：通常专注于一个或几个特定功能（如图像识别应用、语音转文本工具）</li>
<li><strong>交互方式</strong>：用户提出请求，应用直接响应</li>
<li><strong>自主性</strong>：有限，主要按照预设的方式运行</li>
<li><strong>例子</strong>：智能照片编辑器、语音助手、自动翻译工具</li>
</ul>
<h4 id="AI-Agent"><a href="#AI-Agent" class="headerlink" title="AI Agent"></a>AI Agent</h4><p>AI Agent是一种更高级的系统，能够感知环境、自主决策并采取行动实现目标的AI系统：</p>
<ul>
<li><strong>功能范围</strong>：能够执行多步骤任务，调用多种工具</li>
<li><strong>交互方式</strong>：可以理解用户意图，规划执行步骤，使用多种工具完成任务</li>
<li><strong>自主性</strong>：较高，能根据环境和反馈调整行动（反应能力、社交能力和主动性）</li>
<li><strong>例子</strong>：研究助手、客服代理、任务自动化</li>
</ul>
<h4 id="关键区别"><a href="#关键区别" class="headerlink" title="关键区别"></a>关键区别</h4><ol>
<li><p><strong>自主决策能力</strong>：</p>
<ul>
<li>AI应用：按预定路径执行</li>
<li>AI Agent：可以自行规划和决策如何完成任务</li>
</ul>
</li>
<li><p><strong>工具使用</strong>：</p>
<ul>
<li>AI应用：通常使用内置功能</li>
<li>AI Agent：可以调用多种外部工具和API</li>
</ul>
</li>
<li><p><strong>状态维护</strong>：</p>
<ul>
<li>AI应用：每次交互可能是独立的</li>
<li>AI Agent：维护对话或任务的状态，记住上下文</li>
</ul>
</li>
</ol>
<h4 id="在技术栈中的位置"><a href="#在技术栈中的位置" class="headerlink" title="在技术栈中的位置"></a>在技术栈中的位置</h4><p><img src="/2025/03/04/what-is-AI/ai-stack-hierarchy.svg" alt="alt text"></p>
<p>正如之前的图表所示，AI应用处于技术栈的顶层，可以包含AI Agent作为其组成部分，也可以是更简单的AI功能实现。而AI Agent通常建立在大语言模型之上，使用特定的Agent开发平台构建。</p>
<p>本质上，所有的AI Agent都是AI应用，但不是所有的AI应用都是Agent。AI Agent代表了更高级、更自主的AI应用形式。</p>
<h3 id="主流AI-Agent和应用开发平台"><a href="#主流AI-Agent和应用开发平台" class="headerlink" title="主流AI Agent和应用开发平台"></a>主流AI Agent和应用开发平台</h3><ul>
<li><p><strong>Dify</strong>：开源的LLM应用开发平台，提供可视化界面和API接口</p>
<ul>
<li>功能：知识库管理、对话应用创建、数据标注</li>
<li>适合：快速构建企业级AI助手和应用</li>
</ul>
</li>
<li><p><strong>Coze</strong>：微信团队开发的对话式AI平台</p>
<ul>
<li>功能：多场景机器人开发、无代码开发、多平台集成</li>
<li>适合：社交媒体和聊天平台的AI助手开发</li>
</ul>
</li>
<li><p><strong>LangChain</strong>：开源的大型语言模型应用开发框架</p>
<ul>
<li>功能：链式处理、代理（Agent）、知识库集成、工具调用</li>
<li>适合：开发者构建复杂的AI应用和工作流程</li>
</ul>
</li>
<li><p><strong>LlamaIndex</strong>：专注于数据连接和检索的框架</p>
<ul>
<li>功能：数据摄取、结构化、检索增强生成(RAG)</li>
<li>适合：构建与私有数据交互的应用</li>
</ul>
</li>
</ul>
<h3 id="自然语言处理应用"><a href="#自然语言处理应用" class="headerlink" title="自然语言处理应用"></a>自然语言处理应用</h3><ul>
<li><strong>聊天机器人与虚拟助手</strong>：如ChatGPT、Claude、Siri和小爱同学</li>
<li><strong>机器翻译</strong>：如谷歌翻译、DeepL</li>
<li><strong>文本摘要与生成</strong>：自动生成报告、文章和创意内容</li>
<li><strong>情感分析</strong>：分析社交媒体、评论的情感倾向</li>
</ul>
<h3 id="计算机视觉应用"><a href="#计算机视觉应用" class="headerlink" title="计算机视觉应用"></a>计算机视觉应用</h3><ul>
<li><strong>人脸识别</strong>：安防系统、手机解锁</li>
<li><strong>自动驾驶</strong>：感知环境、识别道路和障碍物</li>
<li><strong>医学影像分析</strong>：辅助诊断疾病</li>
<li><strong>增强现实（AR）</strong>：叠加虚拟信息到真实世界</li>
</ul>
<h3 id="其他重要应用"><a href="#其他重要应用" class="headerlink" title="其他重要应用"></a>其他重要应用</h3><ul>
<li><strong>推荐系统</strong>：个性化电商、音乐、视频推荐</li>
<li><strong>金融科技</strong>：风险评估、算法交易、欺诈检测</li>
<li><strong>智能制造</strong>：预测性维护、质量控制</li>
<li><strong>科学研究</strong>：药物发现、蛋白质折叠预测、气候模拟</li>
</ul>
<h2 id="6-生成式AI"><a href="#6-生成式AI" class="headerlink" title="6. 生成式AI"></a>6. 生成式AI</h2><h3 id="什么是生成式AI？"><a href="#什么是生成式AI？" class="headerlink" title="什么是生成式AI？"></a>什么是生成式AI？</h3><p>生成式AI是能够创建新内容的人工智能系统，包括文本、图像、音频、视频等。它不仅能回答问题，还能创作各种内容。</p>
<h3 id="文本生成"><a href="#文本生成" class="headerlink" title="文本生成"></a>文本生成</h3><p>大型语言模型（如GPT-4、Claude等）可以：</p>
<ul>
<li>撰写文章、故事和诗歌</li>
<li>创建对话和角色扮演</li>
<li>编写代码和技术文档</li>
<li>生成各种类型的商业内容</li>
</ul>
<h3 id="图像生成"><a href="#图像生成" class="headerlink" title="图像生成"></a>图像生成</h3><p>基于扩散模型的AI系统（如DALL-E、Midjourney、Stable Diffusion）能够：</p>
<ul>
<li>根据文本描述生成高质量图像</li>
<li>修改现有图像</li>
<li>创建艺术作品和商业设计</li>
<li>将草图转换为详细图像</li>
</ul>
<h3 id="音频与视频生成"><a href="#音频与视频生成" class="headerlink" title="音频与视频生成"></a>音频与视频生成</h3><ul>
<li><strong>AI语音合成</strong>：生成逼真的人工语音（如ElevenLabs）</li>
<li><strong>音乐生成</strong>：创作原创音乐（如Suno、MusicLM）</li>
<li><strong>视频生成</strong>：通过文本描述或图像创建视频（如Sora、Runway）</li>
</ul>
<h2 id="7-AI的伦理与挑战"><a href="#7-AI的伦理与挑战" class="headerlink" title="7. AI的伦理与挑战"></a>7. AI的伦理与挑战</h2><h3 id="伦理考量"><a href="#伦理考量" class="headerlink" title="伦理考量"></a>伦理考量</h3><ol>
<li><strong>偏见与公平性</strong>：模型可能继承训练数据中的偏见，导致不公平结果</li>
<li><strong>隐私问题</strong>：AI系统的训练和运行可能涉及敏感个人数据</li>
<li><strong>透明度与可解释性</strong>：深度学习模型通常被视为”黑盒”，难以解释决策过程</li>
<li><strong>自主性与责任</strong>：当AI系统做出决策时，谁应负责任？</li>
</ol>
<h3 id="技术挑战"><a href="#技术挑战" class="headerlink" title="技术挑战"></a>技术挑战</h3><ol>
<li><strong>数据质量与规模</strong>：高质量训练数据的获取与处理</li>
<li><strong>计算资源需求</strong>：大型模型训练需要大量计算资源</li>
<li><strong>鲁棒性问题</strong>：模型在遇到分布外数据时可能表现不佳</li>
<li><strong>安全与对抗性攻击</strong>：模型可能被精心设计的输入所欺骗</li>
</ol>
<h3 id="社会经济影响"><a href="#社会经济影响" class="headerlink" title="社会经济影响"></a>社会经济影响</h3><ol>
<li><strong>就业变化</strong>：自动化可能改变就业结构</li>
<li><strong>数字鸿沟</strong>：技术获取不平等可能加剧社会不平等</li>
<li><strong>教育转型</strong>：教育系统需要适应AI时代的技能需求</li>
<li><strong>信息真实性</strong>：生成式AI带来的深度伪造和虚假信息挑战</li>
</ol>
<h3 id="开源与AI民主化"><a href="#开源与AI民主化" class="headerlink" title="开源与AI民主化"></a>开源与AI民主化</h3><ol>
<li><p><strong>开源模型的崛起</strong>：</p>
<ul>
<li><strong>Llama系列</strong>：Meta发布的开源大型语言模型</li>
<li><strong>Mistral AI</strong>：欧洲初创公司开发的高性能开源模型</li>
<li><strong>Stability AI</strong>：开源图像生成模型的领先开发者</li>
</ul>
</li>
<li><p><strong>本地部署与私有化</strong>：</p>
<ul>
<li><strong>轻量级模型</strong>：适合在消费级硬件上运行的小型模型</li>
<li><strong>边缘计算</strong>：将AI能力部署到终端设备</li>
<li><strong>隐私优先</strong>：不依赖云服务的AI解决方案</li>
</ul>
</li>
</ol>
<h3 id="应用前景"><a href="#应用前景" class="headerlink" title="应用前景"></a>应用前景</h3><ol>
<li><p><strong>医疗健康</strong>：个性化医疗、疾病预测、药物发现加速</p>
</li>
<li><p><strong>气候变化</strong>：优化能源使用、气候模型、环保解决方案</p>
</li>
<li><p><strong>教育革新</strong>：个性化学习体验、智能辅导系统</p>
</li>
<li><p><strong>太空探索</strong>：自主探测器、数据分析、任务规划</p>
</li>
</ol>
<h3 id="AI与人类协作"><a href="#AI与人类协作" class="headerlink" title="AI与人类协作"></a>AI与人类协作</h3><p>未来，最成功的场景很可能是人类与AI协作，而非完全替代：</p>
<ul>
<li><strong>增强人类能力</strong>：AI作为工具，扩展人类的认知和创造能力</li>
<li><strong>互补优势</strong>：AI处理数据密集型和重复性任务，人类提供创造力、情感和道德判断</li>
<li><strong>共同演进</strong>：人类与AI技术相互适应，形成新的工作和生活方式</li>
</ul>
<h2 id="8-如何入门AI学习"><a href="#8-如何入门AI学习" class="headerlink" title="8. 如何入门AI学习"></a>8. 如何入门AI学习</h2><h3 id="基础知识准备"><a href="#基础知识准备" class="headerlink" title="基础知识准备"></a>基础知识准备</h3><ul>
<li><strong>数学基础</strong>：线性代数、微积分、概率与统计</li>
<li><strong>编程技能</strong>：Python是AI领域最流行的语言</li>
<li><strong>计算机科学基础</strong>：算法、数据结构、计算复杂性</li>
</ul>
<h3 id="推荐资源"><a href="#推荐资源" class="headerlink" title="推荐资源"></a>推荐资源</h3><ul>
<li><strong>在线课程</strong>：吴恩达的机器学习课程、Fast.ai、Coursera和Udacity的AI课程</li>
<li><strong>书籍</strong>：《深度学习》(Ian Goodfellow)、《动手学深度学习》(李沐)</li>
<li><strong>实践平台</strong>：Google Colab、Kaggle、Hugging Face</li>
<li><strong>社区</strong>：GitHub、Stack Overflow、AI相关的学术会议和讲座</li>
<li><strong>文章或视频</strong>：<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BEiha9L_FZ0hvUuAGzLCWw">科技爱好者周刊#330：李开复梳理人工智能</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=qYNweeDHiyU">AI, Machine Learning, Deep Learning and Generative AI Explained</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/think/topics/ai-agents?utm_medium=OSocial&utm_source=Youtube&utm_content=WAIWW&utm_id=YT-201-Build-a-MCP">what is AI Agents</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=F8NKVhkZZWI">what is AI Agents</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=T-D1OfcDW1M">what is RAG</a></li>
</ul>
</li>
</ul>
<h2 id="9-结语"><a href="#9-结语" class="headerlink" title="9. 结语"></a>9. 结语</h2><p>人工智能正在以前所未有的速度发展，从改变我们日常使用的应用程序到推动科学研究的前沿。无论你是对AI好奇的初学者，还是寻求深入了解的专业人士，了解AI的基本概念、技术和趋势都至关重要。</p>
<p>AI并非遥不可及的未来技术，而是已经深入我们生活的工具和伙伴。通过积极学习和理性看待，我们可以更好地利用AI的力量，同时规避潜在风险，共同创造一个技术与人文平衡发展的未来。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2025/03/04/Prompt-Engineering/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/04/Prompt-Engineering/" class="post-title-link" itemprop="url">Prompt Engineering</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-03-04 11:11:01" itemprop="dateCreated datePublished" datetime="2025-03-04T11:11:01+08:00">2025-03-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="ai-tag">AI</span>
  <span class="sub-tag">第一篇</span>
</div>
# 从0到1学好Prompt Engineering的完全指南

<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>最近准备面试嘛，看到好些JD里，特别是关于大模型的JD，里面有个技能要求Prompt Engineering。刚好我也有兴趣，平时也是claude.ai和chatgpt、deepseek的重度用户，美元都花了好些，问题问的多了，慢慢的知道问题描述的准确性与预期的答案相关性确实很大。确实感觉Prompt Engineering（提示词工程）已经成为一项重要技能。无论你是开发者、内容创作者还是普通用户，掌握这项技能都能帮助你更有效地与AI交流，获得更满意的结果。刚好借此JD机会，更深入的学习下怎么才能写好Prompt。</p>
<h2 id="什么是Prompt-Engineering？"><a href="#什么是Prompt-Engineering？" class="headerlink" title="什么是Prompt Engineering？"></a>什么是Prompt Engineering？</h2><h3 id="基本概念解释"><a href="#基本概念解释" class="headerlink" title="基本概念解释"></a>基本概念解释</h3><p>Prompt Engineering是指设计和优化输入到AI模型（如ChatGPT、Claude等）的提示词的过程，目的是引导AI生成更准确、更符合预期的输出内容。</p>
<p>简单来说，就像我们与人交流时，清晰表达自己的需求会得到更好的回应一样，与AI的交流也需要”说人话”，而Prompt Engineering就是学习如何更好地”对AI说话”的艺术。</p>
<h3 id="为什么Prompt-Engineering很重要？"><a href="#为什么Prompt-Engineering很重要？" class="headerlink" title="为什么Prompt Engineering很重要？"></a>为什么Prompt Engineering很重要？</h3><ul>
<li><strong>节省时间</strong>：好的提示词能直接获得理想结果，减少反复尝试的时间</li>
<li><strong>提高质量</strong>：精心设计的提示词能显著提升AI输出的质量和准确度</li>
<li><strong>解锁潜能</strong>：掌握高级技巧后，你可以让AI完成更复杂的任务</li>
</ul>
<h2 id="Prompt-Engineering的基础知识"><a href="#Prompt-Engineering的基础知识" class="headerlink" title="Prompt Engineering的基础知识"></a>Prompt Engineering的基础知识</h2><h3 id="提示词的基本结构"><a href="#提示词的基本结构" class="headerlink" title="提示词的基本结构"></a>提示词的基本结构</h3><p>一个好的提示词通常包含以下几个要素：</p>
<ol>
<li><strong>明确的指令</strong>：清楚地告诉AI你想要它做什么</li>
<li><strong>上下文信息</strong>：提供必要的背景知识</li>
<li><strong>输入数据</strong>：需要AI处理的具体内容</li>
<li><strong>输出格式</strong>：期望AI如何组织和呈现结果</li>
</ol>
<h3 id="简单例子对比"><a href="#简单例子对比" class="headerlink" title="简单例子对比"></a>简单例子对比</h3><p><strong>不好的提示词</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">写一篇关于AI的科普文章</span><br></pre></td></tr></table></figure>

<p><strong>好的提示词</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请写一篇800字左右的科普文章，主题是&quot;人工智能的发展历程&quot;，适合完全不动技术的人阅读，包含三个主要发展阶段，使用生动的比喻和案例解释专业概念，并在结尾提出对未来的展望。</span><br></pre></td></tr></table></figure>

<h2 id="提升Prompt效果的核心技巧"><a href="#提升Prompt效果的核心技巧" class="headerlink" title="提升Prompt效果的核心技巧"></a>提升Prompt效果的核心技巧</h2><h3 id="1-清晰具体"><a href="#1-清晰具体" class="headerlink" title="1. 清晰具体"></a>1. 清晰具体</h3><p>越具体的提示词越能得到准确的回答。包括具体描述：</p>
<ul>
<li>所需输出的长度（字数&#x2F;段落数）</li>
<li>目标受众（专业水平&#x2F;年龄段）</li>
<li>风格（正式&#x2F;轻松&#x2F;创意）</li>
<li>结构（要点&#x2F;段落&#x2F;表格）</li>
</ul>
<p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请用简单的语言向我10岁女儿解释光合作用，不超过200字，使用至少2个生活中的比喻，避免使用专业术语。</span><br></pre></td></tr></table></figure>

<h3 id="2-提供示例（少样本学习）"><a href="#2-提供示例（少样本学习）" class="headerlink" title="2. 提供示例（少样本学习）"></a>2. 提供示例（少样本学习）</h3><p>通过提供几个输入-输出的示例，可以更好地引导AI理解你的期望。</p>
<p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">请按照以下格式将这些句子翻译成英文：</span><br><span class="line"></span><br><span class="line">中文：我喜欢吃苹果。</span><br><span class="line">英文：I like to eat apples.</span><br><span class="line"></span><br><span class="line">中文：明天我要去北京旅游。</span><br><span class="line">英文：I will travel to Beijing tomorrow.</span><br><span class="line"></span><br><span class="line">中文：这本书很有趣，我想推荐给你。</span><br><span class="line">英文：</span><br></pre></td></tr></table></figure>

<h3 id="3-角色设定"><a href="#3-角色设定" class="headerlink" title="3. 角色设定"></a>3. 角色设定</h3><p>让AI扮演特定角色，能使回答更符合特定专业或风格需求。</p>
<p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请你扮演一位经验丰富的营销专家，分析我的产品定位问题，并提供改进建议。我的产品是一款...</span><br></pre></td></tr></table></figure>

<h3 id="4-分步骤思考"><a href="#4-分步骤思考" class="headerlink" title="4. 分步骤思考"></a>4. 分步骤思考</h3><p>引导AI一步步思考问题，可以获得更准确的结果，特别是对于复杂问题。</p>
<p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">请帮我解决这个数学问题，在回答前，请先分析问题，列出已知条件，然后逐步推导求解过程，最后给出结论。</span><br><span class="line"></span><br><span class="line">问题：一个圆柱形水箱，底面积为3平方米，高为2米。现在水箱中有水，深度为1.5米。如果以每分钟0.1立方米的速度向水箱中注水，需要多少分钟才能将水箱装满？</span><br></pre></td></tr></table></figure>

<h3 id="5-指定输出格式"><a href="#5-指定输出格式" class="headerlink" title="5. 指定输出格式"></a>5. 指定输出格式</h3><p>明确要求特定的输出格式，使结果更易于使用。</p>
<p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">请分析这家公司的优势和劣势，并以下面的JSON格式输出结果：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;公司名称&quot;: &quot;XX科技&quot;,</span><br><span class="line">  &quot;优势&quot;: [&quot;优势1&quot;, &quot;优势2&quot;, &quot;优势3&quot;],</span><br><span class="line">  &quot;劣势&quot;: [&quot;劣势1&quot;, &quot;劣势2&quot;, &quot;劣势3&quot;],</span><br><span class="line">  &quot;改进建议&quot;: [&quot;建议1&quot;, &quot;建议2&quot;, &quot;建议3&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="进阶技巧"><a href="#进阶技巧" class="headerlink" title="进阶技巧"></a>进阶技巧</h2><h3 id="链式思维（Chain-of-Thought）"><a href="#链式思维（Chain-of-Thought）" class="headerlink" title="链式思维（Chain-of-Thought）"></a>链式思维（Chain-of-Thought）</h3><p>引导AI展示其思考过程，对于复杂推理特别有效。</p>
<p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">问题：小明有12个苹果，他给了小红3个，又给了小李他手中苹果数量的一半，最后他还剩下多少个苹果？请一步一步地思考，解释每一步的计算过程和原因。</span><br></pre></td></tr></table></figure>

<h3 id="思维树（Tree-of-Thoughts）"><a href="#思维树（Tree-of-Thoughts）" class="headerlink" title="思维树（Tree of Thoughts）"></a>思维树（Tree of Thoughts）</h3><p>引导AI探索多种可能性和解决方案路径。</p>
<p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请用思维树的方式分析我创业的三个不同选择（开咖啡店、做在线教育、开发APP），每个选择探索三个可能的发展路径，考虑不同条件下的结果，然后总结最优选择。</span><br></pre></td></tr></table></figure>

<h3 id="自我评估和修正"><a href="#自我评估和修正" class="headerlink" title="自我评估和修正"></a>自我评估和修正</h3><p>让AI评估自己的输出并进行改进。</p>
<p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请写一篇关于气候变化的短文，然后评估这篇文章的优缺点，并基于评估给出一个改进版本。</span><br></pre></td></tr></table></figure>

<h2 id="常见应用场景实战"><a href="#常见应用场景实战" class="headerlink" title="常见应用场景实战"></a>常见应用场景实战</h2><h3 id="内容创作"><a href="#内容创作" class="headerlink" title="内容创作"></a>内容创作</h3><h4 id="写作辅助"><a href="#写作辅助" class="headerlink" title="写作辅助"></a>写作辅助</h4><p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请为我的科技博客生成一篇文章大纲，主题是&quot;5G技术如何改变我们的生活&quot;。大纲应包含引言、3-5个主要部分、每部分2-3个小节，以及结论。每个小节都需要有简短描述。</span><br></pre></td></tr></table></figure>

<h4 id="创意生成"><a href="#创意生成" class="headerlink" title="创意生成"></a>创意生成</h4><p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我正在设计一个以&quot;海洋保护&quot;为主题的儿童故事书。请创作5个可能的故事情节，每个情节包含主角描述、基本冲突和教育意义。</span><br></pre></td></tr></table></figure>

<h3 id="数据分析与处理"><a href="#数据分析与处理" class="headerlink" title="数据分析与处理"></a>数据分析与处理</h3><p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我有一组销售数据，包含产品名称、月份和销售额。请帮我分析这些数据，找出销售趋势，并提出改进建议。数据如下：</span><br><span class="line">[数据内容]</span><br></pre></td></tr></table></figure>

<h3 id="代码辅助"><a href="#代码辅助" class="headerlink" title="代码辅助"></a>代码辅助</h3><p><strong>例子</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请编写一个Python函数，用于分析文本情感倾向。函数应接受一段文本作为输入，返回积极、消极或中性的评价以及置信度分数。请包含必要的注释和简单的使用示例。</span><br></pre></td></tr></table></figure>

<h2 id="常见问题与解决方法"><a href="#常见问题与解决方法" class="headerlink" title="常见问题与解决方法"></a>常见问题与解决方法</h2><h3 id="如何处理AI回答过于笼统或离题？"><a href="#如何处理AI回答过于笼统或离题？" class="headerlink" title="如何处理AI回答过于笼统或离题？"></a>如何处理AI回答过于笼统或离题？</h3><ul>
<li><strong>解决方法</strong>：增加具体细节，使用引导性问题，明确输出要求</li>
<li><strong>例子</strong>：原提示”谈谈人工智能的未来”可改为”请从就业、教育和伦理三个方面，具体分析人工智能在未来10年可能带来的社会变革。每个方面请提供至少两个具体的预测和可能的应对策略。”</li>
</ul>
<h3 id="如何避免AI生成的内容过于冗长？"><a href="#如何避免AI生成的内容过于冗长？" class="headerlink" title="如何避免AI生成的内容过于冗长？"></a>如何避免AI生成的内容过于冗长？</h3><ul>
<li><strong>解决方法</strong>：明确字数限制，要求简洁回答，指定重点内容</li>
<li><strong>例子</strong>：”请用不超过300字，总结量子计算的核心原理，重点解释量子比特和量子纠缠这两个概念。”</li>
</ul>
<h3 id="如何使AI生成更创新性的内容？"><a href="#如何使AI生成更创新性的内容？" class="headerlink" title="如何使AI生成更创新性的内容？"></a>如何使AI生成更创新性的内容？</h3><ul>
<li><strong>解决方法</strong>：明确要求原创思路，设置情景约束，激励思维发散</li>
<li><strong>例子</strong>：”请提出5种从未出现过的智能家居产品创意，每种产品都需要融合至少两种现有技术，并解决一个特定的家庭难题。”</li>
</ul>
<h3 id="免费学习资源"><a href="#免费学习资源" class="headerlink" title="免费学习资源"></a>免费学习资源</h3><ol>
<li><p><strong>免费课程与教程</strong></p>
<ul>
<li>OpenAI的Prompt Engineering指南 (官网免费提供)</li>
<li>李宏毅教授的”Large Language Model”课程 (YouTube完整课程)</li>
<li>Khan Academy的AI基础知识 (免费教育平台)</li>
<li>Hugging Face的NLP教程 (官方文档免费)</li>
<li>Coursera上的免费AI课程 (可以免费旁听)</li>
</ul>
</li>
<li><p><strong>免费电子书与指南</strong></p>
<ul>
<li>《Prompt Engineering Guide》by Lilian Weng (在线免费阅读)</li>
<li>Dair.ai的Prompt Engineering Guide (GitHub上免费)</li>
<li>Github上的awesome-chatgpt-prompts开源仓库</li>
<li>OpenAI官方的最佳实践指南</li>
</ul>
</li>
<li><p><strong>免费在线社区与资源</strong></p>
<ul>
<li>GitHub上的Prompt Engineering资源库</li>
<li>Reddit的r&#x2F;PromptEngineering社区</li>
<li>Discord的公开AI社区讨论组</li>
</ul>
</li>
<li><p><strong>免费网站</strong></p>
<ul>
<li>​免费课程：DeepLearning.AI 的《ChatGPT Prompt Engineering for Developers》</li>
<li>​工具包：LangChain 的 Prompt 模板库、Promptify（开源 Prompt 工具）</li>
<li>​论文库：Papers with Code 中搜索 “Prompt Engineering”</li>
<li><a target="_blank" rel="noopener" href="https://promptperfect.jina.ai/">https://promptperfect.jina.ai/</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.deeplearning.ai/">https://learn.deeplearning.ai/</a></li>
<li><a target="_blank" rel="noopener" href="https://paperswithcode.com/paper/chain-of-thought-prompting-elicits-reasoning">https://paperswithcode.com/paper/chain-of-thought-prompting-elicits-reasoning</a></li>
<li><a target="_blank" rel="noopener" href="https://promptbase.com/">https://promptbase.com/</a></li>
</ul>
</li>
</ol>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Prompt Engineering不仅是一项技术技能，更是一门艺术。通过不断实践和调整，你会发现与AI交流的效率和质量都会显著提升。记住，最好的学习方式是实践——从今天开始尝试这些技巧，记录效果，持续改进。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2025/02/22/%E5%B7%A5%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/22/%E5%B7%A5%E4%BD%9C/" class="post-title-link" itemprop="url">Java开发工程师、全栈开发工程师</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-02-22 19:31:46" itemprop="dateCreated datePublished" datetime="2025-02-22T19:31:46+08:00">2025-02-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Java开发工程师、全栈开发工程师"><a href="#Java开发工程师、全栈开发工程师" class="headerlink" title="Java开发工程师、全栈开发工程师"></a>Java开发工程师、全栈开发工程师</h3><p>亲爱的招聘团队：</p>
<p>如果软件工程师是一道菜，那我就是那种经过12年慢火熬制的老汤底——看起来平淡无奇，但一尝就知道功夫在里头。</p>
<p>我的技术栈就像一个资深玩家的技能树：主技能点满了Java和React，副技能解锁了Vue、Docker、Python和Go等。在我的职业旅程中，我善于将复杂问题分解为简单模块，轻松应对各种技术挑战。但我最厉害的外挂其实是曾经当过产品助理——这让我不仅能听懂产品经理说的”简单调整”背后隐藏的36个子需求，还能在技术与业务之间自如翻译，堪称”产品语言通”。</p>
<p>在我的12年职业生涯中，我从”这bug在本地没问题啊”进化到了”这需求有啥实际意义”再到”好的，我来搞定！”。带团队的经历让我明白，比起Debug代码，Debug人际关系才是真正的高难度挑战。所幸，我在这两方面都交出了不错的成绩单。</p>
<p>相信我的技术能力、产品思维和团队协作经验能为您的团队带来实质性的贡献。代码之外，我能够搭建开发者与产品、业务之间的桥梁，确保我们不只是在开发功能，而是在创造价值。我们一定能擦出技术的火花——毕竟，一个能理解产品、带过团队、写了12年代码还没秃顶的工程师，不是每天都能遇到的。</p>
<p>代码问候，<br>[软件开发特种兵]</p>
<p>联系方式：<br>电话：[18515068121]<br>邮箱：[<a href="mailto:&#x67;&#97;&#x6d;&#x65;&#104;&#117;&#64;&#121;&#x65;&#97;&#104;&#46;&#110;&#x65;&#116;">&#x67;&#97;&#x6d;&#x65;&#104;&#117;&#64;&#121;&#x65;&#97;&#104;&#46;&#110;&#x65;&#116;</a>]<br>Wechat：[GamehuDB]</p>
<p>P.S. 我的GitHub贡献图可能不够绿，但我的生产环境代码从不让服务器变红。</p>
<h3 id="Java-Development-Engineer-x2F-Full-Stack-Development-Engineer"><a href="#Java-Development-Engineer-x2F-Full-Stack-Development-Engineer" class="headerlink" title="Java Development Engineer&#x2F;Full Stack Development Engineer"></a>Java Development Engineer&#x2F;Full Stack Development Engineer</h3><p>Dear Hiring Team:</p>
<p>If software engineers were dishes, I’d be that slow-simmered stock that’s been cooking for 12 years — looking unassuming, but one taste reveals the expertise within.</p>
<p>My tech stack resembles a veteran player’s skill tree: maxed-out primary skills in Java and React, with unlocked secondary abilities in Vue, Docker, Python, Go, and more. Throughout my professional journey, I’ve honed the ability to break complex problems into simple modules, easily tackling various technical challenges. But my most powerful perk comes from my experience as a product assistant — I can decode the 36 hidden sub-requirements behind a product manager’s “simple adjustment” and fluently translate between technical and business languages, making me a true “product whisperer.”</p>
<p>During my 12-year career, I’ve evolved from “but the bug doesn’t appear on my local machine” to “what’s the actual purpose of this requirement” to “I’ll handle it!” My team leadership experience taught me that debugging human relationships is far more challenging than debugging code. Fortunately, I’ve managed to achieve good results in both areas.</p>
<p>I believe my technical abilities, product mindset, and team collaboration experience will bring substantial value to your team. Beyond coding, I can build bridges between developers, product teams, and business units, ensuring we’re not just developing features but creating value. We’ll definitely create technical sparks together — after all, an engineer who understands products, has led teams, and has written code for 12 years without going bald isn’t someone you meet every day.</p>
<p>Code regards,<br>[Software Development Special Forces]</p>
<p>Contact Information:<br>twitter：[Gamehu520]<br>email：[<a href="mailto:&#x67;&#97;&#x6d;&#x65;&#104;&#x75;&#x40;&#121;&#101;&#97;&#104;&#x2e;&#x6e;&#x65;&#x74;">&#x67;&#97;&#x6d;&#x65;&#104;&#x75;&#x40;&#121;&#101;&#97;&#104;&#x2e;&#x6e;&#x65;&#x74;</a>]<br>Wechat：[GamehuDB]</p>
<p>P.S. My GitHub contribution graph might not be very green, but my production code never turns servers red.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2025/01/01/MCP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/01/01/MCP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">MCP协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-01-01 21:57:02" itemprop="dateCreated datePublished" datetime="2025-01-01T21:57:02+08:00">2025-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">学习</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="ai-tag">AI</span>
  <span class="sub-tag">第二篇</span>
</div>

<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>知道MCP还是源于因为之前验证<a href="/2024/12/23/AI%E5%BA%94%E7%94%A8%E5%B0%9D%E9%B2%9C/" title="AI应用尝鲜">AI应用尝鲜</a>时了解到的。因为当时后续计划做AI应用，增加saas平台的噱头的同时成为一个亮点功能，提升用户体验。</p>
<h1 id="基础概念与架构设计"><a href="#基础概念与架构设计" class="headerlink" title="基础概念与架构设计"></a>基础概念与架构设计</h1><p>MCP是一个开放协议，它标准化了应用程序如何向大语言模型（LLMs）提供上下文。可以将MCP比作AI应用的USB-C接口。正如USB-C提供了一种标准化的方式，将你的设备连接到各种外围设备和配件，MCP 也提供了一种标准化的方式，将AI模型连接到不同的数据源和工具。</p>
<h2 id="一、协议本质解构"><a href="#一、协议本质解构" class="headerlink" title="一、协议本质解构"></a>一、协议本质解构</h2><p>MCP是一种<strong>客户端-服务器架构的数据访问协议</strong>，专为AI应用（如大语言模型）设计，其核心是为AI应用提供一种标准化方式来安全访问多种数据源。</p>
<p><strong>关键组件</strong></p>
<ol>
<li>MCP 主机：运行AI应用并发起数据请求，如聊天应用或IDE</li>
<li>MCP 客户端：处理与 MCP 服务器的通信</li>
<li>MCP 服务器：连接到各种数据源的轻量级程序</li>
<li>大型语言模型(LLM)：分析问题并选择回答的 AI 模型</li>
<li>数据源：包括数据库、外部 API 等</li>
</ol>
<p>MCP采用简洁的JSON格式进行通信，主要支持两类基本操作：</p>
<ul>
<li><strong>发现操作</strong>：客户端识别服务器提供的能力</li>
<li><strong>执行操作</strong>：请求服务器执行特定工具来访问数据</li>
</ul>
<h2 id="二、核心作用剖析"><a href="#二、核心作用剖析" class="headerlink" title="二、核心作用剖析"></a>二、核心作用剖析</h2><ol>
<li><p><strong>访问标准化</strong></p>
<ul>
<li>为不同类型的数据源提供统一的访问接口</li>
<li>客户端无需了解每个数据源的具体访问细节</li>
</ul>
</li>
<li><p><strong>安全控制</strong></p>
<ul>
<li>服务器明确声明其访问能力和权限范围</li>
<li>支持基本的认证和授权机制</li>
<li>客户端可以限制服务器的访问范围</li>
</ul>
</li>
<li><p><strong>工具扩展性</strong></p>
<ul>
<li>服务器可以动态注册和提供各种工具</li>
<li>客户端可以发现并使用这些工具</li>
<li>支持从简单的文件读取到复杂的API调用等多种操作</li>
</ul>
</li>
</ol>
<h2 id="三、基本工作流程"><a href="#三、基本工作流程" class="headerlink" title="三、基本工作流程"></a>三、基本工作流程</h2><h3 id="MCP的典型工作流程如下：内部实现可能会有多次循环"><a href="#MCP的典型工作流程如下：内部实现可能会有多次循环" class="headerlink" title="MCP的典型工作流程如下：内部实现可能会有多次循环"></a>MCP的典型工作流程如下：内部实现可能会有多次循环</h3><p><img src="/2025/01/01/MCP%E5%8D%8F%E8%AE%AE/2.png" alt="alt text"><br>大体流程如下：</p>
<ol>
<li>用户向 MCP 主机（如聊天应用或 IDE）提出问题</li>
<li>主机将问题发送给大型语言模型(LLM)进行分析</li>
<li>LLM 确定需要使用哪些工具来回答问题</li>
<li>主机通过 MCP 客户端请求执行相应工具</li>
<li>MCP 客户端向不同的 MCP 服务器发送工具执行请求</li>
<li>MCP 服务器访问相应的数据源（数据库或外部 API）</li>
<li>数据源返回结果给 MCP 服务器，再传回客户端</li>
<li>MCP 客户端汇总工具执行结果并返回给主机</li>
<li>主机将工具结果发送给 LLM 生成最终回答</li>
<li>最终回答显示给用户</li>
</ol>
<h2 id="四、现实应用场景"><a href="#四、现实应用场景" class="headerlink" title="四、现实应用场景"></a>四、现实应用场景</h2><p>MCP适用于以下典型场景：</p>
<ol>
<li><p><strong>增强型AI聊天应用</strong></p>
<ul>
<li>让聊天机器人能够访问用户本地文件和数据库</li>
<li>使AI可以获取并引用真实、最新的信息</li>
</ul>
</li>
<li><p><strong>智能开发工具</strong></p>
<ul>
<li>IDE中的代码助手可以访问项目代码文件</li>
<li>辅助工具可以查询API文档和相关资源</li>
</ul>
</li>
<li><p><strong>企业AI集成</strong></p>
<ul>
<li>让AI应用安全地访问企业内部数据</li>
<li>在保护敏感信息的同时提供个性化服务</li>
</ul>
</li>
</ol>
<h2 id="五、协议现状与局限"><a href="#五、协议现状与局限" class="headerlink" title="五、协议现状与局限"></a>五、协议现状与局限</h2><p>当前MCP协议的特点与局限：</p>
<ol>
<li><p><strong>简洁性优先</strong></p>
<ul>
<li>协议设计相对简单，专注于解决基本的数据访问问题</li>
<li>尚未包含复杂的加密、动态路由等高级功能</li>
</ul>
</li>
<li><p><strong>开发阶段</strong></p>
<ul>
<li>协议仍在发展中，标准可能会随时间演进</li>
<li>生态系统正在逐步构建</li>
</ul>
</li>
<li><p><strong>基础功能聚焦</strong></p>
<ul>
<li>当前主要聚焦于基础的数据访问能力</li>
<li>缺乏高级的事务处理、分布式一致性等特性</li>
</ul>
</li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>MCP代表了AI工具与数据源之间交互的一个重要标准化尝试。它为构建能够访问和利用各种数据的AI应用提供了基础架构，虽然相对简单，但解决了AI应用难以安全访问多样化数据的关键问题。随着协议的发展，MCP有潜力成为AI应用与数据源之间交互的重要标准，类似于HTTP对于web应用的意义。</p>
<p>但是目前MCP仍处于相对早期阶段，其真正的潜力和影响力将随着更多实现和应用的出现而逐步显现。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.anthropic.com/news/model-context-protocol">https://www.anthropic.com/news/model-context-protocol</a><br><a target="_blank" rel="noopener" href="https://github.com/modelcontextprotocol">https://github.com/modelcontextprotocol</a><br><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/introduction">https://modelcontextprotocol.io/introduction</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=sahuZMMXNpI">https://www.youtube.com/watch?v=sahuZMMXNpI</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=eur8dUO9mvE">https://www.youtube.com/watch?v=eur8dUO9mvE</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=kQmXtrmQ5Zg&t=2s">https://www.youtube.com/watch?v=kQmXtrmQ5Zg&amp;t=2s</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/12/29/resume/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/12/29/resume/" class="post-title-link" itemprop="url">简历模板</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-12-29 22:19:00" itemprop="dateCreated datePublished" datetime="2024-12-29T22:19:00+08:00">2024-12-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AA%E4%BA%BA/" itemprop="url" rel="index"><span itemprop="name">个人</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="main-tag">离职系列</span>
  <span class="sub-tag">第N篇</span>
</div>
<div class="article-quote">
离职前一天，想想简历咋写，弄个排版出来，后续好造着整理下简历。纯属个人意见。我先自己试试，不好用再改。
</div>

<h2 id="我的观点"><a href="#我的观点" class="headerlink" title="我的观点"></a>我的观点</h2><p>我觉得简历的本质是为了筛选而不是为了深入了解你。所以我认为简历：</p>
<ol>
<li>首先得清爽。</li>
<li>然后得简明扼要。</li>
</ol>
<p>不用写太多同时又能体现关键信息，就跟咱们做程序一样，设计时重点之一就是数据得便于各场景使用，便于使用很大的一个方面就是数据能各种过滤和组合，通常是现有简明的入口，如果要了解细节就得下钻，可能是一层或多层才能看透数据。那简历就像入口，如果对方有兴趣才会下钻，所以不应该想着一个简历就把自己交代的底裤都没有，一方面是内容太多不容易抓到重点，另一方面是太细了搞得人都没欲望深入探讨，咋约你面试呢？</p>
<p>所以简历得像咱们对待产品需求一样，你得解决需求场景同时兼顾一些扩展性。抽象出来一个模板适配通用场景，然后可根据具体特殊场景，再保证真实的前提下做一些微调，对其JD中的要求。</p>
<hr>

<h1 id="抽象了一个通用模板如下："><a href="#抽象了一个通用模板如下：" class="headerlink" title="抽象了一个通用模板如下："></a><span style='color:red;'>抽象了一个通用模板如下：</span></h1><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><ul>
<li>求职意向：技术负责人&#x2F;技术专家</li>
<li>工作年限：8年+</li>
<li>学历：xx</li>
<li>电话：xx</li>
<li>期望薪资：xx</li>
</ul>
<h2 id="专业技能"><a href="#专业技能" class="headerlink" title="专业技能"></a>专业技能</h2><h3 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h3><ul>
<li>后端：Java、Spring Boot、Spring Cloud、MySQL、Redis、消息队列</li>
<li>前端：React、TypeScript、Ant Design、Redux、Webpack</li>
<li>DevOps：Docker、Jenkins、Git、Jira</li>
<li>架构：微服务架构、前后端分离、分布式系统设计</li>
</ul>
<h3 id="管理能力"><a href="#管理能力" class="headerlink" title="管理能力"></a>管理能力</h3><ul>
<li>团队管理：带领3-6人团队，完成项目全周期开发</li>
<li>技术规划：制定技术方案，把控技术方向，推动技术创新</li>
<li>敏捷实践：推行敏捷开发，提升团队效能</li>
<li>人才培养：建立技术培训体系，提升团队技术能力</li>
</ul>
<h2 id="工作经历"><a href="#工作经历" class="headerlink" title="工作经历"></a>工作经历</h2><h3 id="XX公司（2021-至今）"><a href="#XX公司（2021-至今）" class="headerlink" title="XX公司（2021-至今）"></a>XX公司（2021-至今）</h3><p>职位：技术负责人</p>
<p>负责工作：</p>
<ol>
<li><p>带领5-6人团队完成大型LLM应用平台开发，实现从0到1</p>
<ul>
<li>设计并实现基于微服务架构的系统框架</li>
<li>优化系统性能，提升用户体验</li>
<li>建立代码规范和技术文档体系</li>
<li>系统月活用户达到10w+，支持高并发访问</li>
</ul>
</li>
<li><p>技术架构升级与优化</p>
<ul>
<li>推动系统微服务化改造，提升系统可扩展性</li>
<li>实现核心模块性能优化，接口响应时间提升50%</li>
<li>建立监控告警体系，提高系统稳定性</li>
</ul>
</li>
</ol>
<h3 id="XX公司（2019-2021）"><a href="#XX公司（2019-2021）" class="headerlink" title="XX公司（2019-2021）"></a>XX公司（2019-2021）</h3><p>职位：Web前端负责人</p>
<p>负责工作：</p>
<ol>
<li><p>带领3-4人前端团队完成企业级SaaS平台开发</p>
<ul>
<li>基于React技术栈搭建前端框架</li>
<li>实现组件库设计与开发</li>
<li>推动前端工程化建设</li>
<li>平台服务企业客户100+</li>
</ul>
</li>
<li><p>技术改进与创新</p>
<ul>
<li>建立前端性能监控体系</li>
<li>推动前端自动化测试实践</li>
<li>优化构建流程，部署时间缩短60%<br>…</li>
</ul>
</li>
</ol>
<h2 id="项目经验"><a href="#项目经验" class="headerlink" title="项目经验"></a>项目经验</h2><h3 id="xx平台（2022-2023）"><a href="#xx平台（2022-2023）" class="headerlink" title="xx平台（2022-2023）"></a>xx平台（2022-2023）</h3><ul>
<li>项目规模：5-6人团队，服务10w+用户</li>
<li>技术架构：Spring Cloud + React + MySQL + Redis</li>
<li>主要职责：<ul>
<li>负责整体技术方案设计</li>
<li>核心功能开发与性能优化</li>
<li>带领团队完成开发任务</li>
</ul>
</li>
<li>项目成就：<ul>
<li>系统支持高并发访问，峰值QPS 5000+</li>
<li>用户响应时间&lt;500ms</li>
<li>系统可用性达99.9%</li>
</ul>
</li>
</ul>
<h3 id="xx企业级SaaS平台（2019-2021）"><a href="#xx企业级SaaS平台（2019-2021）" class="headerlink" title="xx企业级SaaS平台（2019-2021）"></a>xx企业级SaaS平台（2019-2021）</h3><ul>
<li>项目规模：前端3-4人团队</li>
<li>技术架构：React + TypeScript + Ant Design</li>
<li>主要职责：<ul>
<li>前端架构设计与实现</li>
<li>团队管理与技术指导</li>
<li>核心功能开发</li>
</ul>
</li>
<li>项目成就：<ul>
<li>平台月活用户5w+</li>
<li>前端性能提升40%</li>
<li>客户满意度95%+</li>
</ul>
</li>
</ul>
<h2 id="教育背景"><a href="#教育背景" class="headerlink" title="教育背景"></a>教育背景</h2><ul>
<li>XX大学 计算机科学与技术 本科</li>
</ul>
<h2 id="个人评价"><a href="#个人评价" class="headerlink" title="个人评价"></a>个人评价</h2><ul>
<li>扎实的技术功底，丰富的项目经验</li>
<li>优秀的团队管理能力和沟通协调能力</li>
<li>具备较强的技术视野和架构设计能力</li>
<li>持续学习，保持对新技术的敏感度</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/12/23/AI%E5%BA%94%E7%94%A8%E5%B0%9D%E9%B2%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/12/23/AI%E5%BA%94%E7%94%A8%E5%B0%9D%E9%B2%9C/" class="post-title-link" itemprop="url">AI应用尝鲜</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-12-23 23:41:00" itemprop="dateCreated datePublished" datetime="2024-12-23T23:41:00+08:00">2024-12-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="main-tag">离职系列</span>
  <span class="sub-tag">第十二篇</span>
</div>
<div class="article-quote">
离职系列，想想这几年在公司的成长，在这做个记录。这篇是关于AI功能方案验证。
</div>

<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>落地事业部上一年关于AI的创新奖的方案，更合适的叫法应该是交接，之前的团队几乎停留在理论上和一个demo上，因为久久没有效果，可能感受到了上级的压力，需要看到实际效果，最终找到了我们团队，希望能借助我们团队让其产生价值（官方说法），我理解实际就接这个摊子。</p>
<h2 id="方案介绍"><a href="#方案介绍" class="headerlink" title="方案介绍"></a>方案介绍</h2><p>因为在这之前就是一个demo，具体前面的团队也说不出来个所以然，所以我们直接说说两边对话后的方案走向，希望做一个功能：容量预测，意思是根据服务器的多个指标历史数据，预估服务器未来的负载情况，从而给予客户参考或预案。</p>
<p>我试着画下大体的方案：</p>
<h3 id="架构图："><a href="#架构图：" class="headerlink" title="架构图："></a>架构图：</h3><p><img src="/2024/12/23/AI%E5%BA%94%E7%94%A8%E5%B0%9D%E9%B2%9C/ai01.png" alt="alt text"></p>
<h3 id="时序图："><a href="#时序图：" class="headerlink" title="时序图："></a>时序图：</h3><p><img src="/2024/12/23/AI%E5%BA%94%E7%94%A8%E5%B0%9D%E9%B2%9C/ai02.png" alt="alt text"></p>
<h3 id="大体流程"><a href="#大体流程" class="headerlink" title="大体流程"></a>大体流程</h3><ol>
<li>调度器触发flink批任务从ClickHouse获取原始数据</li>
<li>Flink进行基本的数据清洗和标准化</li>
<li>处理后的数据存入CK</li>
<li>python预测模型从CK获取数据</li>
<li>预测模型生成预测结果</li>
<li>阈值分析器识别潜在瓶颈</li>
<li>python大模型提供深度解释和建议</li>
<li>生成预测报告和告警</li>
</ol>
<h3 id="学习链接"><a href="#学习链接" class="headerlink" title="学习链接"></a>学习链接</h3><h4 id="ollama"><a href="#ollama" class="headerlink" title="ollama"></a>ollama</h4><p>ollama is an open-source tool that simplifies running large language models locally on your personal computer<br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=GWB9ApTPTv4&t=171s">https://www.youtube.com/watch?v=GWB9ApTPTv4&amp;t=171s</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/12/22/%E9%81%87%E8%A7%81%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/12/22/%E9%81%87%E8%A7%81%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/" class="post-title-link" itemprop="url">遇见多表查询</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-12-22 19:32:09" itemprop="dateCreated datePublished" datetime="2024-12-22T19:32:09+08:00">2024-12-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="main-tag">离职系列</span>
  <span class="sub-tag">第十一篇</span>
</div>
<div class="article-quote">
离职系列，想想这几年在公司的成长，在这做个记录。这篇是关于维护的一个旧功能“全部告警跟踪”。
</div>

<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>每个租户有自己的告警数据，少则几千多则几十万条数据，云平台提供了一个功能叫“全部告警跟踪”，该功能顾名思义，会展示所有租户的所有告警信息(刷新那一刻是实时的)，还能支持过滤、搜索等操作，这功能据说上线没多久就有问题，比如点分页时不时会出现超时。但是因为这功能用的人非常少，且只有管理员才有权限，也就一直放着。<br>但是新版需求要求解决这个问题，因为现在是我维护这个功能，所以需要我先出个技术方案。</p>
<h2 id="解法设计输出模板"><a href="#解法设计输出模板" class="headerlink" title="解法设计输出模板"></a>解法设计输出模板</h2><ol>
<li><p>解法设计的模板很多，但是我感觉稍微有点重，当前产品的节奏，没有那么多的时间和人力给我做那么详细的解法设计，所以简单梳理了一个简化版的解法设计，并与干系人达成了一致。</p>
</li>
<li><p>模板如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1. 引言</span><br><span class="line">  - 背景说明</span><br><span class="line">  - 问题陈述(现状、目标)</span><br><span class="line">  - 关键术语</span><br><span class="line">  - 参考资料</span><br><span class="line"></span><br><span class="line">2. 需求分析</span><br><span class="line">  - 核心诉求/期望交付的价值</span><br><span class="line">  - 非功要求</span><br><span class="line">3. 约束条件</span><br><span class="line">  - 依赖项</span><br><span class="line">  - 假设项</span><br><span class="line"></span><br><span class="line">4. 方案设计</span><br><span class="line">  - 可选方案对比(2-3个)</span><br><span class="line">    * 方案描述</span><br><span class="line">    * 优缺点分析</span><br><span class="line">    * 非功表现</span><br><span class="line">  - 推荐方案详细说明</span><br><span class="line">    * 架构设计</span><br><span class="line">    * 核心流程</span><br><span class="line">    * 关键设计点、算法伪代码（如果有必要）</span><br><span class="line">  </span><br><span class="line">5. 实施评估(因为团队自己做实施，所以加上这一章)</span><br><span class="line">  - 影响范围</span><br><span class="line">  - 实施成本</span><br><span class="line">  - 后续影响</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
<li><p>要分清楚解法设计和详细设计的核心区别：</p>
<ol>
<li>解法设计：回答”用什么方案解决问题”<ul>
<li>关注整体思路</li>
<li>多个方案对比选择</li>
<li>架构层面决策</li>
</ul>
</li>
<li>详细设计：回答”如何具体实现这个方案”<ul>
<li>已选定方案的具体技术实现细节</li>
<li>编码层面设计</li>
<li>…</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><p>在这儿我就不原方不动的把整个解法贴出来了，只捡几个重点说。</p>
<h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p>一定要记住，虽然咱们是干技术的，但是做解法的时候，一定先不要直接从技术的角度思考，先从业务的角度，还原业务场景，以及可能的演进需求，做到扩展性。</p>
<ol>
<li>年少不懂事的时候，干过一段时间的产品助理，当时就学会做需求分析的几把斧：<blockquote>
<p>tips:</p>
<ol>
<li>搞清楚买单的人和使用的人谁？分别想解决什么问题，特别是买单的人容易被忽视。（使用方再满意，买单的人不满意也是白搭）</li>
<li>维护好与需求调研对象的关系（人情世故）</li>
<li>5W1H方法做需求分析和挖掘（找出底层需求，避免浮于表面文字）</li>
<li>KANO方法对需求分级（找出痛点先解决，其它的都是锦上添花）</li>
</ol>
</blockquote>
</li>
</ol>
<p>这儿的原始需求是管理员能对所有租户的告警跟踪查看，关注其下团队成员所负责的租户的处理情况，对工作进度有了解，同时可以随时查看核心客户的数据。<br>这样几句简单的话，应用5W1H+KANO拆解下：</p>
<ol>
<li><p>5W1H分析：</p>
<ol>
<li><p>WHO（谁）</p>
<ul>
<li>主体：管理员</li>
<li>关注对象：团队成员、租户</li>
</ul>
</li>
<li><p>WHAT（什么）</p>
<ul>
<li>查看所有租户的告警跟踪情况</li>
<li>了解团队成员的工作进度</li>
<li>查看核心客户数据</li>
</ul>
</li>
<li><p>WHEN（什么时候）</p>
<ul>
<li>随时（需要实时或准实时的数据）</li>
<li>告警发生后的跟踪过程中</li>
</ul>
</li>
<li><p>WHERE（在哪里）</p>
<ul>
<li>系统内</li>
</ul>
</li>
<li><p>WHY（为什么），更深入可以加入5Why方法，探寻源需求。</p>
<ul>
<li>监督团队工作情况</li>
<li>及时了解核心客户状况</li>
<li>确保告警得到及时处理</li>
</ul>
</li>
</ol>
</li>
<li><p>HOW（怎么做）</p>
<ul>
<li>提供告警跟踪查看、筛选功能</li>
<li>展示团队成员负责的租户处理进度</li>
<li>支持核心客户数据快速查看</li>
</ul>
</li>
<li><p>KANO模型分析：</p>
<ol>
<li><p>基本型需求（Must-be）：</p>
<ul>
<li>查看所有租户的告警记录</li>
<li>查看告警处理状态</li>
</ul>
</li>
<li><p>期望型需求（Performance）：</p>
<ul>
<li>团队成员工作进度追踪</li>
<li>核心客户数据查看</li>
</ul>
</li>
<li><p>兴奋型需求（Delighter）：</p>
<ul>
<li>数据分析和统计</li>
</ul>
</li>
</ol>
</li>
</ol>
<p><strong>这里能得到几个关键信息：</strong></p>
<ol>
<li>依然需要在活的实时的数据（需求已经明确）</li>
<li>需要搜索、分页、筛选（大数据量的场景）</li>
<li>后续很有可能需要统计数据（要考虑数据聚合）</li>
<li>非功<ol>
<li>1000+租户，每个租户50w的告警，10s内刷出数据。</li>
<li>经费有限，且重新申请流程慢，额度小。</li>
</ol>
</li>
</ol>
<h4 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h4><ol>
<li>方案1：ShardingSphere 自身实现。<br>广播表是ShardingSphere中的一个概念，指的是在所有分片中存在的表，每个分片都有完整的副本。当更新广播表时，所有分片都会同步更新。通常用于数据量不大且需要频繁关联查询的表，比如字典表。<ol>
<li>优点：简单，不用引入任何其他组件。</li>
<li>缺点：<ol>
<li>数据量太大，无法在每个分片都复制全量数据。</li>
</ol>
</li>
</ol>
</li>
<li>方案2：ClickHouse(开源版)+Flink CDC<ol>
<li>优点：<ol>
<li>CK在已在多个产品运用，学习成本较低。</li>
<li>可以支持复杂的查询、聚合需求。</li>
<li>适合离线分析。</li>
<li>单表查询性能极强。</li>
</ol>
</li>
<li>缺点：<ol>
<li>不支持事务。</li>
<li>集群部署成本高（官方没有提供Helm Chart。且ClickHouse集群扩展不方便，很多手动处理，不适合弹性扩展，集成k8s较难）。</li>
<li>删除&#x2F;更新性能差，更适合批量追加。告警数据会经常变更，可能存在性能问题。</li>
<li>手动管理分片、分区、MergeTree等，维护成本较高。</li>
</ol>
</li>
</ol>
</li>
<li>方案3：Doris+Flink CDC<ol>
<li><p>优点：</p>
<ol>
<li>实时性高、支持高并发。</li>
<li>可以支持复杂的查询需求、聚合需求。</li>
<li>集群部署成本低（Doris，官方提供了Helm Chart，且适合弹性扩展，运维压力小）。</li>
<li>自动话程度高（分片、负载均衡、存储管理等）</li>
<li>SQL友好</li>
<li>存算分离</li>
</ol>
</li>
<li><p>缺点：</p>
<ol>
<li>引入Doris新组件，可能会增加采购成本。</li>
<li>复杂的模糊搜索可能无法实现。</li>
</ol>
</li>
</ol>
</li>
<li>方案4：ES+Flink CDC<ol>
<li><p>优点：</p>
<ol>
<li>近实时，可能有秒级延迟。</li>
<li>可以支持复杂的查询需求（特别是全文检索）。</li>
<li>集群部署成本低（官方有Helm Chart和Operator，且适合弹性扩展，可无缝集成k8s，运维压力小）</li>
</ol>
</li>
<li><p>缺点：</p>
<ol>
<li>不支持事务</li>
<li>引入ES新组件，可能会增加较大采购成本（ES需要较多内存和SSD磁盘）。</li>
<li>很多时候需要手动处理，比如分片分步、设计索引、索引优化、GC 调优等，维护成本较高。</li>
<li>使用DSL，不是标准 SQL，学习成本较高。</li>
</ol>
</li>
</ol>
</li>
</ol>
<h4 id="推荐方案2"><a href="#推荐方案2" class="headerlink" title="推荐方案2"></a>推荐方案2</h4><p>原因：</p>
<ol>
<li>在活告警数据量可控，暂不考虑扩展。</li>
<li>系统已接入了CK，最低成本（学习、部署、购买）。</li>
</ol>
<h5 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/2024/12/22/%E9%81%87%E8%A7%81%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/5.jpg" alt="alt text"></p>
<h5 id="关键验证点"><a href="#关键验证点" class="headerlink" title="关键验证点"></a>关键验证点</h5><p>1、2验证点，由于前期已经做过验证，着重验证3、4就行，特别是更新和删除数据。</p>
<h5 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h5><p>按500个租户，每个租户5000在活告警，没问题，因为主要是验证可行性，没有那么严格的压测，图啥的当时就没留了。这块详设的时候会更具体严格一些。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/09/26/%E9%81%87%E8%A7%81%E6%B4%AA%E5%B3%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/26/%E9%81%87%E8%A7%81%E6%B4%AA%E5%B3%B0/" class="post-title-link" itemprop="url">遇见小洪峰</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-26 22:00:11" itemprop="dateCreated datePublished" datetime="2024-09-26T22:00:11+08:00">2024-09-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="main-tag">离职系列</span>
  <span class="sub-tag">第十篇</span>
</div>
<div class="article-quote">
离职系列，想想这几年在公司的成长，在这做个记录。这篇是关于线上的bug。
</div>

<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>其实说来这个问题，跟之前的<a href="/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/" title="遇见连接超时">遇见连接超时</a>有个遗留项也有一些关系，因为报错的源头，也是是数据库连接关闭，与上一次仅仅是我那块出问题不同的是，这次是大批量的租户多种任务都失败，飞书告警消息都把我弹麻了。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2024-10-23 17:00:10,177 [XxxGenerator8] ERROR [c.r.r.m.s.s.notice.impl.Xxx] Xxx.java:631 - 客户:2xx319,告警数据处理异常</span><br><span class="line">org.springframework.jdbc.UncategorizedSQLException: </span><br><span class="line">2024-10-23 17:00:10,176 [XxxGenerator8] ERROR [c.r.r.m.s.s.notice.impl.Xxx] Xxx.java:511 - 客户:2xx319,集成平台巡检数据处理异常</span><br><span class="line">024-10-23 17:00:10,175 [XxxGenerator8] ERROR [c.r.r.m.s.s.notice.impl.Xxx] Xxx.java:547 - 客户:2xx319,服务状态数据处理异常</span><br><span class="line">org.springframework.jdbc.UncategorizedSQLException: </span><br><span class="line">	... 35 common frames omitted</span><br><span class="line">2024-10-23 17:00:10,174 [XxxGenerator8] ERROR [c.r.r.m.s.s.notice.impl.Xxx] Xxx.java:582 - 客户:2xx319,心跳数据处理异常</span><br><span class="line">	... 82 common frames omitted</span><br><span class="line">org.springframework.jdbc.UncategorizedSQLException: </span><br><span class="line">     ### Cause: java.sql.SQLException: Connection is closed</span><br><span class="line">            ; uncategorized SQLException; SQL state [null]; error code [0]; Connection is closed</span><br><span class="line">              at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:93)</span><br><span class="line">              at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:439)</span><br><span class="line">              at java.base/java.lang.Thread.run(Thread.java:840)</span><br><span class="line">            Caused by: java.sql.SQLException: Connection is closed</span><br><span class="line"></span><br><span class="line">       </span><br></pre></td></tr></table></figure>

<p>这次定位很快，具体定位的就不再赘述，出了问题后，我想了想有两个明确的因素：</p>
<ol>
<li>上次类似的错误就发现了，连接池设置存在问题。<ol>
<li>再次检查，当前没有慢sql，所以初步判断是连接池问题。</li>
</ol>
</li>
<li>新上线了策略功能，策略把之前定时默认执行的任务，可更改为每个租户下每种类型单独的执行时间和周期。<ol>
<li>怀疑存在了N个客户N个任务都在同一时间点执行的问题，导致连接池耗尽。</li>
</ol>
</li>
</ol>
<h2 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h2><ol>
<li>根据预留的后门，手动把核心任务给生成了，让线上能正常处理。</li>
<li>因为之前已知了引入ShardingSphere后同时引入了HikariCP连接池，现在只留HikariCP连接池，并对参数进行调优。<ol>
<li>以下是同事调优后的参数：超时时间以及连接池大小都对应阿里云购买的高性能PG做了对应的调整。 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">master0:</span><br><span class="line">  dataSourceClassName: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">  driverClassName: org.postgresql.Driver</span><br><span class="line">  jdbcUrl: jdbc:postgresql://xx.aliyuncs.com:xx/xx</span><br><span class="line">  username: xxx</span><br><span class="line">  password: xxx</span><br><span class="line">  connectionTimeout: 60000</span><br><span class="line">  idleTimeout: 600000</span><br><span class="line">  maxLifetime: 3600000</span><br><span class="line">  maximumPoolSize: 200</span><br><span class="line">  minimumIdle: 1</span><br><span class="line">  poolName: business-data-master0</span><br><span class="line">    </span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>临时的先让cron表达式有一定的偏移量比如<ol>
<li><pre><code>&#123;% codeblock %&#125;

               return timeList.stream()
                   .map(time -> &#123;
                       String[] timeParts = parseTime(time);
                       // TODO 临时解法：为每个cron添加随机偏移（ 0~3分钟）
                       int minuteOffset = ThreadLocalRandom.current().nextInt(4); // 生成 0~3 的随机数
                       int minute = (Integer.parseInt(timeParts[1]) + minuteOffset) % 60; // 防止超出 59 分钟
                       return "0 " + minute + " " + timeParts[0] + " * * ? ";
                   &#125;)
                   .collect(Collectors.toList());
                private static String[] parseTime(String time) &#123;
                    return time.split(":"); // 格式为 "HH:mm"
                &#125;
            &#125;

   &#123;% endcodeblock %&#125;
</code></pre>
</li>
</ol>
</li>
</ol>
<p>2、3做完之后，腾出缓冲时间着手长期解了，需要重新做下解法设计，以适配高并发的场景。</p>
<h2 id="解法设计1-0"><a href="#解法设计1-0" class="headerlink" title="解法设计1.0"></a>解法设计1.0</h2><p>具体的解法设计咋做，可看下之前的<a href="/2024/12/22/%E9%81%87%E8%A7%81%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2/" title="遇见多表查询">遇见多表查询</a>，这儿就直接给出一些结论：</p>
<ol>
<li>任务错峰（随机延迟）</li>
<li>任务限流（线程池 + 队列）</li>
<li>任务优先级机制（先执行核心任务）</li>
</ol>
<h3 id="UML："><a href="#UML：" class="headerlink" title="UML："></a>UML：</h3><p><img src="/2024/09/26/%E9%81%87%E8%A7%81%E6%B4%AA%E5%B3%B0/4.png" alt="alt text"></p>
<h3 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a>流程图：</h3><p><img src="/2024/09/26/%E9%81%87%E8%A7%81%E6%B4%AA%E5%B3%B0/2.png" alt="alt text"></p>
<h3 id="时序图："><a href="#时序图：" class="headerlink" title="时序图："></a>时序图：</h3><p><img src="/2024/09/26/%E9%81%87%E8%A7%81%E6%B4%AA%E5%B3%B0/3.png" alt="alt text"></p>
<h3 id="关键伪代码"><a href="#关键伪代码" class="headerlink" title="关键伪代码"></a>关键伪代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 任务优先级定义</span><br><span class="line">private enum TaskPriority &#123;</span><br><span class="line">    HIGH(0),</span><br><span class="line">    MEDIUM(5),</span><br><span class="line">    LOW(10);</span><br><span class="line"></span><br><span class="line">    private final int value;</span><br><span class="line"></span><br><span class="line">    TaskPriority(int value) &#123;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* manage-biz Powerjob 调度类</span><br><span class="line">* 优化版本 - 任务削峰与队列管理</span><br><span class="line">*</span><br><span class="line">* @author hht</span><br><span class="line">* @since 2024-09-10</span><br><span class="line">*/</span><br><span class="line">@Component(value = &quot;manageBizPowerjobDispatcher&quot;)</span><br><span class="line">@Slf4j</span><br><span class="line">@RequiredArgsConstructor</span><br><span class="line">public class ManageBizPowerjobDispatcher &#123;</span><br><span class="line">    private final IXxxScheduleService XxxScheduleService;</span><br><span class="line">    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();</span><br><span class="line"></span><br><span class="line">    /** 平安通告powerjob任务id */</span><br><span class="line">    public static final String TASK_SAFETY_NOTICE_ID = &quot;generateXxx&quot;;</span><br><span class="line"></span><br><span class="line">    public static final String SUCCESS = &quot;success&quot;;</span><br><span class="line"></span><br><span class="line">    // 配置参数，可从配置文件注入</span><br><span class="line">    @Value(&quot;$&#123;powerjob.task.max-concurrent:10&#125;&quot;)</span><br><span class="line">    private int maxConcurrentTasks;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;powerjob.task.queue-capacity:500&#125;&quot;)</span><br><span class="line">    private int queueCapacity;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;powerjob.task.max-delay-minutes:5&#125;&quot;)</span><br><span class="line">    private int maxDelayMinutes;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;powerjob.task.worker-threads:20&#125;&quot;)</span><br><span class="line">    private int workerThreads;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // 延迟任务定义</span><br><span class="line">    @Data</span><br><span class="line">    private static class DelayedTask implements Delayed &#123;</span><br><span class="line">        private final Runnable task;</span><br><span class="line">        private final long executeTime;</span><br><span class="line">        private final String taskId;</span><br><span class="line">        private final String jobParams;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public long getDelay(TimeUnit unit) &#123;</span><br><span class="line">            return unit.convert(executeTime - System.currentTimeMillis(), TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 优先级任务定义</span><br><span class="line">    @Data</span><br><span class="line">    private static class PriorityTask implements Comparable&lt;PriorityTask&gt; &#123;</span><br><span class="line">        private final Runnable task;</span><br><span class="line">        private final TaskPriority priority;</span><br><span class="line">        private final String taskId;</span><br><span class="line">        private final String jobParams;</span><br><span class="line">        private final long createTime;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int compareTo(PriorityTask other) &#123;</span><br><span class="line">            // 先按优先级排序，再按创建时间排序</span><br><span class="line">            int priorityCompare = Integer.compare(priority.getValue(), other.priority.getValue());</span><br><span class="line">            if (priorityCompare != 0) &#123;</span><br><span class="line">                return priorityCompare;</span><br><span class="line">            &#125;</span><br><span class="line">            return Long.compare(createTime, other.createTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">      * 1.单独的线程，负责从队列中获取任务并分发</span><br><span class="line">      * 2.协调延迟队列和优先级队列</span><br><span class="line">      * 3.控制任务的并发执行数量</span><br><span class="line">     */</span><br><span class="line">    private class TaskDispatcher implements Runnable &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    // 先检查延迟队列</span><br><span class="line">                    DelayedTask delayedTask = delayedTaskQueue.poll();</span><br><span class="line">                    if (delayedTask != null) &#123;</span><br><span class="line">                        // 将任务添加到优先级队列</span><br><span class="line">                        submitToPriorityQueue(delayedTask.getTask(), TaskPriority.HIGH, delayedTask.getTaskId(), delayedTask.getJobParams());</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    // 从优先级队列取任务执行</span><br><span class="line">                    PriorityTask priorityTask = priorityTaskQueue.take();</span><br><span class="line">                    if (priorityTask != null) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            // 获取信号量，控制并发</span><br><span class="line">                            taskSemaphore.acquire();</span><br><span class="line">                            </span><br><span class="line">                            // 记录任务开始执行</span><br><span class="line">                            activeTaskCount.incrementAndGet();</span><br><span class="line">                            taskExecutionCount.computeIfAbsent(priorityTask.getTaskId(), k -&gt; new AtomicInteger(0)).incrementAndGet();</span><br><span class="line">                            </span><br><span class="line">                            // 提交到线程池执行</span><br><span class="line">                            executorService.submit(() -&gt; &#123;</span><br><span class="line">                                try &#123;</span><br><span class="line">                                    log.info(&quot;执行任务: &#123;&#125;, 参数: &#123;&#125;&quot;, priorityTask.getTaskId(), priorityTask.getJobParams());</span><br><span class="line">                                    priorityTask.getTask().run();</span><br><span class="line">                                &#125; catch (Exception e) &#123;</span><br><span class="line">                                    log.error(&quot;任务执行异常: &#123;&#125;&quot;, priorityTask.getTaskId(), e);</span><br><span class="line">                                &#125; finally &#123;</span><br><span class="line">                                    // 释放信号量</span><br><span class="line">                                    taskSemaphore.release();</span><br><span class="line">                                    // 更新计数器</span><br><span class="line">                                    activeTaskCount.decrementAndGet();</span><br><span class="line">                                    AtomicInteger counter = taskExecutionCount.get(priorityTask.getTaskId());</span><br><span class="line">                                    if (counter != null) &#123;</span><br><span class="line">                                        counter.decrementAndGet();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                            Thread.currentThread().interrupt();</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                    break;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;任务分发器异常&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 任务队列和执行器</span><br><span class="line">    private DelayQueue&lt;DelayedTask&gt; delayedTaskQueue;</span><br><span class="line">    private PriorityBlockingQueue&lt;PriorityTask&gt; priorityTaskQueue;</span><br><span class="line">    private ExecutorService executorService;</span><br><span class="line">    private ExecutorService dispatcherService;</span><br><span class="line">    private Semaphore taskSemaphore;</span><br><span class="line">    private Random random;</span><br><span class="line"></span><br><span class="line">    // 任务执行状态监控</span><br><span class="line">    private AtomicLong totalTasksReceived = new AtomicLong(0);</span><br><span class="line">    private AtomicLong totalTasksExecuted = new AtomicLong(0);</span><br><span class="line">    private AtomicInteger activeTaskCount = new AtomicInteger(0);</span><br><span class="line">    private Map&lt;String, AtomicInteger&gt; taskExecutionCount = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        // 初始化任务队列</span><br><span class="line">        delayedTaskQueue = new DelayQueue&lt;&gt;();</span><br><span class="line">        priorityTaskQueue = new PriorityBlockingQueue&lt;&gt;(queueCapacity);</span><br><span class="line">        </span><br><span class="line">        // 初始化线程池</span><br><span class="line">        executorService = Executors.newFixedThreadPool(workerThreads, new ThreadFactory() &#123;</span><br><span class="line">            private final AtomicInteger counter = new AtomicInteger(1);</span><br><span class="line">            </span><br><span class="line">            @Override</span><br><span class="line">            public Thread newThread(Runnable r) &#123;</span><br><span class="line">                Thread thread = new Thread(r, &quot;task-worker-&quot; + counter.getAndIncrement());</span><br><span class="line">                thread.setDaemon(true);</span><br><span class="line">                return thread;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 初始化分发器线程，</span><br><span class="line">        dispatcherService = Executors.newSingleThreadExecutor(r -&gt; &#123;</span><br><span class="line">            Thread thread = new Thread(r, &quot;task-dispatcher&quot;);</span><br><span class="line">            thread.setDaemon(true);</span><br><span class="line">            return thread;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        // 初始化信号量</span><br><span class="line">        taskSemaphore = new Semaphore(maxConcurrentTasks);</span><br><span class="line">        </span><br><span class="line">        // 初始化随机数生成器</span><br><span class="line">        random = new Random();</span><br><span class="line">        </span><br><span class="line">        // 启动任务分发线程</span><br><span class="line">        dispatcherService.submit(new TaskDispatcher());</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;任务调度器初始化完成，最大并发任务数: &#123;&#125;, 队列容量: &#123;&#125;, 最大延迟分钟数: &#123;&#125;, 工作线程数: &#123;&#125;&quot;, </span><br><span class="line">                maxConcurrentTasks, queueCapacity, maxDelayMinutes, workerThreads);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @PreDestroy</span><br><span class="line">    public void shutdown() &#123;</span><br><span class="line">        // 关闭调度器</span><br><span class="line">        if (dispatcherService != null) &#123;</span><br><span class="line">            dispatcherService.shutdownNow();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 关闭执行器</span><br><span class="line">        if (executorService != null) &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">            try &#123;</span><br><span class="line">                if (!executorService.awaitTermination(30, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    executorService.shutdownNow();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                executorService.shutdownNow();</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;任务调度器已关闭，总接收任务数: &#123;&#125;, 总执行任务数: &#123;&#125;&quot;, </span><br><span class="line">                totalTasksReceived.get(), totalTasksExecuted.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 提交任务到延迟队列</span><br><span class="line">    */</span><br><span class="line">    private void submitToDelayQueue(Runnable task, String taskId, String jobParams) &#123;</span><br><span class="line">        // 随机延迟时间，在0到maxDelayMinutes分钟之间</span><br><span class="line">        long delayMs = random.nextInt((int) TimeUnit.MINUTES.toMillis(maxDelayMinutes));</span><br><span class="line">        DelayedTask delayedTask = new DelayedTask(task, delayMs, taskId, jobParams);</span><br><span class="line">        delayedTaskQueue.offer(delayedTask);</span><br><span class="line">        totalTasksReceived.incrementAndGet();</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;任务已提交到延迟队列: &#123;&#125;, 延迟: &#123;&#125;ms&quot;, taskId, delayMs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 提交任务到优先级队列</span><br><span class="line">    */</span><br><span class="line">    private void submitToPriorityQueue(Runnable task, TaskPriority priority, String taskId, String jobParams) &#123;</span><br><span class="line">        PriorityTask priorityTask = new PriorityTask(task, priority, taskId, jobParams);</span><br><span class="line">        priorityTaskQueue.offer(priorityTask);</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;任务已提交到优先级队列: &#123;&#125;, 优先级: &#123;&#125;&quot;, taskId, priority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 获取任务类型对应的优先级</span><br><span class="line">    */</span><br><span class="line">    private TaskPriority getTaskPriority(String taskId) &#123;</span><br><span class="line">        switch (taskId) &#123;</span><br><span class="line">            case TASK_SAFETY_NOTICE_ID:</span><br><span class="line">            case TASK_PUSH_SERVICE_STATUS_ID:</span><br><span class="line">                return TaskPriority.HIGH;</span><br><span class="line">            case TASK_TENANT_SERVICE_PHASE_ID:</span><br><span class="line">            case TASK_WEEKLY_SUMMARY:</span><br><span class="line">                return TaskPriority.MEDIUM;</span><br><span class="line">            default:</span><br><span class="line">                return TaskPriority.LOW;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 创建可执行的任务</span><br><span class="line">    */</span><br><span class="line">    private Runnable createExecutableTask(String taskId, String jobParams, TaskContext taskContext) &#123;</span><br><span class="line">        switch (taskId) &#123;</span><br><span class="line">            case TASK_SAFETY_NOTICE_ID:</span><br><span class="line">                return () -&gt; generateXxxTask(taskContext);</span><br><span class="line">            case TASK_OTHER:</span><br><span class="line">                return () -&gt; generateOtherTask(taskContext);</span><br><span class="line">            ...</span><br><span class="line">            default:</span><br><span class="line">                throw new IllegalArgumentException(&quot;未知的任务类型: &quot; + taskId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 通用任务提交方法</span><br><span class="line">    */</span><br><span class="line">    private ProcessResult submitTask(String taskId, TaskContext taskContext) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            totalTasksReceived.incrementAndGet();</span><br><span class="line">            </span><br><span class="line">            // 检查任务执行情况，如果已有大量相同类型任务，加入延迟队列</span><br><span class="line">            int activeCount = taskExecutionCount.computeIfAbsent(taskId, k -&gt; new AtomicInteger(0)).get();</span><br><span class="line">            if (activeCount &gt; maxConcurrentTasks / 2) &#123;</span><br><span class="line">                log.warn(&quot;当前任务类型 &#123;&#125; 正在执行的数量较多: &#123;&#125;, 将使用延迟队列分散负载&quot;, taskId, activeCount);</span><br><span class="line">                submitToDelayQueue(createExecutableTask(taskId, taskContext.getJobParams(), taskContext), taskId, taskContext.getJobParams());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 根据任务类型分配优先级</span><br><span class="line">                TaskPriority priority = getTaskPriority(taskId);</span><br><span class="line">                submitToPriorityQueue(createExecutableTask(taskId, taskContext.getJobParams(), taskContext), priority, taskId, taskContext.getJobParams());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            return new ProcessResult(true, formatResponse(SUCCESS, taskId));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;提交任务异常: &#123;&#125;&quot;, taskId, e);</span><br><span class="line">            return new ProcessResult(false, formatResponse(e.getMessage(), taskId));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ====== 以下是原始的PowerJob任务处理方法，改为使用队列系统 ======</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 告警任务</span><br><span class="line">    */</span><br><span class="line">    @PowerJobHandler(name = TASK_OTHER)</span><br><span class="line">    public ProcessResult generateOtherTask(TaskContext taskContext) &#123;</span><br><span class="line">        log.info(&quot;==================== 调度触发(其它任务) ======================&quot;);</span><br><span class="line">        return submitTask(TASK_OTHER, taskContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ProcessResult generateOtherTask(TaskContext taskContext) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            StrategyJobParams jobParams = new StrategyJobParams();</span><br><span class="line">            if (StringUtils.hasLength(taskContext.getJobParams())) &#123;</span><br><span class="line">                jobParams = OBJECT_MAPPER.readValue(taskContext.getJobParams(), StrategyJobParams.class);</span><br><span class="line">            &#125;</span><br><span class="line">            strategyScheduleService.generateTask(jobParams);</span><br><span class="line">            totalTasksExecuted.incrementAndGet();</span><br><span class="line">            return new ProcessResult(true, formatResponse(SUCCESS, TASK_OTHER));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;调度执行【其它任务】异常&quot;, e);</span><br><span class="line">            return new ProcessResult(false, formatResponse(e.getMessage(), TASK_OTHER));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    * 生成平安通告</span><br><span class="line">    */</span><br><span class="line">    @PowerJobHandler(name = TASK_SAFETY_NOTICE_ID)</span><br><span class="line">    public ProcessResult generateXxx(TaskContext taskContext) &#123;</span><br><span class="line">        log.info(&quot;==================== 调度触发(平安通告) ======================&quot;);</span><br><span class="line">        return submitTask(TASK_SAFETY_NOTICE_ID, taskContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ProcessResult generateXxxTask(TaskContext taskContext) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 获取调度任务的参数</span><br><span class="line">            StrategyJobParams jobParams = null;</span><br><span class="line">            if (StringUtils.hasLength(taskContext.getJobParams())) &#123;</span><br><span class="line">                jobParams = OBJECT_MAPPER.readValue(taskContext.getJobParams(), StrategyJobParams.class);</span><br><span class="line">            &#125;</span><br><span class="line">            // 生成平安通告</span><br><span class="line">            XxxScheduleService.autoGenerateBatch(jobParams);</span><br><span class="line">            totalTasksExecuted.incrementAndGet();</span><br><span class="line">            return new ProcessResult(true, formatResponse(&quot;success&quot;, TASK_SAFETY_NOTICE_ID));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;调度执行【平安通告】异常&quot;, e);</span><br><span class="line">            return new ProcessResult(false, formatResponse(e.getMessage(), TASK_SAFETY_NOTICE_ID));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private String formatResponse(String info, String id) &#123;</span><br><span class="line">        return String.format(&quot;&#123;\&quot;taskId\&quot;: \&quot;%s\&quot;, \&quot;info\&quot;: \&quot;%s\&quot;&#125;&quot;, id, info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<h2 id="解法设计2-0"><a href="#解法设计2-0" class="headerlink" title="解法设计2.0"></a>解法设计2.0</h2><p>主要是解决一些异常场景，比如：</p>
<ol>
<li>服务异常重启，任务丢了？</li>
<li>信号量获取阻塞，所有任务堆积？</li>
<li>发生异常，及时感知等</li>
</ol>
<p>这一步还停留在设计阶段，也可能是我设计并落地，也先做个记录。</p>
<p>解法：</p>
<ol>
<li>Redis代替内存队列，开启持久话，便于启动后恢复。</li>
<li>核心业务单独维护信号量</li>
<li>设置拒绝策略，当队列超过阈值直接异常返回给powerjob<ol>
<li>同时发送告警</li>
</ol>
</li>
<li>适当的动态调整信号量</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/" class="post-title-link" itemprop="url">遇见连接超时</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-09-17 19:51:00" itemprop="dateCreated datePublished" datetime="2024-09-17T19:51:00+08:00">2024-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">工作</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="main-tag">离职系列</span>
  <span class="sub-tag">第九篇</span>
</div>
<div class="article-quote">
离职系列，想想这几年在公司的成长，在这做个记录。这篇是遇到的一个比较典型的线上问题。
</div>

<h3 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h3><p>写了一个每天执行两次的定时任务，该任务会分批对线上所有几百个租户生成《平安通告》，上线1个多月后突然手机收到告警，某几个用户生成失败。</p>
<pre><code>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">2024-10-17 17:00:10,125 [safetyNoticeGenerator8] ERROR [com.alibaba.druid.pool.DruidDataSource] DruidDataSource.java:1988 - &#123;conn-110021&#125; discard</span><br><span class="line"> org.postgresql.util.PSQLException: An I/O error occurred while sending to the backend.</span><br><span class="line">   at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:395)</span><br><span class="line">   at org.postgresql.jdbc.PgStatement.executeInternal(PgStatement.java:498)</span><br><span class="line">   at org.postgresql.jdbc.PgStatement.execute(PgStatement.java:415)</span><br><span class="line">   at org.postgresql.jdbc.PgPreparedStatement.executeWithFlags(PgPreparedStatement.java:190)</span><br><span class="line">   at org.postgresql.jdbc.PgPreparedStatement.execute(PgPreparedStatement.java:177)</span><br><span class="line">   at com.alibaba.druid.pool.DruidPooledPreparedStatement.execute(DruidPooledPreparedStatement.java:483)</span><br><span class="line">   at org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement$2.executeSQL(ShardingSpherePreparedStatement.java:439)</span><br><span class="line">   at org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement$2.executeSQL(ShardingSpherePreparedStatement.java:435)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.sql.execute.engine.driver.jdbc.JDBCExecutorCallback.execute(JDBCExecutorCallback.java:95)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.sql.execute.engine.driver.jdbc.JDBCExecutorCallback.execute(JDBCExecutorCallback.java:75)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.kernel.ExecutorEngine.syncExecute(ExecutorEngine.java:135)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.kernel.ExecutorEngine.serialExecute(ExecutorEngine.java:121)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.kernel.ExecutorEngine.execute(ExecutorEngine.java:115)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.sql.execute.engine.driver.jdbc.JDBCExecutor.execute(JDBCExecutor.java:65)</span><br><span class="line">   at org.apache.shardingsphere.infra.executor.sql.execute.engine.driver.jdbc.JDBCExecutor.execute(JDBCExecutor.java:49)</span><br><span class="line">   at org.apache.shardingsphere.driver.executor.DriverJDBCExecutor.doExecute(DriverJDBCExecutor.java:156)</span><br><span class="line">   at org.apache.shardingsphere.driver.executor.DriverJDBCExecutor.execute(DriverJDBCExecutor.java:145)</span><br><span class="line">   at org.apache.shardingsphere.driver.jdbc.core.statement.ShardingSpherePreparedStatement.execute(ShardingSpherePreparedStatement.java:402)</span><br><span class="line">   at com.zaxxer.hikari.pool.ProxyPreparedStatement.execute(ProxyPreparedStatement.java:44)</span><br><span class="line">   at com.zaxxer.hikari.pool.HikariProxyPreparedStatement.execute(HikariProxyPreparedStatement.java)</span><br><span class="line">   at org.apache.ibatis.executor.statement.PreparedStatementHandler.query(PreparedStatementHandler.java:65)</span><br><span class="line">   at org.apache.ibatis.executor.statement.RoutingStatementHandler.query(RoutingStatementHandler.java:80)</span><br><span class="line">   at jdk.internal.reflect.GeneratedMethodAccessor49.invoke(Unknown Source)</span><br><span class="line">   at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">   at java.base/java.lang.reflect.Method.invoke(Method.java:568)</span><br><span class="line">   at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:61)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy207.query(Unknown Source)</span><br><span class="line">   at org.apache.ibatis.executor.SimpleExecutor.doQuery(SimpleExecutor.java:65)</span><br><span class="line">   at org.apache.ibatis.executor.BaseExecutor.queryFromDatabase(BaseExecutor.java:333)</span><br><span class="line">   at org.apache.ibatis.executor.BaseExecutor.query(BaseExecutor.java:158)</span><br><span class="line">   at org.apache.ibatis.executor.CachingExecutor.query(CachingExecutor.java:110)</span><br><span class="line">   at com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor.intercept(MybatisPlusInterceptor.java:81)</span><br><span class="line">   at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:59)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy206.query(Unknown Source)</span><br><span class="line">   at jdk.internal.reflect.GeneratedMethodAccessor44.invoke(Unknown Source)</span><br><span class="line">   at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">   at java.base/java.lang.reflect.Method.invoke(Method.java:568)</span><br><span class="line">   at org.apache.ibatis.plugin.Invocation.proceed(Invocation.java:49)</span><br><span class="line">   at com.github.yulichang.interceptor.MPJInterceptor.intercept(MPJInterceptor.java:76)</span><br><span class="line">   at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:59)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy206.query(Unknown Source)</span><br><span class="line">   at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:154)</span><br><span class="line">   at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:147)</span><br><span class="line">   at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:142)</span><br><span class="line">   at jdk.internal.reflect.GeneratedMethodAccessor109.invoke(Unknown Source)</span><br><span class="line">   at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">   at java.base/java.lang.reflect.Method.invoke(Method.java:568)</span><br><span class="line">   at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:425)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy189.selectList(Unknown Source)</span><br><span class="line">   at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:224)</span><br><span class="line">   at com.baomidou.mybatisplus.core.override.MybatisMapperMethod.executeForMany(MybatisMapperMethod.java:166)</span><br><span class="line">   at com.baomidou.mybatisplus.core.override.MybatisMapperMethod.execute(MybatisMapperMethod.java:77)</span><br><span class="line">   at com.baomidou.mybatisplus.core.override.MybatisMapperProxy$PlainMethodInvoker.invoke(MybatisMapperProxy.java:152)</span><br><span class="line">   at com.baomidou.mybatisplus.core.override.MybatisMapperProxy.invoke(MybatisMapperProxy.java:89)</span><br><span class="line">   at jdk.proxy2/jdk.proxy2.$Proxy197.findDistinctCiIdsByIdentityId(Unknown Source)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl.addAlertData(xxServiceImpl.java:612)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl.lambda$setJsonField$5(xxServiceImpl.java:368)</span><br><span class="line">   at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl.setJsonField(xxServiceImpl.java:346)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl.batchCreate(xxServiceImpl.java:201)</span><br><span class="line">   at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">   at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)</span><br><span class="line">   at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">   at java.base/java.lang.reflect.Method.invoke(Method.java:568)</span><br><span class="line">   at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:343)</span><br><span class="line">   at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)</span><br><span class="line">   at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)</span><br><span class="line">   at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:751)</span><br><span class="line">   at org.springframework.transaction.interceptor.TransactionInterceptor$1.proceedWithInvocation(TransactionInterceptor.java:117)</span><br><span class="line">   at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:391)</span><br><span class="line">   at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)</span><br><span class="line">   at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)</span><br><span class="line">   at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:751)</span><br><span class="line">   at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:703)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.xxServiceImpl$$SpringCGLIB$$0.batchCreate(&lt;generated&gt;)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.SafetyNoticeScheduleServiceImpl.processBatch(SafetyNoticeScheduleServiceImpl.java:194)</span><br><span class="line">   at com.xxx.xxxcloud.manage.service.safety.notice.impl.SafetyNoticeScheduleServiceImpl.lambda$processBatchesInThreadPool$0(SafetyNoticeScheduleServiceImpl.java:112)</span><br><span class="line">   at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)</span><br><span class="line">   at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)</span><br><span class="line">   at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)</span><br><span class="line">   at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)</span><br><span class="line">   at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)</span><br><span class="line">   at java.base/java.lang.Thread.run(Thread.java:840)</span><br><span class="line"> Caused by: java.net.SocketTimeoutException: Read timed out</span><br><span class="line">   at java.base/sun.nio.ch.NioSocketImpl.timedRead(NioSocketImpl.java:288)</span><br><span class="line">   at java.base/sun.nio.ch.NioSocketImpl.implRead(NioSocketImpl.java:314)</span><br><span class="line">   at java.base/sun.nio.ch.NioSocketImpl.read(NioSocketImpl.java:355)</span><br><span class="line">   at java.base/sun.nio.ch.NioSocketImpl$1.read(NioSocketImpl.java:808)</span><br><span class="line">   at java.base/java.net.Socket$SocketInputStream.read(Socket.java:966)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketInputRecord.read(SSLSocketInputRecord.java:484)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketInputRecord.readHeader(SSLSocketInputRecord.java:478)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketInputRecord.bytesInCompletePacket(SSLSocketInputRecord.java:70)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketImpl.readApplicationRecord(SSLSocketImpl.java:1465)</span><br><span class="line">   at java.base/sun.security.ssl.SSLSocketImpl$AppInputStream.read(SSLSocketImpl.java:1069)</span><br><span class="line">   at org.postgresql.core.VisibleBufferedInputStream.readMore(VisibleBufferedInputStream.java:161)</span><br><span class="line">   at org.postgresql.core.VisibleBufferedInputStream.ensureBytes(VisibleBufferedInputStream.java:128)</span><br><span class="line">   at org.postgresql.core.VisibleBufferedInputStream.ensureBytes(VisibleBufferedInputStream.java:113)</span><br><span class="line">   at org.postgresql.core.VisibleBufferedInputStream.read(VisibleBufferedInputStream.java:73)</span><br><span class="line">   at org.postgresql.core.PGStream.receiveChar(PGStream.java:465)</span><br><span class="line">   at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:2155)</span><br><span class="line">   at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:368)</span><br><span class="line">   ... 82 common frames omitted</span><br><span class="line"> org.springframework.jdbc.UncategorizedSQLException: </span><br><span class="line"> ### Error querying database.  Cause: java.sql.SQLException: Connection is closed</span><br><span class="line"> ### The error may exist in class path resource [mapper/TbxxHealthCheckResultMapper.xml]</span><br><span class="line"> ### The error may involve com.xxx.xxxcloud.manage.mapper.xx.TbxxHealthCheckResultMapper.selectExecuteLatest</span><br><span class="line"> ### The error occurred while executing a query</span><br><span class="line"> ### Cause: java.sql.SQLException: Connection is closed</span><br><span class="line"> ; uncategorized SQLException; SQL state [null]; error code [0]; Connection is closed</span><br><span class="line">   at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:93)</span><br><span class="line">   at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:439)</span><br><span class="line">   at java.base/java.lang.Thread.run(Thread.java:840)</span><br><span class="line"> Caused by: java.sql.SQLException: Connection is closed</span><br><span class="line">   at com.zaxxer.hikari.pool.ProxyConnection$ClosedConnection.lambda$getClosedConnection$0(ProxyConnection.java:502)</span><br><span class="line">   at jdk.proxy3/jdk.proxy3.$Proxy173.prepareStatement(Unknown Source)</span><br><span class="line">   at com.zaxxer.hikari.pool.ProxyConnection.prepareStatement(ProxyConnection.java:327)</span><br><span class="line">   at com.zaxxer.hikari.pool.HikariProxyConnection.prepareStatement(HikariProxyConnection.java)</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
</code></pre>
<p>从上面有几个关键信息梳理下异常调用链：</p>
<img src="/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/error.jpg" class="">

<p>得出几个重要信息：</p>
<ol>
<li>异常发生的业务代码是在批量处理”xx报告”时，查询告警处</li>
<li>ShardingSphere下的连接池hikari抛出了异常Connection is closed</li>
<li>Druid连接池也抛出了异常{conn-xxx} discard</li>
<li>底层SocketTimeoutException，表明是客户端等待数据库服务器的响应超时（初步判断为慢sql）</li>
</ol>
<p>所以我开始从以下几个方面排查：</p>
<ol>
<li>查业务代码的变更，为什么之前好好的跑了一个多月，突然出问题。</li>
<li>检查数据库连接参数设置</li>
<li>评估查询的数据量是否过大</li>
<li>看下HikariCP和Druid是否有啥联系以及为啥会有两个连接池？</li>
<li>查看数据库负载情况</li>
</ol>
<h3 id="处理过程"><a href="#处理过程" class="headerlink" title="处理过程"></a>处理过程</h3><h4 id="第一步：摸索"><a href="#第一步：摸索" class="headerlink" title="第一步：摸索"></a>第一步：摸索</h4><p>怀疑一切，切忌先入为主。</p>
<ol>
<li>想办法重现问题<ol>
<li>提前发通知，下午7点以后会操作线上系统。通常6点半以后几乎就没人用系统了。</li>
<li>因为设计该功能时，留了补偿手动，可手动重新触发报告生成。</li>
<li>反复重试了几次，问题未复现。</li>
</ol>
</li>
<li>查看业务代码变更。<ol>
<li>报错处业务代码owner是我，没做任何更改，所以变成重点关注addAlertData方法，也就是与告警相关（重点在数据量）</li>
<li>业务没变更但是加入了<strong>ShardingSphere</strong>（异常中也有这块的信息，先存疑）</li>
</ol>
</li>
<li>检查系统连接池参数<ol>
<li>druid，几乎都没有做定制，都是使用的默认值。<ol>
<li>使用默认值其实存在风险，应该根据业务调整一些参数，因为买的阿里的pg所以咨询了他们拿到了一份他们暴露的参数调优参考，后续可针对性修改）</li>
</ol>
</li>
<li>新增的ShardingSphere的HikariCP也是使用的默认值。（异常中也有这块的信息，先存疑）</li>
</ol>
</li>
<li>观察显示的数据库负载情况（阿里云的监控看板、pg的pg_stat_activity等视图、数据库日志等）<ol>
<li>从视图发现确实存在执行时间较长的几条sqlsql，虽然有些慢但是不足以触发异常。慢的原因初步判断为数据量过大（报错的租户行数都在50w左右）</li>
<li>记录下这个sql，拿去控制台执行，EXPLAIN ANALYZE该sql，发现Seq Scan除了时间较长以外还存在索引问题，几乎每次查询都要用到的“告警状态”字段之前没加索引。（可能是原因之一）</li>
<li>查看数据库日志如下，这表明数据库和客户端的连接中断确实是问题的根源，可能是因为网络问题、数据库负载过高、或者连接超时等因素导致的。<ol>
<li><img src="/2024/09/17/%E9%81%87%E8%A7%81%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6/sql.png" class=""></li>
</ol>
</li>
</ol>
</li>
</ol>
<h4 id="第二步：验证"><a href="#第二步：验证" class="headerlink" title="第二步：验证"></a>第二步：验证</h4><p>验证怀疑的所有点，通常控制变量法进行验证。</p>
<p>因为暂时没有复现，不着急先按兵不动。</p>
<ol>
<li>前提是要有补偿方案，不能阻断线上使用，特别是这种核心业务。因为当时留了后门可以手动触发某个租户所以没问题。</li>
<li>虽然是线上故障同时也算严重bug，但是也不要着急，胡乱改一通，可能按下葫芦又起瓢，尽可能的找到根因，哪怕不能一次性修复。</li>
</ol>
<p>等待了两天发现同样的问题又发生了。</p>
<ol>
<li>但是这次发现了上一次遗漏的一个信息，报错的租户从日志看时间，异常都是在10s以后抛出的。（初步判断是SocketTimeout的超时时间，可能是10s）</li>
<li>拿到同样报错的sql去执行发现虽然跟之前没啥差别，问题还是那些问题，也没超过10s。（怀疑是因为报错时候执行了sql，触发了pg的缓存，所以再去查缓存生效，导致执行时间变短）</li>
</ol>
<p>验证第一个问题：</p>
<p>因为当前看存在有两个连接池，查HikariCP与Druid的源码：<br>      <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// HikariCP只有connectionTimeout为30s</span><br><span class="line">static &#123;</span><br><span class="line">    CONNECTION_TIMEOUT = TimeUnit.SECONDS.toMillis(30L);</span><br><span class="line">    VALIDATION_TIMEOUT = TimeUnit.SECONDS.toMillis(5L);</span><br><span class="line">    SOFT_TIMEOUT_FLOOR = Long.getLong(&quot;com.zaxxer.hikari.timeoutMs.floor&quot;, 250L);</span><br><span class="line">    IDLE_TIMEOUT = TimeUnit.MINUTES.toMillis(10L);</span><br><span class="line">    MAX_LIFETIME = TimeUnit.MINUTES.toMillis(30L);</span><br><span class="line">    unitTest = false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// DruidDataSource初始化，socketTimeout是10s</span><br><span class="line">public void init() throws SQLException &#123;</span><br><span class="line">    if (!this.inited) &#123;</span><br><span class="line">        DruidDriver.getInstance();</span><br><span class="line">        ReentrantLock lock = this.lock;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            lock.lockInterruptibly();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            throw new SQLException(&quot;interrupt&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        boolean init = false;</span><br><span class="line">  </span><br><span class="line">      if (this.connectTimeout == 0) &#123;</span><br><span class="line">        this.connectTimeout = 10000;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (this.socketTimeout == 0) &#123;</span><br><span class="line">          this.socketTimeout = 10000;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></p>
<p>先不管HikariCP，至少能确定Druid的10s超时确实存在，因为阿里云上我开起了pg的慢sql监控，根据时间刚好查到了确实存在一条告警sql查询执行时间为10s+。</p>
<ol>
<li>所以初步判断SocketTimeoutException是因为sql执行时间超过了连接池的默认超时。</li>
<li>去查了下该租户下告警的数据总数已经超过了50W，在活5000左右。</li>
</ol>
<h4 id="第三步：修复方案"><a href="#第三步：修复方案" class="headerlink" title="第三步：修复方案"></a>第三步：修复方案</h4><p>方案如下：</p>
<ol>
<li>加索引，对常用的字段“告警状态”添加索引。</li>
<li>对在活告警查询的地方分批</li>
<li>对在活主告警限制查询的条数而不是查所有。</li>
</ol>
<h4 id="第四步：方案执行"><a href="#第四步：方案执行" class="headerlink" title="第四步：方案执行"></a>第四步：方案执行</h4><ol>
<li><p>对所有配置分表的表，检查索引，添加必要的索引。</p>
<ol>
<li><pre><code>  -- ========================================
  -- 描述: 创建告警表的“status”字段索引
  -- 文件名: 001_create_alert_status_index.sql
  -- 作者: hht
  -- 创建日期: 2024-10-31
  -- ========================================

  DO $$
  DECLARE
      i INTEGER;
  BEGIN
      -- 遍历 tb_xx_alert_0 ~ tb_xx_alert_15
      FOR i IN 0..15 LOOP
          -- 动态生成 ALTER TABLE 语句，添加字段
          EXECUTE FORMAT(&#39;
              ALTER TABLE public.tb_xx_alert_%s 
              CREATE INDEX tb_xx_alert_%s_status_index ON tb_xx_alert_%s  (status);
          &#39;, i);
      END LOOP;
  END $$;
</code></pre>
</li>
</ol>
</li>
<li><p>告警分批且限制条数</p>
<ol>
<li><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;AlertVO&gt; findSubscribedAlerts(AlertSubscribedParam param) &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    List&lt;List&lt;String&gt;&gt; parts = PartsListUtil.getParts(param.getSubscribedCiIds(), BATCH_SIZE);</span><br><span class="line">    List&lt;AlertVO&gt; all = new ArrayList&lt;&gt;();</span><br><span class="line">    for (List&lt;String&gt; part : parts) &#123;</span><br><span class="line">      // 分批查询</span><br><span class="line">      param.setSubscribedCiIds(part);</span><br><span class="line">      // 主告警不超过100条</span><br><span class="line">      Page&lt;AlertVO&gt; page = new Page&lt;&gt;(1, 100 - all.size());</span><br><span class="line">      IPage&lt;AlertVO&gt; result = tbXxAlertMapper.findSubscribedAlerts(page, param);</span><br><span class="line">      if (result.getTotal() == 0) &#123;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">      // 聚合告警的子告警数据补充</span><br><span class="line">      getAlertAggChildren(param.getIdentityId(), result.getRecords());</span><br><span class="line">      all.addAll(result.getRecords());</span><br><span class="line">      // 如果已经达到100，退出循环</span><br><span class="line">      if (all.size() == 100) &#123;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 最后统一按createTime降序排序</span><br><span class="line">    all.sort((a1, a2) -&gt; Long.compare(a2.getCreateTime(), a1.getCreateTime()));</span><br><span class="line">    return all;</span><br><span class="line">  &#125; catch (Exception e) &#123;</span><br><span class="line">    String errorMessage =</span><br><span class="line">        String.format(&quot;查询关注告警失败: identityId=%s, deal=%s&quot;, param.getIdentityId(), param.isDeal());</span><br><span class="line">    log.error(errorMessage, param.getIdentityId(), e);</span><br><span class="line">    throw new SafetyNoticeException(errorMessage, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">       </span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h4 id="第五步：监控效果"><a href="#第五步：监控效果" class="headerlink" title="第五步：监控效果"></a>第五步：监控效果</h4><ol>
<li>上线后，连续一周到点蹲守<ol>
<li>SELECT pg_stat_reset();  – 重置所有统计信息</li>
<li>数据库负载看板以及pg的pg_stat_activity。<ol>
<li>之前的sql执行时间没有再超过2s</li>
<li>看板上慢sql也没有在发现</li>
<li>数据库日志也没有再出现异常</li>
</ol>
</li>
<li>pg_stat_user_indexes+EXPLAIN ANALYZE 对应sql，查看索引使用情况。</li>
</ol>
</li>
<li>业务功能正常。</li>
</ol>
<p>看上去目前超时的问题暂时解决，但是要想更彻底的解，还需要后续对遗留项逐个解决。</p>
<h3 id="遗留项-x2F-改进项"><a href="#遗留项-x2F-改进项" class="headerlink" title="遗留项&#x2F;改进项"></a>遗留项&#x2F;改进项</h3><ol>
<li>连接池的参数调优，虽然默认的看上去没啥问题，但是迟早肯定会出问题，记一个DFX。</li>
<li>多了一个HikariCP连接池，而且通过jconsole看了下，两个连接池都会初始化，这块是否有必要有两个连接池，这儿存在隐患，对ShardingSphere需要深入了解下，记一个DFX。</li>
<li>历史数据的清理，跟PO提出，需要加一个需求不仅仅是告警，可能还有其他数据。</li>
<li>对于核心且经常更新的表是否需要定时REINDEX</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.gamehu.run/2024/08/18/%E5%89%8D%E7%BD%AE%E6%A3%80%E6%9F%A5%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/IMG_4038.jpeg">
      <meta itemprop="name" content="Gamehu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="10年经验Java开发者，精通React，熟悉Python、Docker、Vue及Go">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 正儿八经 - 资深Java/React工程师">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/08/18/%E5%89%8D%E7%BD%AE%E6%A3%80%E6%9F%A5%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">前置检查脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-08-18 22:19:13" itemprop="dateCreated datePublished" datetime="2024-08-18T22:19:13+08:00">2024-08-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div class="tag-container">
  <span class="main-tag">离职系列</span>
  <span class="sub-tag">第八篇</span>
</div>
<div class="article-quote">
离职系列，想想这几年在公司的成长，在这做个记录。
</div>

<p>此篇是因为遇到了太多环境类问题，从LMT建立的数据统计，这类问题占比已经超过了我处理问题的60%左右，占所有现场问题的20%左右以上，所以抽了个时间把可以在前置检查中避免的问题都梳理出来，试着写了个脚本，并一次次到现场验证，最终有了以下版本。该脚本在产品没有出根解之前，直接交给了TAC，让其与一线一起前置处理，避免过多的流转到LMT。</p>
<h2 id="检查脚本，"><a href="#检查脚本，" class="headerlink" title="检查脚本，"></a>检查脚本，</h2><pre><code>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 环境前置检查脚本（用于提前感知问题，减少安装失败、升级失败等问题出现）</span><br><span class="line"># by hht</span><br><span class="line"># 上传后，chmod +x 授予执行权限，然后./pre_check.sh 直接执行</span><br><span class="line"></span><br><span class="line"># 输出错误到文件</span><br><span class="line">exec 2&gt;/tmp/pre_test_error.log</span><br><span class="line"># ANSI颜色代码</span><br><span class="line">GREEN=&#x27;\033[0;32m&#x27;</span><br><span class="line">RED=&#x27;\033[0;31m&#x27;</span><br><span class="line">NC=&#x27;\033[0m&#x27; # 恢复默认颜色</span><br><span class="line">YELLOW=&#x27;\033[0;33m&#x27;</span><br><span class="line">YELLOW_BG=&#x27;\033[43m&#x27;</span><br><span class="line">BLACK=&#x27;\033[30m&#x27; # 黑色字体</span><br><span class="line">none=&#x27;\e[0m&#x27;</span><br><span class="line">BLUE=&quot;\e[0;94m&quot;</span><br><span class="line">_red_bg() &#123; echo -e &quot;\e[41m$@$&#123;none&#125;&quot;; &#125;</span><br><span class="line">is_err=$(_red_bg 异常!)</span><br><span class="line"></span><br><span class="line">warn() &#123;</span><br><span class="line">      echo -e &quot;\n$&#123;YELLOW_BG&#125;$&#123;BLACK&#125;警告!$&#123;NC&#125; $@\n&quot;</span><br><span class="line">&#125;</span><br><span class="line">err() &#123;</span><br><span class="line">    echo -e &quot;\n$@ $is_err\n&quot; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 函数来检验IP地址的有效性</span><br><span class="line">is_valid_ip() &#123;</span><br><span class="line">  local ip=&quot;$1&quot;</span><br><span class="line">  local ip_regex=&quot;^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$&quot;</span><br><span class="line"></span><br><span class="line">  if [[ $ip =~ $ip_regex ]]; then</span><br><span class="line">    return 0</span><br><span class="line">  else</span><br><span class="line">    return 1</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 声明账号</span><br><span class="line">server1_user=&quot;root&quot;</span><br><span class="line">server2_user=&quot;root&quot;</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n$&#123;GREEN&#125;------------------------------------前置检查------------------------------------$&#123;NC&#125;&quot;</span><br><span class="line">echo</span><br><span class="line"># 输入服务器IP地址，进行校验</span><br><span class="line">while true; do</span><br><span class="line">  echo &quot;请输入master服务器的IP地址：&quot;</span><br><span class="line">  read server1_ip</span><br><span class="line"></span><br><span class="line">  if is_valid_ip &quot;$server1_ip&quot;; then</span><br><span class="line">    break</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无效的IP地址，请重新输入。&quot;</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">while true; do</span><br><span class="line">  echo &quot;请输入worker服务器的IP地址：&quot;</span><br><span class="line">  read server2_ip</span><br><span class="line">  if is_valid_ip &quot;$server2_ip&quot;; then</span><br><span class="line">    break</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无效的IP地址，请重新输入。&quot;</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"># 测试Ping</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;ping测试:$&#123;NC&#125;\n&quot;</span><br><span class="line">ping_check()&#123;</span><br><span class="line">  local server1_ip=$1</span><br><span class="line">  local server2_ip=$2</span><br><span class="line">  ping -c 3 $server1_ip &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    echo -e &quot;$server1_ip 可以Ping通。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    err &quot;$server1_ip 无法Ping通。&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  ping -c 3 $server2_ip &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    echo -e &quot;$server2_ip 可以Ping通。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    err &quot;$server2_ip 无法Ping通。&quot; &amp;&amp; exit 1</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ping_check $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># SSH测试</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;SSH测试:$&#123;NC&#125;\n&quot;</span><br><span class="line">ssh_check()&#123;</span><br><span class="line">  local server1_ip=$1</span><br><span class="line">  local server2_ip=$2</span><br><span class="line">  if sshpass timeout 10s ssh -o StrictHostKeyChecking=no root@$server1_ip echo &quot;SSH test&quot;  2&gt;/dev/null; then</span><br><span class="line">    echo -e &quot;Success: SSH from $server1_ip to $server2_ip connected.$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else </span><br><span class="line">    err &quot;SSH from $server1_ip to $server2_ip failed&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ssh_check $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># 时间一致性检查</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;时间一致性检查:$&#123;NC&#125;\n&quot;</span><br><span class="line">date_check()&#123;</span><br><span class="line">  local server1_ip=$1</span><br><span class="line">  local server2_ip=$2</span><br><span class="line">  # 时间一致性检查</span><br><span class="line">  server1_time=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$server1_ip date +%s)</span><br><span class="line">  server2_time=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$server2_ip date +%s)</span><br><span class="line"></span><br><span class="line">  if [ $server1_time -eq $server2_time ]; then</span><br><span class="line">    echo -e &quot;两台服务器的时间完全一致。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">  # 使用 date 命令将时间戳转换为日期和时间</span><br><span class="line">    formatted1_time=$(date -d &quot;@$server1_time&quot;)</span><br><span class="line">    formatted2_time=$(date -d &quot;@$server2_time&quot;)</span><br><span class="line">    err &quot;两台服务器的时间不一致。&quot;</span><br><span class="line">    echo -e &quot;$&#123;server1_ip&#125;时间为：$&#123;formatted1_time&#125;&quot;</span><br><span class="line">    echo -e &quot;$&#123;server2_ip&#125;时间为：$&#123;formatted2_time&#125;&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">date_check $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"></span><br><span class="line"># 添加检查防火墙是否开启</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;检查防火墙:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_firewall_status() &#123;</span><br><span class="line">  local server_ip=$1</span><br><span class="line"></span><br><span class="line">  # 使用 ssh 连接到服务器并查看 firewalld 服务的状态</span><br><span class="line">  firewall_status=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null &quot;root@$server_ip&quot; &quot;systemctl is-active firewalld&quot;)</span><br><span class="line">  </span><br><span class="line">  if [ &quot;$firewall_status&quot; = &quot;active&quot; ]; then</span><br><span class="line">    warn &quot;$server_ip 防火墙已开启。请根据http://172.17.160.32:18090/x/cYA0CQ检查端口&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;$server_ip 防火墙未开启。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用这个函数并传入服务器 IP 和用户名</span><br><span class="line">check_firewall_status $server1_ip</span><br><span class="line">check_firewall_status $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"></span><br><span class="line"># DNS配置检查</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;DNS检查:$&#123;NC&#125;\n&quot;</span><br><span class="line">dns_check()&#123;</span><br><span class="line">  local server1_user=$1</span><br><span class="line">  local server2_user=$1</span><br><span class="line">  local server1_ip=$2</span><br><span class="line">  local server2_ip=$3</span><br><span class="line">  # DNS配置检查 - 验证是否一致</span><br><span class="line">  server1_dns=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server1_user@$server1_ip cat /etc/resolv.conf)</span><br><span class="line">  server2_dns=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server2_user@$server2_ip cat /etc/resolv.conf)</span><br><span class="line"></span><br><span class="line">  if [ &quot;$server1_dns&quot; == &quot;$server2_dns&quot; ]; then</span><br><span class="line">    echo -e &quot;两台服务器的DNS配置一致。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    warn  &quot;两台服务器的DNS配置不一致。请判断是否影响集群。&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # DNS配置检查 - 验证是否存在多行nameserver记录</span><br><span class="line">  server1_nameserver_count=$(echo &quot;$server1_dns&quot; | grep -c &#x27;^nameserver&#x27;)</span><br><span class="line">  server2_nameserver_count=$(echo &quot;$server2_dns&quot; | grep -c &#x27;^nameserver&#x27;)</span><br><span class="line"></span><br><span class="line">  if [ $server1_nameserver_count -eq 1 ] &amp;&amp; [ $server2_nameserver_count -eq 1 ]; then</span><br><span class="line">    echo -e &quot;两台服务器的DNS配置中只存在一行nameserver记录。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    if [ $server1_nameserver_count -ne 1 ]; then</span><br><span class="line">      warn  &quot;第一台服务器($server1_ip)的DNS配置存在多行nameserver记录。请判断是否影响集群。&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ $server2_nameserver_count -ne 1 ]; then</span><br><span class="line">      warn  &quot;第二台服务器($server2_ip)的DNS配置存在多行nameserver记录。请判断是否影响集群。&quot;</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dns_check $server1_user $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># 挂载检查</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;数据盘挂载检查:$&#123;NC&#125;\n&quot;</span><br><span class="line">mount_check()&#123;</span><br><span class="line">  local server1_user=$1</span><br><span class="line">  local server2_user=$1</span><br><span class="line">  local server1_ip=$2</span><br><span class="line">  local server2_ip=$3</span><br><span class="line">  server1_mount=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server1_user@$server1_ip mount | grep /opt/local-path-provisioner)</span><br><span class="line">  server2_mount=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server2_user@$server2_ip mount | grep /opt/local-path-provisioner)</span><br><span class="line"></span><br><span class="line">  if [ -n &quot;$server1_mount&quot; ] &amp;&amp; [ -n &quot;$server2_mount&quot; ]; then</span><br><span class="line">    echo -e &quot;两台服务器都正确挂载了/opt/local-path-provisioner目录。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">  #   echo -e &quot;两台服务器中有一台或两台未正确挂载/opt/local-path-provisioner目录。$&#123;RED&#125;异常$&#123;NC&#125;&quot;</span><br><span class="line">    if [ -z &quot;$server1_mount&quot; ]; then</span><br><span class="line">      err &quot;第一台服务器($server1_ip)未正确挂载/opt/local-path-provisioner目录。&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$server2_mount&quot; ]; then</span><br><span class="line">      err &quot;第二台服务器($server2_ip)未正确挂载/opt/local-path-provisioner目录。&quot;</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mount_check $server1_user $server1_ip $server2_ip</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># 使用Telnet检查SFTP服务是否联通</span><br><span class="line"># check_sftp() &#123;</span><br><span class="line">#   local server_ip=$1</span><br><span class="line">#   echo -e &quot;\n-----------使用Telnet检查SFTP服务是否联通-------------&quot;</span><br><span class="line"># #   # 使用Telnet连接到SSH端口（默认是22）</span><br><span class="line"># #   # 尝试连接SFTP服务器</span><br><span class="line"># #   sftp -oPort=22 $server_ip &lt;&lt;EOF 2&gt;/dev/null</span><br><span class="line"># #   quit</span><br><span class="line"># # EOF</span><br><span class="line"></span><br><span class="line"># #   # Check the exit status of the SFTP command</span><br><span class="line"># #   if [ $? -eq 0 ]; then</span><br><span class="line"># #     echo &quot;SFTP on $IP is working normally&quot;</span><br><span class="line"># #   else</span><br><span class="line"># #     echo &quot;SFTP on $IP is not working!&quot;</span><br><span class="line"># #   fi</span><br><span class="line"></span><br><span class="line">#   # 使用SSH命令测试SFTP服务</span><br><span class="line">#   ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null sftpuser@$server_ip sftp exit &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">#   # 检查SSH命令的退出状态码</span><br><span class="line">#   if [ $? -eq 0 ]; then</span><br><span class="line">#     echo &quot;SFTP服务正常，可以连接到主机 $server_ip 的SFTP服务。&quot;</span><br><span class="line">#   else</span><br><span class="line">#     err &quot;SFTP服务异常，无法连接到主机 $server_ip 的SFTP服务。&quot;</span><br><span class="line">#   fi</span><br><span class="line"># &#125;</span><br><span class="line"># # 调用函数来进行Telnet检查</span><br><span class="line"># check_sftp $server_ip</span><br><span class="line"></span><br><span class="line"># 检查master SSH服务状态和配置</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;master SSH服务状态和配置检查:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_sshd_config() &#123;</span><br><span class="line"></span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local server_user=$2</span><br><span class="line"></span><br><span class="line">  # 使用 ssh 连接到服务器并执行命令检查SSH服务状态</span><br><span class="line">  ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;systemctl is-active sshd&quot; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    # 获取SSH配置文件内容</span><br><span class="line">    sshd_config_content=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;cat /etc/ssh/sshd_config&quot;)</span><br><span class="line"></span><br><span class="line">    # 检查配置文件内容是否包含指定的三行数据</span><br><span class="line">    if echo &quot;$sshd_config_content&quot; | grep -q -E &quot;Subsystem\s+sftp\s+internal-sftp&quot; &amp;&amp; echo &quot;$sshd_config_content&quot; | grep -q &quot;Match User sftpuser&quot; &amp;&amp; echo &quot;$sshd_config_content&quot; | grep -q &quot;ChrootDirectory /opt/ftpfile/sftp/sftpuser/&quot;; then</span><br><span class="line">      echo -e &quot;SSH配置正常。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">      warn &quot;请检查sshd_config文件，是否正确配置sftp。&quot;</span><br><span class="line">    fi</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无法连接服务器或检查SSH服务状态。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用函数执行检查</span><br><span class="line">check_sshd_config $server1_ip $server1_user</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># sftp_with_password() &#123;</span><br><span class="line">#   echo -e &quot;\n-----------检查master的sftp连通性-------------&quot;</span><br><span class="line">#   local server_ip=$1</span><br><span class="line">#   local server_password=$2</span><br><span class="line"></span><br><span class="line">#   # 使用 expect 来自动输入密码</span><br><span class="line">#   expect -c &quot;</span><br><span class="line">#     spawn sftp -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null sftpuser@$server_ip</span><br><span class="line">#     expect &#123;</span><br><span class="line">#       \&quot;password:\&quot; &#123;</span><br><span class="line">#         send \&quot;$server_password\n\&quot;</span><br><span class="line">#         exp_continue</span><br><span class="line">#       &#125;</span><br><span class="line">#       eof</span><br><span class="line">#     &#125;</span><br><span class="line">#   &quot;</span><br><span class="line">  </span><br><span class="line">#   if [ $? -eq 0 ]; then</span><br><span class="line">#     echo -e &quot;$server_ip SFTP连接成功。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">#   else</span><br><span class="line">#     warn &quot;无法连接$server_ip 的SFTP服务。&quot;</span><br><span class="line">#   fi</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># # 调用函数来进行SFTP连接检查</span><br><span class="line"># sftp_with_password $server1_ip &quot;FYktvR1w2upoOb&quot;</span><br><span class="line"></span><br><span class="line"># 检查目录权限是否为777</span><br><span class="line"># check_directory_permission() &#123;</span><br><span class="line">#   local server_ip=$1</span><br><span class="line">#   local directory_path=$2</span><br><span class="line">#   echo -e &quot;\n-----------检查master的目录$&#123;directory_path&#125;权限-------------&quot;</span><br><span class="line"></span><br><span class="line">#   # 使用 ssh 连接到服务器并执行 stat 命令获取目录权限信息</span><br><span class="line">#   ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null sftpuser@$server_ip &quot;stat -c %a $directory_path&quot; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">#   if [ $? -eq 0 ]; then</span><br><span class="line">#     # 获取目录权限</span><br><span class="line">#     directory_permission=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null sftpuser@$server_ip &quot;stat -c %a $directory_path&quot;)</span><br><span class="line">    </span><br><span class="line">#     if [ &quot;$directory_permission&quot; -eq 777 ]; then</span><br><span class="line">#       echo -e &quot;$directory_path 目录权限为777。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">#     else</span><br><span class="line">#       warn &quot;$directory_path 目录权限不是777。&quot;</span><br><span class="line">#     fi</span><br><span class="line">#   else</span><br><span class="line">#     warn &quot;无法连接$server_ip 服务器或获取目录权限。&quot;</span><br><span class="line">#   fi</span><br><span class="line"># &#125;</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;检查master的sftp目录权限:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_user() &#123;</span><br><span class="line">  ssh $1 &quot;id $2 &gt;/dev/null 2&gt;&amp;1&quot; </span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    echo -e &quot;$2用户在$1上存在。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else  </span><br><span class="line">    err &quot;$2用户在$1上不存在&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_dir_perm() &#123;</span><br><span class="line">  ssh $1 &quot;if [ \`stat -c %a $2\` -eq $3 ]; then echo -e &#x27;$2目录为$3权限。$&#123;GREEN&#125;正常$&#123;NC&#125;&#x27;; else err &#x27;$2目录不为$3权限&#x27;; fi&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用函数来检查服务器的目录权限</span><br><span class="line">check_user $server1_ip &quot;sftpuser&quot;</span><br><span class="line"></span><br><span class="line">check_dir_perm $server1_ip &quot;/opt&quot; 755</span><br><span class="line"></span><br><span class="line">check_dir_perm $server1_ip &quot;/opt/ftpfile/sftp/sftpuser&quot; 755</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"># check_directory_permission $server1_ip &quot;/opt&quot;</span><br><span class="line"># check_directory_permission $server1_ip &quot;/opt/ftpfile/sftp/sftpuser&quot;</span><br><span class="line"></span><br><span class="line"># 检查主机名与/etc/hosts文件的一致性</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;检查主机名的一致性:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_hostname_and_hosts() &#123;</span><br><span class="line"></span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local server_user=$2</span><br><span class="line">  # 使用 ssh 连接到服务器并获取主机名</span><br><span class="line">  server_hostname=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;hostname&quot;)</span><br><span class="line"></span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    # 获取 /etc/hosts 文件内容</span><br><span class="line">    hosts_file_content=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;cat /etc/hosts&quot;)</span><br><span class="line"></span><br><span class="line">    # 检查主机名与 /etc/hosts 内是否一致</span><br><span class="line">    if echo &quot;$hosts_file_content&quot; | grep -q -E &quot;^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\s+$server_hostname\s*$&quot;; then</span><br><span class="line">      echo -e &quot;$server_ip 主机名与/etc/hosts文件一致。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">      warn &quot;$server_ip 主机名与/etc/hosts文件不一致。&quot;</span><br><span class="line">    fi</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无法连接$server_ip 服务器或获取主机名。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 检查主机名与Kubernetes节点名是否一致</span><br><span class="line">check_hostname_and_k8s_node() &#123;</span><br><span class="line"></span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local server_user=$2</span><br><span class="line">  local num=$3</span><br><span class="line">  # 使用 ssh 连接到服务器并获取Kubernetes节点名</span><br><span class="line">  k8s_node_name=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;kubectl get node -o jsonpath=&#x27;&#123;.items[$num].metadata.name&#125;&#x27;&quot;)</span><br><span class="line"></span><br><span class="line">  if [ $? -eq 0 ]; then</span><br><span class="line">    # 获取主机名</span><br><span class="line">    server_hostname=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;hostname&quot;)</span><br><span class="line"></span><br><span class="line">    # 检查主机名与Kubernetes节点名是否一致</span><br><span class="line">    if [ &quot;$server_hostname&quot; = &quot;$k8s_node_name&quot; ]; then</span><br><span class="line">      echo -e &quot;$server_ip 主机名与Kubernetes节点名一致。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">    else</span><br><span class="line">      warn &quot;$server_ip 主机名与Kubernetes节点名不一致。&quot;</span><br><span class="line">    fi</span><br><span class="line">  else</span><br><span class="line">    warn &quot;无法连接$server_ip 服务器或获取Kubernetes节点名。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用函数来检查服务器的主机名与/etc/hosts文件一致性</span><br><span class="line">check_hostname_and_hosts $server1_ip $server1_user</span><br><span class="line">check_hostname_and_hosts $server2_ip $server2_user</span><br><span class="line"></span><br><span class="line"># 调用函数来检查服务器的主机名与Kubernetes节点名一致性</span><br><span class="line">check_hostname_and_k8s_node $server1_ip $server1_user 0</span><br><span class="line">check_hostname_and_k8s_node $server2_ip $server2_user 1</span><br><span class="line">echo -e &quot;\n------------------------------------------------------------------------------&quot;</span><br><span class="line"></span><br><span class="line"># 磁盘写入速度测试（带缓存）</span><br><span class="line"># disk_speed_test() &#123;</span><br><span class="line">#   # local server_ip=$1</span><br><span class="line">#   # local server_user=$2</span><br><span class="line">#   # local test_file=&quot;/tmp/disk_speed_test_file&quot;</span><br><span class="line">#   # # 进行写入测试</span><br><span class="line">#   # write_speed=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;dd if=/dev/zero of=$&#123;test_file&#125; bs=8k count=128 conv=fsync oflag=direct&quot; 2&gt;&amp;1 | tail -n 1)</span><br><span class="line">#   # echo -e &quot;$&#123;server_ip&#125; 写入速度: $write_speed&quot;</span><br><span class="line">#   # # 进行读取测试</span><br><span class="line">#   # read_speed=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;sudo dd if=$&#123;test_file&#125; of=/dev/null bs=8k count=128 conv=fsync iflag=direct&quot; 2&gt;&amp;1 | tail -n 1)</span><br><span class="line">#   # echo -e &quot;$&#123;server_ip&#125; 读取速度: $read_speed&quot;</span><br><span class="line"></span><br><span class="line">#   # # 删除测试文件</span><br><span class="line">#   # ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;rm $test_file&quot;</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># 测试磁盘读速度的函数</span><br><span class="line">disk_speed_test() &#123;</span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local test_duration=30  # 测试持续时间（秒）</span><br><span class="line"></span><br><span class="line">  echo &quot;开始测试 $server_ip 过程会持续30s...&quot;</span><br><span class="line"></span><br><span class="line">  local time0=$(date &quot;+%s&quot;)</span><br><span class="line">  cat /dev/null &gt; disk_res</span><br><span class="line"></span><br><span class="line">  while ((($(date &quot;+%s&quot;) - time0) &lt;= test_duration)); do</span><br><span class="line">    disk_info=$(ssh &quot;$server_ip&quot; &#x27;dd if=/dev/zero of=output.file bs=8k count=128 conv=fsync 2&gt;&amp;1 1&gt;/dev/null&#x27;)</span><br><span class="line">    io_res=$(echo &quot;$disk_info&quot; | grep --only-matching -E &#x27;[0-9.]+ ([MGk]?B|bytes)/[s(ec)?|秒]&#x27;)</span><br><span class="line">    echo &quot;$io_res&quot; &gt;&gt; disk_res</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">  local count=$(cat disk_res | wc -l)</span><br><span class="line">  local sum=$(cat disk_res | xargs -n2 | awk &#x27;&#123; if ($2 == &quot;kB/秒&quot; || $2 == &quot;kB/s&quot;) a+=($1/1024); else a+=$1 &#125; END&#123;printf(&quot;%.2f&quot;, a)&#125;&#x27;)</span><br><span class="line">  local average_speed=$(awk &#x27;BEGIN&#123;printf &quot;%.2f\n&quot;, &#x27;$sum&#x27;/&#x27;$count&#x27;&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">  echo -e &quot;平均速度 $server_ip: $&#123;RED&#125;$average_speed MB/s$&#123;NC&#125;。推荐值：$&#123;GREEN&#125;&gt;=200m/s$&#123;NC&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 磁盘写入速度测试（不带缓存）</span><br><span class="line"></span><br><span class="line"># disk_speed_test_no_cache() &#123;</span><br><span class="line">  # local server_ip=$1</span><br><span class="line">  # local server_user=$2</span><br><span class="line">  # local test_file=&quot;/tmp/disk_speed_test_file&quot;</span><br><span class="line">  # # 禁用磁盘缓存</span><br><span class="line">  # ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;hdparm -W0 /dev/mapper/centos-root&quot; 2&gt;/dev/null</span><br><span class="line">  # # 进行写入测试</span><br><span class="line">  # write_speed=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;dd if=/dev/zero of=$&#123;test_file&#125; bs=8k count=128 conv=fsync oflag=direct&quot; 2&gt;&amp;1 | tail -n 1)</span><br><span class="line">  # echo -e &quot;$&#123;server_ip&#125; 写入速度: $write_speed&quot;</span><br><span class="line">  # # 进行读取测试</span><br><span class="line">  # read_speed=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;sudo dd if=$&#123;test_file&#125; of=/dev/null bs=8k count=128 conv=fsync iflag=direct&quot; 2&gt;&amp;1 | tail -n 1)</span><br><span class="line">  # echo -e &quot;$&#123;server_ip&#125; 读取速度: $read_speed&quot;</span><br><span class="line"></span><br><span class="line">  # # 删除测试文件</span><br><span class="line">  # ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;rm $test_file&quot;</span><br><span class="line">  # # 启用磁盘缓存</span><br><span class="line">  # ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $server_user@$server_ip &quot;hdparm -W1 /dev/mapper/centos-root&quot; 2&gt;/dev/null</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># 测试磁盘写入速度的函数</span><br><span class="line">disk_speed_test_no_cache() &#123;</span><br><span class="line">  local server_ip=&quot;$1&quot;</span><br><span class="line">  local test_duration=30  # 测试持续时间（秒）</span><br><span class="line"></span><br><span class="line">  echo &quot;开始测试 $server_ip 过程会持续30s...&quot;</span><br><span class="line"></span><br><span class="line">  local time0=$(date &quot;+%s&quot;)</span><br><span class="line">  cat /dev/null &gt; disk_res</span><br><span class="line"></span><br><span class="line">  while ((($(date &quot;+%s&quot;) - time0) &lt;= test_duration)); do</span><br><span class="line">    disk_info=$(ssh &quot;$server_ip&quot; &#x27;dd if=/dev/zero of=output.file bs=8k count=128 oflag=direct,nonblock conv=fsync 2&gt;&amp;1 1&gt;/dev/null&#x27;)</span><br><span class="line">    io_res=$(echo &quot;$disk_info&quot; | grep --only-matching -E &#x27;[0-9.]+ ([MGk]?B|bytes)/[s(ec)?|秒]&#x27;)</span><br><span class="line">    echo &quot;$io_res&quot; &gt;&gt; disk_res</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">  local count=$(cat disk_res | wc -l)</span><br><span class="line">  local sum=$(cat disk_res | xargs -n2 | awk &#x27;&#123; if ($2 == &quot;kB/秒&quot; || $2 == &quot;kB/s&quot;) a+=($1/1024); else a+=$1 &#125; END&#123;printf(&quot;%.2f&quot;, a)&#125;&#x27;)</span><br><span class="line">  local average_speed=$(awk &#x27;BEGIN&#123;printf &quot;%.2f\n&quot;, &#x27;$sum&#x27;/&#x27;$count&#x27;&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">  echo -e &quot;平均速度 $server_ip: $&#123;RED&#125; $average_speed MB/s $&#123;NC&#125;。推荐值：$&#123;GREEN&#125;&gt;=50m/s$&#123;NC&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 检查 CPU 是否支持 AVX</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;检查 CPU 是否支持 AVX:$&#123;NC&#125;\n&quot;</span><br><span class="line">check_avx_support() &#123;</span><br><span class="line">  local server_ip=$1</span><br><span class="line">  local avx_check=$(ssh -q -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$server_ip &quot;grep -o &#x27;avx&#x27; /proc/cpuinfo&quot;)</span><br><span class="line"></span><br><span class="line">  if [ -n &quot;$avx_check&quot; ]; then</span><br><span class="line">    echo -e &quot;$server_ip CPU 支持 AVX (Advanced Vector Extensions)。$&#123;GREEN&#125;正常$&#123;NC&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    warn &quot;$server_ip CPU 不支持 AVX (Advanced Vector Extensions)。&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 调用函数来检查 AVX 支持</span><br><span class="line">check_avx_support  $server1_ip</span><br><span class="line">check_avx_support  $server2_ip</span><br><span class="line"></span><br><span class="line"># 定义要加载镜像的目录列表</span><br><span class="line">load_images() &#123;</span><br><span class="line">  image_directories=(&quot;/opt/xx/images/product/insight&quot; &quot;/opt/xx/images/product/insight/patch&quot;)</span><br><span class="line"></span><br><span class="line">  # 遍历目录并加载镜像</span><br><span class="line">  for directory in &quot;$&#123;image_directories[@]&#125;&quot;; do</span><br><span class="line">    if [ -d &quot;$directory&quot; ]; then</span><br><span class="line">      cd &quot;$directory&quot;</span><br><span class="line">      echo &quot;进入目录: $directory&quot;</span><br><span class="line">      for file in $(ls . | grep .tgz); do</span><br><span class="line">        echo &quot;加载镜像: $file&quot;</span><br><span class="line">        docker load &lt; &quot;$file&quot;</span><br><span class="line">      done</span><br><span class="line">    else</span><br><span class="line">      echo &quot;目录 $directory 不存在。&quot;</span><br><span class="line">    fi</span><br><span class="line">  done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 检查磁盘性能</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;磁盘测试:$&#123;NC&#125;\n&quot;</span><br><span class="line"># read -p &quot;是否要检查磁盘？ (y/n): &quot; confirm</span><br><span class="line">echo &quot;是否要检查磁盘？ (y/n)：&quot;</span><br><span class="line">read confirm</span><br><span class="line">if [ &quot;$confirm&quot; = &quot;y&quot; ]; then</span><br><span class="line">  echo -e &quot;\n$&#123;BLUE&#125;磁盘写入速度测试（不带缓存）:$&#123;NC&#125;\n&quot;</span><br><span class="line">  disk_speed_test_no_cache $server1_ip</span><br><span class="line">  disk_speed_test_no_cache $server2_ip</span><br><span class="line">  echo -e &quot;\n$&#123;BLUE&#125;磁盘写入速度测试（带缓存）:$&#123;NC&#125;\n&quot;</span><br><span class="line">  disk_speed_test $server1_ip </span><br><span class="line">  disk_speed_test $server2_ip</span><br><span class="line">else</span><br><span class="line">  echo &quot;取消磁盘检查。&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 镜像丢的时候使用</span><br><span class="line">echo -e &quot;\n$&#123;BLUE&#125;镜像加载:$&#123;NC&#125;\n&quot;</span><br><span class="line">echo &quot;是否要加载 Docker 镜像？ (y/n)：&quot;</span><br><span class="line">read confirm</span><br><span class="line"># read -p &quot;是否要加载 Docker 镜像？ (y/n): &quot; confirm</span><br><span class="line">if [ &quot;$confirm&quot; = &quot;y&quot; ]; then</span><br><span class="line">  load_images</span><br><span class="line">else</span><br><span class="line">  echo &quot;取消加载 Docker 镜像。&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       </span><br></pre></td></tr></table></figure>
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gamehu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script>
  <script>
      pbOptions = {};
        pbOptions.iconStyle = "box";
        pbOptions.boxForm = "horizontal";
        pbOptions.position = "bottomCenter";
        pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      new needShareButton('#needsharebutton-postbottom', pbOptions);
  </script>
</body>
</html>
